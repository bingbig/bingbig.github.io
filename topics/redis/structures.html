<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>数据结构和对象 | Bing</title>
    <meta name="description" content="文档空间">
    <link rel="icon" href="https://avatars.githubusercontent.com/bingbig">
    
    <link rel="preload" href="/assets/css/0.styles.16105da8.css" as="style"><link rel="preload" href="/assets/js/app.7176b739.js" as="script"><link rel="preload" href="/assets/js/6.d52816f4.js" as="script"><link rel="prefetch" href="/assets/js/10.837b488c.js"><link rel="prefetch" href="/assets/js/100.ed3019fa.js"><link rel="prefetch" href="/assets/js/101.4cce5781.js"><link rel="prefetch" href="/assets/js/102.e6c4032b.js"><link rel="prefetch" href="/assets/js/103.468b3045.js"><link rel="prefetch" href="/assets/js/104.8d534601.js"><link rel="prefetch" href="/assets/js/105.2e73726e.js"><link rel="prefetch" href="/assets/js/106.ab20f348.js"><link rel="prefetch" href="/assets/js/107.a24473e3.js"><link rel="prefetch" href="/assets/js/108.f0646629.js"><link rel="prefetch" href="/assets/js/109.90d48ef7.js"><link rel="prefetch" href="/assets/js/11.be709720.js"><link rel="prefetch" href="/assets/js/110.aa6c93bd.js"><link rel="prefetch" href="/assets/js/111.092952e8.js"><link rel="prefetch" href="/assets/js/112.6bf1b2c0.js"><link rel="prefetch" href="/assets/js/113.9c62219a.js"><link rel="prefetch" href="/assets/js/114.79f7f36b.js"><link rel="prefetch" href="/assets/js/115.54f98d94.js"><link rel="prefetch" href="/assets/js/116.aab79f49.js"><link rel="prefetch" href="/assets/js/117.fe9fd0e6.js"><link rel="prefetch" href="/assets/js/118.410eee1a.js"><link rel="prefetch" href="/assets/js/119.8b94d414.js"><link rel="prefetch" href="/assets/js/12.2f7f1056.js"><link rel="prefetch" href="/assets/js/120.62cb9620.js"><link rel="prefetch" href="/assets/js/121.f4ab011b.js"><link rel="prefetch" href="/assets/js/122.ec553b6a.js"><link rel="prefetch" href="/assets/js/123.f02b2ae4.js"><link rel="prefetch" href="/assets/js/124.9c51f716.js"><link rel="prefetch" href="/assets/js/125.b54d1d56.js"><link rel="prefetch" href="/assets/js/126.50147669.js"><link rel="prefetch" href="/assets/js/127.61d3a2f4.js"><link rel="prefetch" href="/assets/js/128.2f747591.js"><link rel="prefetch" href="/assets/js/129.7a31ddb0.js"><link rel="prefetch" href="/assets/js/13.defd66ad.js"><link rel="prefetch" href="/assets/js/130.956408f2.js"><link rel="prefetch" href="/assets/js/131.dabd1665.js"><link rel="prefetch" href="/assets/js/132.aa88a163.js"><link rel="prefetch" href="/assets/js/133.babd908e.js"><link rel="prefetch" href="/assets/js/134.47959427.js"><link rel="prefetch" href="/assets/js/135.7c57d715.js"><link rel="prefetch" href="/assets/js/136.daafcc89.js"><link rel="prefetch" href="/assets/js/137.f4962a56.js"><link rel="prefetch" href="/assets/js/138.8257b145.js"><link rel="prefetch" href="/assets/js/139.06450aba.js"><link rel="prefetch" href="/assets/js/14.39d6fcfd.js"><link rel="prefetch" href="/assets/js/140.347c8cc5.js"><link rel="prefetch" href="/assets/js/141.f3d05de8.js"><link rel="prefetch" href="/assets/js/142.7a6b2bb9.js"><link rel="prefetch" href="/assets/js/143.0dc40c58.js"><link rel="prefetch" href="/assets/js/144.fbf895db.js"><link rel="prefetch" href="/assets/js/145.dec8a9ae.js"><link rel="prefetch" href="/assets/js/146.d5858dce.js"><link rel="prefetch" href="/assets/js/147.efeb70f1.js"><link rel="prefetch" href="/assets/js/148.ff8cad32.js"><link rel="prefetch" href="/assets/js/149.c8813732.js"><link rel="prefetch" href="/assets/js/15.a948696f.js"><link rel="prefetch" href="/assets/js/150.64bbe933.js"><link rel="prefetch" href="/assets/js/151.6435c031.js"><link rel="prefetch" href="/assets/js/152.5fb245e2.js"><link rel="prefetch" href="/assets/js/153.aab737b5.js"><link rel="prefetch" href="/assets/js/154.55fb717e.js"><link rel="prefetch" href="/assets/js/155.8d04b986.js"><link rel="prefetch" href="/assets/js/156.464a8b59.js"><link rel="prefetch" href="/assets/js/157.7d2fc633.js"><link rel="prefetch" href="/assets/js/158.8b643630.js"><link rel="prefetch" href="/assets/js/159.3ce8305e.js"><link rel="prefetch" href="/assets/js/16.5a5c5ed9.js"><link rel="prefetch" href="/assets/js/160.af2aa1a5.js"><link rel="prefetch" href="/assets/js/161.050a3b3c.js"><link rel="prefetch" href="/assets/js/162.5d88a43c.js"><link rel="prefetch" href="/assets/js/163.ff34a390.js"><link rel="prefetch" href="/assets/js/164.8fb414e3.js"><link rel="prefetch" href="/assets/js/165.fe82000e.js"><link rel="prefetch" href="/assets/js/166.f623364c.js"><link rel="prefetch" href="/assets/js/167.ce0d6195.js"><link rel="prefetch" href="/assets/js/168.b89b35c5.js"><link rel="prefetch" href="/assets/js/169.1cc3eda1.js"><link rel="prefetch" href="/assets/js/17.fb0a8623.js"><link rel="prefetch" href="/assets/js/170.1ed4d3de.js"><link rel="prefetch" href="/assets/js/171.45b64180.js"><link rel="prefetch" href="/assets/js/172.0c0ce452.js"><link rel="prefetch" href="/assets/js/173.5a82659f.js"><link rel="prefetch" href="/assets/js/174.0c66f576.js"><link rel="prefetch" href="/assets/js/175.297f67d9.js"><link rel="prefetch" href="/assets/js/176.c14fe812.js"><link rel="prefetch" href="/assets/js/177.d12fb887.js"><link rel="prefetch" href="/assets/js/178.874b3217.js"><link rel="prefetch" href="/assets/js/179.0db131d5.js"><link rel="prefetch" href="/assets/js/18.ec8dbdc2.js"><link rel="prefetch" href="/assets/js/180.9f2d5dc3.js"><link rel="prefetch" href="/assets/js/181.9c1c5f3c.js"><link rel="prefetch" href="/assets/js/182.d4be74f1.js"><link rel="prefetch" href="/assets/js/183.cb6fb43e.js"><link rel="prefetch" href="/assets/js/184.af6c4d89.js"><link rel="prefetch" href="/assets/js/185.ddffc64f.js"><link rel="prefetch" href="/assets/js/186.10117840.js"><link rel="prefetch" href="/assets/js/187.f1ae13c3.js"><link rel="prefetch" href="/assets/js/188.ddb2b726.js"><link rel="prefetch" href="/assets/js/189.efab3b91.js"><link rel="prefetch" href="/assets/js/19.162bc765.js"><link rel="prefetch" href="/assets/js/190.6c9b1181.js"><link rel="prefetch" href="/assets/js/191.75a23eaf.js"><link rel="prefetch" href="/assets/js/192.dda1c4bf.js"><link rel="prefetch" href="/assets/js/193.509fbf9e.js"><link rel="prefetch" href="/assets/js/194.84cea955.js"><link rel="prefetch" href="/assets/js/195.4a8de134.js"><link rel="prefetch" href="/assets/js/196.0d1730c9.js"><link rel="prefetch" href="/assets/js/197.70143000.js"><link rel="prefetch" href="/assets/js/198.846bc07a.js"><link rel="prefetch" href="/assets/js/199.f6255cad.js"><link rel="prefetch" href="/assets/js/2.fc997812.js"><link rel="prefetch" href="/assets/js/20.d04aea00.js"><link rel="prefetch" href="/assets/js/200.963f9de4.js"><link rel="prefetch" href="/assets/js/201.27c2d802.js"><link rel="prefetch" href="/assets/js/202.f6b751c2.js"><link rel="prefetch" href="/assets/js/203.7f7d0315.js"><link rel="prefetch" href="/assets/js/204.6be7fee8.js"><link rel="prefetch" href="/assets/js/205.95971e52.js"><link rel="prefetch" href="/assets/js/206.07fdd631.js"><link rel="prefetch" href="/assets/js/207.12682745.js"><link rel="prefetch" href="/assets/js/208.ff95c7d2.js"><link rel="prefetch" href="/assets/js/209.789d91cd.js"><link rel="prefetch" href="/assets/js/21.0cb83e95.js"><link rel="prefetch" href="/assets/js/210.7175fe11.js"><link rel="prefetch" href="/assets/js/211.1165c794.js"><link rel="prefetch" href="/assets/js/212.221f499f.js"><link rel="prefetch" href="/assets/js/213.2870f96d.js"><link rel="prefetch" href="/assets/js/214.51322d26.js"><link rel="prefetch" href="/assets/js/215.f3b70a6c.js"><link rel="prefetch" href="/assets/js/216.bf213130.js"><link rel="prefetch" href="/assets/js/217.db40de02.js"><link rel="prefetch" href="/assets/js/218.80ffed9c.js"><link rel="prefetch" href="/assets/js/219.7488fedf.js"><link rel="prefetch" href="/assets/js/22.9b59b7df.js"><link rel="prefetch" href="/assets/js/220.126c81f3.js"><link rel="prefetch" href="/assets/js/221.f50c6b79.js"><link rel="prefetch" href="/assets/js/222.ce3028f3.js"><link rel="prefetch" href="/assets/js/223.a2df17c7.js"><link rel="prefetch" href="/assets/js/224.a08bd812.js"><link rel="prefetch" href="/assets/js/225.d9a724c8.js"><link rel="prefetch" href="/assets/js/226.0517c87d.js"><link rel="prefetch" href="/assets/js/227.c4b3130c.js"><link rel="prefetch" href="/assets/js/228.2594dcec.js"><link rel="prefetch" href="/assets/js/229.af2ff4f3.js"><link rel="prefetch" href="/assets/js/23.ce477d38.js"><link rel="prefetch" href="/assets/js/230.cfef10b7.js"><link rel="prefetch" href="/assets/js/231.099fa3f4.js"><link rel="prefetch" href="/assets/js/232.b798c8ba.js"><link rel="prefetch" href="/assets/js/233.a7d2684b.js"><link rel="prefetch" href="/assets/js/234.90df19ca.js"><link rel="prefetch" href="/assets/js/235.6073a67d.js"><link rel="prefetch" href="/assets/js/236.17cd33a2.js"><link rel="prefetch" href="/assets/js/237.c509df55.js"><link rel="prefetch" href="/assets/js/238.564b22a1.js"><link rel="prefetch" href="/assets/js/239.8c166540.js"><link rel="prefetch" href="/assets/js/24.5a5f8261.js"><link rel="prefetch" href="/assets/js/240.5392f950.js"><link rel="prefetch" href="/assets/js/25.bcb6edd5.js"><link rel="prefetch" href="/assets/js/26.3aa94d94.js"><link rel="prefetch" href="/assets/js/27.d9e19d36.js"><link rel="prefetch" href="/assets/js/28.c8e5ec29.js"><link rel="prefetch" href="/assets/js/29.97ecc4ae.js"><link rel="prefetch" href="/assets/js/3.9c25940f.js"><link rel="prefetch" href="/assets/js/30.ce2f9053.js"><link rel="prefetch" href="/assets/js/31.17c368a3.js"><link rel="prefetch" href="/assets/js/32.e95a8022.js"><link rel="prefetch" href="/assets/js/33.36903a82.js"><link rel="prefetch" href="/assets/js/34.6c6f9921.js"><link rel="prefetch" href="/assets/js/35.1deead96.js"><link rel="prefetch" href="/assets/js/36.d88f7134.js"><link rel="prefetch" href="/assets/js/37.e7c746a9.js"><link rel="prefetch" href="/assets/js/38.d039d072.js"><link rel="prefetch" href="/assets/js/39.653ca8e7.js"><link rel="prefetch" href="/assets/js/4.b8208adc.js"><link rel="prefetch" href="/assets/js/40.531eeb87.js"><link rel="prefetch" href="/assets/js/41.e9e070bc.js"><link rel="prefetch" href="/assets/js/42.4f786ab5.js"><link rel="prefetch" href="/assets/js/43.55600803.js"><link rel="prefetch" href="/assets/js/44.cad1e082.js"><link rel="prefetch" href="/assets/js/45.7ba9233b.js"><link rel="prefetch" href="/assets/js/46.ca3f6667.js"><link rel="prefetch" href="/assets/js/47.e99ae5a3.js"><link rel="prefetch" href="/assets/js/48.30ede66b.js"><link rel="prefetch" href="/assets/js/49.0357be81.js"><link rel="prefetch" href="/assets/js/5.49a76c4e.js"><link rel="prefetch" href="/assets/js/50.5788bdfd.js"><link rel="prefetch" href="/assets/js/51.1374bafa.js"><link rel="prefetch" href="/assets/js/52.d383075b.js"><link rel="prefetch" href="/assets/js/53.0f284172.js"><link rel="prefetch" href="/assets/js/54.32b92586.js"><link rel="prefetch" href="/assets/js/55.8aa41e0a.js"><link rel="prefetch" href="/assets/js/56.914e6e7e.js"><link rel="prefetch" href="/assets/js/57.a6e830b0.js"><link rel="prefetch" href="/assets/js/58.76926cd0.js"><link rel="prefetch" href="/assets/js/59.e0c4dfc6.js"><link rel="prefetch" href="/assets/js/60.33c19286.js"><link rel="prefetch" href="/assets/js/61.f9ca94b9.js"><link rel="prefetch" href="/assets/js/62.95f29cd4.js"><link rel="prefetch" href="/assets/js/63.e343225c.js"><link rel="prefetch" href="/assets/js/64.ff820f35.js"><link rel="prefetch" href="/assets/js/65.51e9d85c.js"><link rel="prefetch" href="/assets/js/66.5737e21a.js"><link rel="prefetch" href="/assets/js/67.e9f5b207.js"><link rel="prefetch" href="/assets/js/68.07b80f79.js"><link rel="prefetch" href="/assets/js/69.2bd5e705.js"><link rel="prefetch" href="/assets/js/7.3063b42d.js"><link rel="prefetch" href="/assets/js/70.7c17fb33.js"><link rel="prefetch" href="/assets/js/71.89d52ad2.js"><link rel="prefetch" href="/assets/js/72.f705bc7b.js"><link rel="prefetch" href="/assets/js/73.3942d689.js"><link rel="prefetch" href="/assets/js/74.60ed1ec6.js"><link rel="prefetch" href="/assets/js/75.960d90bf.js"><link rel="prefetch" href="/assets/js/76.086ac3f9.js"><link rel="prefetch" href="/assets/js/77.f4e9c9ec.js"><link rel="prefetch" href="/assets/js/78.8f7a5bb2.js"><link rel="prefetch" href="/assets/js/79.6d64477a.js"><link rel="prefetch" href="/assets/js/8.cac4dc08.js"><link rel="prefetch" href="/assets/js/80.bfa3db3f.js"><link rel="prefetch" href="/assets/js/81.d00c1b91.js"><link rel="prefetch" href="/assets/js/82.55cf5ce1.js"><link rel="prefetch" href="/assets/js/83.cd21ff05.js"><link rel="prefetch" href="/assets/js/84.99cd412c.js"><link rel="prefetch" href="/assets/js/85.34a918a4.js"><link rel="prefetch" href="/assets/js/86.99d94992.js"><link rel="prefetch" href="/assets/js/87.968aef60.js"><link rel="prefetch" href="/assets/js/88.fb1f593e.js"><link rel="prefetch" href="/assets/js/89.5a3de2b2.js"><link rel="prefetch" href="/assets/js/9.de87a797.js"><link rel="prefetch" href="/assets/js/90.ad21685e.js"><link rel="prefetch" href="/assets/js/91.03594ea0.js"><link rel="prefetch" href="/assets/js/92.047b4c1a.js"><link rel="prefetch" href="/assets/js/93.9db94ded.js"><link rel="prefetch" href="/assets/js/94.01f8e062.js"><link rel="prefetch" href="/assets/js/95.02fbce13.js"><link rel="prefetch" href="/assets/js/96.dab24bb8.js"><link rel="prefetch" href="/assets/js/97.886b51d3.js"><link rel="prefetch" href="/assets/js/98.f942f4ea.js"><link rel="prefetch" href="/assets/js/99.07d9a5b5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.16105da8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Bing</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">归档</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/clang/content.html" class="nav-link">C</a></li><li class="dropdown-item"><!----> <a href="/PHP/content.html" class="nav-link">PHP</a></li><li class="dropdown-item"><!----> <a href="/GO/content.html" class="nav-link">GO</a></li><li class="dropdown-item"><!----> <a href="/network/content.html" class="nav-link">网络</a></li><li class="dropdown-item"><!----> <a href="/OS/content.html" class="nav-link">操作系统</a></li><li class="dropdown-item"><!----> <a href="/datastructure/content.html" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/algorithms/content.html" class="nav-link">算法</a></li><li class="dropdown-item"><!----> <a href="/Database/content.html" class="nav-link">数据库</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/topics/redis/content.html" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/topics/container/content.html" class="nav-link">Linux 容器</a></li><li class="dropdown-item"><!----> <a href="/topics/centent.html" class="nav-link">更多...</a></li></ul></div></div><div class="nav-item"><a href="/gossip/content.html" class="nav-link">杂谈</a></div><div class="nav-item"><a href="/aboutme.html" class="nav-link">关于</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">归档</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/clang/content.html" class="nav-link">C</a></li><li class="dropdown-item"><!----> <a href="/PHP/content.html" class="nav-link">PHP</a></li><li class="dropdown-item"><!----> <a href="/GO/content.html" class="nav-link">GO</a></li><li class="dropdown-item"><!----> <a href="/network/content.html" class="nav-link">网络</a></li><li class="dropdown-item"><!----> <a href="/OS/content.html" class="nav-link">操作系统</a></li><li class="dropdown-item"><!----> <a href="/datastructure/content.html" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/algorithms/content.html" class="nav-link">算法</a></li><li class="dropdown-item"><!----> <a href="/Database/content.html" class="nav-link">数据库</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/topics/redis/content.html" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/topics/container/content.html" class="nav-link">Linux 容器</a></li><li class="dropdown-item"><!----> <a href="/topics/centent.html" class="nav-link">更多...</a></li></ul></div></div><div class="nav-item"><a href="/gossip/content.html" class="nav-link">杂谈</a></div><div class="nav-item"><a href="/aboutme.html" class="nav-link">关于</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>数据结构和对象</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/topics/redis/structures.html#简单动态字符串" class="sidebar-link">简单动态字符串</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/topics/redis/structures.html#数据结构" class="sidebar-link">数据结构</a></li><li class="sidebar-sub-header"><a href="/topics/redis/structures.html#sds数据操作" class="sidebar-link">SDS数据操作</a></li><li class="sidebar-sub-header"><a href="/topics/redis/structures.html#创建sds" class="sidebar-link">创建SDS</a></li><li class="sidebar-sub-header"><a href="/topics/redis/structures.html#sds-字符拼接" class="sidebar-link">SDS 字符拼接</a></li><li class="sidebar-sub-header"><a href="/topics/redis/structures.html#sds和c字符串的区别" class="sidebar-link">SDS和C字符串的区别</a></li><li class="sidebar-sub-header"><a href="/topics/redis/structures.html#编译测试" class="sidebar-link">编译测试</a></li></ul></li><li><a href="/topics/redis/structures.html#链表" class="sidebar-link">链表</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/topics/redis/structures.html#redis链表的特点" class="sidebar-link">Redis链表的特点</a></li><li class="sidebar-sub-header"><a href="/topics/redis/structures.html#编译测试-2" class="sidebar-link">编译测试</a></li></ul></li><li><a href="/topics/redis/structures.html#字典" class="sidebar-link">字典</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/topics/redis/structures.html#rehash" class="sidebar-link">Rehash</a></li><li class="sidebar-sub-header"><a href="/topics/redis/structures.html#字典的基本操作" class="sidebar-link">字典的基本操作</a></li><li class="sidebar-sub-header"><a href="/topics/redis/structures.html#迭代器" class="sidebar-link">迭代器</a></li><li class="sidebar-sub-header"><a href="/topics/redis/structures.html#编译测试-3" class="sidebar-link">编译测试</a></li></ul></li><li><a href="/topics/redis/structures.html#跳跃表" class="sidebar-link">跳跃表</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/topics/redis/structures.html#整数集合" class="sidebar-link">整数集合</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/topics/redis/structures.html#整数集合的基本操作" class="sidebar-link">整数集合的基本操作</a></li></ul></li><li><a href="/topics/redis/structures.html#压缩列表" class="sidebar-link">压缩列表</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/topics/redis/structures.html#对象" class="sidebar-link">对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/topics/redis/structures.html#创建对象" class="sidebar-link">创建对象</a></li><li class="sidebar-sub-header"><a href="/topics/redis/structures.html#引用计数" class="sidebar-link">引用计数</a></li><li class="sidebar-sub-header"><a href="/topics/redis/structures.html#内存回收" class="sidebar-link">内存回收</a></li></ul></li><li><a href="/topics/redis/structures.html#数据库" class="sidebar-link">数据库</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/topics/redis/structures.html#参考" class="sidebar-link">参考</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="数据结构和对象"><a href="#数据结构和对象" aria-hidden="true" class="header-anchor">#</a> 数据结构和对象</h1> <h2 id="简单动态字符串"><a href="#简单动态字符串" aria-hidden="true" class="header-anchor">#</a> 简单动态字符串</h2> <p>Redis没有直接使用C里面的字符串，而是构建了一种名为简单动态字符串(Simple dynamic strings, SDS)的抽象类型，并且作为Redis的默认字符串表示。</p> <blockquote><p>相关源文件： <a href="https://github.com/antirez/redis/blob/5.0/src/sds.c" target="_blank" rel="noopener noreferrer">sds.c<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/antirez/redis/blob/5.0/src/sds.h" target="_blank" rel="noopener noreferrer">sds.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/antirez/redis/blob/5.0/src/sdsalloc.h" target="_blank" rel="noopener noreferrer">sdsalloc.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/antirez/redis/blob/5.0/src/zmalloc.c" target="_blank" rel="noopener noreferrer">zmalloc.c<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/antirez/redis/blob/5.0/src/zmalloc.h" target="_blank" rel="noopener noreferrer">zmalloc.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <h3 id="数据结构"><a href="#数据结构" aria-hidden="true" class="header-anchor">#</a> 数据结构</h3> <p><code>sdsalloc.h</code>很简单，只是引入了SDS的内存管理模块而已（源码如下）。而真正的内存管理是在<code>zmalloc.h</code>和<code>zmalloc.c</code>中定义和实现的，具体实现请看<a href="/topics/redis/zmalloc.html">这里</a>。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;zmalloc.h&quot;</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> s_malloc zmalloc</span>
<span class="token macro property">#<span class="token directive keyword">define</span> s_realloc zrealloc</span>
<span class="token macro property">#<span class="token directive keyword">define</span> s_free zfree</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>简单动态字符串具体是在<code>sds.c</code>和<code>sds.h</code>中实现的。在头文件中定义了两种主要的类型，<code>sds</code>和<code>sdshdr##T</code>。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">char</span> <span class="token operator">*</span>sds<span class="token punctuation">;</span>

<span class="token comment">/* Note: sdshdr5 is never used, we just access the flags byte directly.
 * However is here to document the layout of type 5 SDS strings. */</span>
<span class="token keyword">struct</span> __attribute__ <span class="token punctuation">(</span><span class="token punctuation">(</span>__packed__<span class="token punctuation">)</span><span class="token punctuation">)</span> sdshdr5 <span class="token punctuation">{</span>
    <span class="token comment">/* __attribute__ ((__packed__)) 取消字节对齐*/</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> flags<span class="token punctuation">;</span> <span class="token comment">/* 3 lsb of type, and 5 msb of string length */</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> __attribute__ <span class="token punctuation">(</span><span class="token punctuation">(</span>__packed__<span class="token punctuation">)</span><span class="token punctuation">)</span> sdshdr8 <span class="token punctuation">{</span>
    uint8_t len<span class="token punctuation">;</span> <span class="token comment">/* used */</span>
    uint8_t alloc<span class="token punctuation">;</span> <span class="token comment">/* excluding the header and null terminator */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> flags<span class="token punctuation">;</span> <span class="token comment">/* 3 lsb of type, 5 unused bits */</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> __attribute__ <span class="token punctuation">(</span><span class="token punctuation">(</span>__packed__<span class="token punctuation">)</span><span class="token punctuation">)</span> sdshdr16 <span class="token punctuation">{</span>
    uint16_t len<span class="token punctuation">;</span> <span class="token comment">/* used */</span>
    uint16_t alloc<span class="token punctuation">;</span> <span class="token comment">/* excluding the header and null terminator */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> flags<span class="token punctuation">;</span> <span class="token comment">/* 3 lsb of type, 5 unused bits */</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> __attribute__ <span class="token punctuation">(</span><span class="token punctuation">(</span>__packed__<span class="token punctuation">)</span><span class="token punctuation">)</span> sdshdr32 <span class="token punctuation">{</span>
    uint32_t len<span class="token punctuation">;</span> <span class="token comment">/* used */</span>
    uint32_t alloc<span class="token punctuation">;</span> <span class="token comment">/* excluding the header and null terminator */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> flags<span class="token punctuation">;</span> <span class="token comment">/* 3 lsb of type, 5 unused bits */</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> __attribute__ <span class="token punctuation">(</span><span class="token punctuation">(</span>__packed__<span class="token punctuation">)</span><span class="token punctuation">)</span> sdshdr64 <span class="token punctuation">{</span>
    uint64_t len<span class="token punctuation">;</span> <span class="token comment">/* used */</span>
    uint64_t alloc<span class="token punctuation">;</span> <span class="token comment">/* excluding the header and null terminator */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> flags<span class="token punctuation">;</span> <span class="token comment">/* 3 lsb of type, 5 unused bits */</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>作者共定义了五种类型的<code>sdshdr</code>，主要是为了内存的优化，节省内存，毕竟sds是redis中最常用到的数据类型。<code>__attribute__ ((__packed__))</code> 也是为了告诉编译器取消字节对齐优化。其中<code>sdshdr5</code>还没有使用过。</p> <p>整个SDS的内存是一块连续的，统一开辟的。<code>sdshdr</code>结构体后面紧跟着字符串<code>sds</code>。结构体的最后一个成员<code>char buf[];</code>是一个元素个数为0的字符数组，并不占用内存空间，为了指示在结构体后面才是字符串的实体所在。所以在<code>sds.h</code>中就有这么些骚操作：</p> <h3 id="sds数据操作"><a href="#sds数据操作" aria-hidden="true" class="header-anchor">#</a> SDS数据操作</h3> <ol><li>sds和sdshdr</li></ol> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// 根据字符串sds拿到sdshdr结构体的指针。</span>
<span class="token comment">//    字符串sds减去相应结构体的大小得到结构体</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SDS_HDR_VAR(T,s) struct sdshdr##T *sh = (void*)((s)-(sizeof(struct sdshdr##T)));</span>
<span class="token comment">// 根据字符串sds拿到sdshdr结构体的地址</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SDS_HDR(T,s) ((struct sdshdr##T *)((s)-(sizeof(struct sdshdr##T))))</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="2"><li>sds和flags</li></ol> <div class="language-c line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">inline</span> size_t <span class="token function">sdslen</span><span class="token punctuation">(</span><span class="token keyword">const</span> sds s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
     * inline关键字仅仅是建议编译器做内联展开处理，而不是强制。在gcc编译器中，如果编译优化设置为-O0，即使是inline函数也不会被内联展开，
     * 除非设置了强制内联（__attribute__((always_inline))）属性。
     * */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> flags <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>flags<span class="token operator">&amp;</span>SDS_TYPE_MASK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> SDS_TYPE_5<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token function">SDS_TYPE_5_LEN</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> SDS_TYPE_8<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token function">SDS_HDR</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token operator">-&gt;</span>len<span class="token punctuation">;</span>
        <span class="token keyword">case</span> SDS_TYPE_16<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token function">SDS_HDR</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token operator">-&gt;</span>len<span class="token punctuation">;</span>
        <span class="token keyword">case</span> SDS_TYPE_32<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token function">SDS_HDR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token operator">-&gt;</span>len<span class="token punctuation">;</span>
        <span class="token keyword">case</span> SDS_TYPE_64<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token function">SDS_HDR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token operator">-&gt;</span>len<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>看代码第6行，这就很厉害了，字符串前一个字节就是<code>flags</code>，-1 就拿到了类型的值，进而就知道s(sds)前面的sdshdr的地址。</p> <h3 id="创建sds"><a href="#创建sds" aria-hidden="true" class="header-anchor">#</a> 创建SDS</h3> <p>先计算C字符串的长度：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>sds <span class="token function">sdsnew</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>init<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    size_t initlen <span class="token operator">=</span> <span class="token punctuation">(</span>init <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> <span class="token function">strlen</span><span class="token punctuation">(</span>init<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">sdsnewlen</span><span class="token punctuation">(</span>init<span class="token punctuation">,</span> initlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>根据长度和字符串创建SDS：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>sds <span class="token function">sdsnewlen</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>init<span class="token punctuation">,</span> size_t initlen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>sh<span class="token punctuation">;</span>
    sds s<span class="token punctuation">;</span>
    <span class="token keyword">char</span> type <span class="token operator">=</span> <span class="token function">sdsReqType</span><span class="token punctuation">(</span>initlen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 根据字符串的长度选择合适的sdshdr类型 */</span>
    <span class="token comment">/* Empty strings are usually created in order to append. Use type 8
     * since type 5 is not good at this. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> SDS_TYPE_5 <span class="token operator">&amp;&amp;</span> initlen <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> type <span class="token operator">=</span> SDS_TYPE_8<span class="token punctuation">;</span>
    <span class="token keyword">int</span> hdrlen <span class="token operator">=</span> <span class="token function">sdsHdrSize</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>fp<span class="token punctuation">;</span>

    sh <span class="token operator">=</span> <span class="token function">s_malloc</span><span class="token punctuation">(</span>hdrlen<span class="token operator">+</span>initlen<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* sds结构长度+起始字符串长度+末尾空字符（1）*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>init<span class="token operator">==</span>SDS_NOINIT<span class="token punctuation">)</span>
        init <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>init<span class="token punctuation">)</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>sh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> hdrlen<span class="token operator">+</span>initlen<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sh <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>sh<span class="token operator">+</span>hdrlen<span class="token punctuation">;</span> <span class="token comment">/* 跳到结构体的最后，拿到sds的指针 */</span>
    fp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>s<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">/* 回过头来拿到结构体中flags成员的指针 */</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 初始化结构体成员 */</span>
        <span class="token keyword">case</span> SDS_TYPE_5<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span>fp <span class="token operator">=</span> type <span class="token operator">|</span> <span class="token punctuation">(</span>initlen <span class="token operator">&lt;&lt;</span> SDS_TYPE_BITS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> SDS_TYPE_8<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token function">SDS_HDR_VAR</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sh<span class="token operator">-&gt;</span>len <span class="token operator">=</span> initlen<span class="token punctuation">;</span>
            sh<span class="token operator">-&gt;</span>alloc <span class="token operator">=</span> initlen<span class="token punctuation">;</span>
            <span class="token operator">*</span>fp <span class="token operator">=</span> type<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> SDS_TYPE_16<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token function">SDS_HDR_VAR</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sh<span class="token operator">-&gt;</span>len <span class="token operator">=</span> initlen<span class="token punctuation">;</span>
            sh<span class="token operator">-&gt;</span>alloc <span class="token operator">=</span> initlen<span class="token punctuation">;</span>
            <span class="token operator">*</span>fp <span class="token operator">=</span> type<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> SDS_TYPE_32<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token function">SDS_HDR_VAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sh<span class="token operator">-&gt;</span>len <span class="token operator">=</span> initlen<span class="token punctuation">;</span>
            sh<span class="token operator">-&gt;</span>alloc <span class="token operator">=</span> initlen<span class="token punctuation">;</span>
            <span class="token operator">*</span>fp <span class="token operator">=</span> type<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> SDS_TYPE_64<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token function">SDS_HDR_VAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sh<span class="token operator">-&gt;</span>len <span class="token operator">=</span> initlen<span class="token punctuation">;</span>
            sh<span class="token operator">-&gt;</span>alloc <span class="token operator">=</span> initlen<span class="token punctuation">;</span>
            <span class="token operator">*</span>fp <span class="token operator">=</span> type<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>initlen <span class="token operator">&amp;&amp;</span> init<span class="token punctuation">)</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> init<span class="token punctuation">,</span> initlen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 把字符串保存到sds中 */</span>
    s<span class="token punctuation">[</span>initlen<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>  <span class="token comment">/* 加上\0作为字符串结束符 */</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>就是如此高雅简洁！</p> <h3 id="sds-字符拼接"><a href="#sds-字符拼接" aria-hidden="true" class="header-anchor">#</a> SDS 字符拼接</h3> <p>对字符串进行拼接是常有的操作。<code>sdscat</code>和<code>strcat</code>有很大的区别。</p> <p><code>sdscat</code></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>sds <span class="token function">sdscat</span><span class="token punctuation">(</span>sds s<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">sdscatlen</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>sdscatlen</code></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>sds <span class="token function">sdscatlen</span><span class="token punctuation">(</span>sds s<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>t<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取当前SDS的长度，sdshdr-&gt;len</span>
    size_t curlen <span class="token operator">=</span> <span class="token function">sdslen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

    s <span class="token operator">=</span> <span class="token function">sdsMakeRoomFor</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment">// 将目标字符串的内容复制到原SDS后面</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>s<span class="token operator">+</span>curlen<span class="token punctuation">,</span> t<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 重新设置sds的长度，即更新sdshdr-&gt;len</span>
    <span class="token function">sdssetlen</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> curlen<span class="token operator">+</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// sds后面加上'\0'</span>
    s<span class="token punctuation">[</span>curlen<span class="token operator">+</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><code>sdscatlen</code>函数的核心是<code>sdsMakeRoomFor</code>，它是如何杜绝SDS缓冲区溢出的呢？</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>sds <span class="token function">sdsMakeRoomFor</span><span class="token punctuation">(</span>sds s<span class="token punctuation">,</span> size_t addlen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>sh<span class="token punctuation">,</span> <span class="token operator">*</span>newsh<span class="token punctuation">;</span>
    <span class="token comment">// 计算SDS剩余缓存大小： sdshdr-&gt;alloc - sdshdr-&gt;len</span>
    size_t avail <span class="token operator">=</span> <span class="token function">sdsavail</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    size_t len<span class="token punctuation">,</span> newlen<span class="token punctuation">;</span>
    <span class="token keyword">char</span> type<span class="token punctuation">,</span> oldtype <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> SDS_TYPE_MASK<span class="token punctuation">;</span>
    <span class="token keyword">int</span> hdrlen<span class="token punctuation">;</span>

    <span class="token comment">/* 剩余空间足够addlen长度字符的加入，立即返回 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>avail <span class="token operator">&gt;=</span> addlen<span class="token punctuation">)</span> <span class="token keyword">return</span> s<span class="token punctuation">;</span>

    <span class="token comment">// 当前SDS使用了的长度 sdshdr-&gt;len</span>
    len <span class="token operator">=</span> <span class="token function">sdslen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取SDS的sdshdr结构体的指针</span>
    sh <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>s<span class="token operator">-</span><span class="token function">sdsHdrSize</span><span class="token punctuation">(</span>oldtype<span class="token punctuation">)</span><span class="token punctuation">;</span>
    newlen <span class="token operator">=</span> <span class="token punctuation">(</span>len<span class="token operator">+</span>addlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// SDS_MAX_PREALLOC： 字符串最大的预分配长度是1M</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newlen <span class="token operator">&lt;</span> SDS_MAX_PREALLOC<span class="token punctuation">)</span>
        newlen <span class="token operator">*</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        newlen <span class="token operator">+</span><span class="token operator">=</span> SDS_MAX_PREALLOC<span class="token punctuation">;</span>

    <span class="token comment">// 根据新的sds字符串的长度重新计算sdshdr的类型</span>
    type <span class="token operator">=</span> <span class="token function">sdsReqType</span><span class="token punctuation">(</span>newlen<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Don't use type 5: the user is appending to the string and type 5 is
     * not able to remember empty space, so sdsMakeRoomFor() must be called
     * at every appending operation. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> SDS_TYPE_5<span class="token punctuation">)</span> type <span class="token operator">=</span> SDS_TYPE_8<span class="token punctuation">;</span>

    <span class="token comment">// sdshdr结构体的长度</span>
    hdrlen <span class="token operator">=</span> <span class="token function">sdsHdrSize</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// sdshdr类型没有变，对sdshdr realloc扩容即可</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldtype<span class="token operator">==</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newsh <span class="token operator">=</span> <span class="token function">s_realloc</span><span class="token punctuation">(</span>sh<span class="token punctuation">,</span> hdrlen<span class="token operator">+</span>newlen<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newsh <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>newsh<span class="token operator">+</span>hdrlen<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Since the header size changes, need to move the string forward,
         * and can't use realloc */</span>
        <span class="token comment">// sdshdr的类型和大小都变了需要创建一个新的sdshdr</span>
        newsh <span class="token operator">=</span> <span class="token function">s_malloc</span><span class="token punctuation">(</span>hdrlen<span class="token operator">+</span>newlen<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newsh <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token comment">// 将s复制到新的sdshdr后面的sds中</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>newsh<span class="token operator">+</span>hdrlen<span class="token punctuation">,</span> s<span class="token punctuation">,</span> len<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 回收旧的sdshdr</span>
        <span class="token function">s_free</span><span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 新的sds指针</span>
        s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>newsh<span class="token operator">+</span>hdrlen<span class="token punctuation">;</span>
        <span class="token comment">// 设置sdshdr的类别</span>
        s<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> type<span class="token punctuation">;</span>
        <span class="token comment">// 设置新的sdshdr的长度成员, sdshdr-&gt;len</span>
        <span class="token function">sdssetlen</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">sdssetalloc</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> newlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>描述<code>sdsMakeRoomFor()</code>，可以简而言之：原SDS剩余空间够用，直接返回；空间不够时，若类型不变直接扩容，若类型变了，则扩容后重新创建一个新的sdshdr，并将原SDS复制到新的sdshdr后的SDS中。</p> <p>关于扩容长度策略：</p> <ol><li>原SDS剩余空间够用，则不扩容。</li> <li>当修改后SDS字符串长度小于 <code>SDS_MAX_PREALLOC</code>（1M）时，扩容长度为修改后字符串长度的两倍。</li> <li>当修改后的SDS字符串长度大于<code>SDS_MAX_PREALLOC</code>时，扩容的长度为修改后字符串长度加上<code>SDS_MAX_PREALLOC</code>,即新的字符长度+1m大小。</li></ol> <p>和<code>sdsMakeRoomFor()</code>函数相反，SDS时通过<code>sdsRemoveFreeSpace()</code>函数实现惰性空间释放。其原理于前者类似，sdshdr类型不变时，直接<code>realloc</code>，类型发生了变化时，创建一个新的sdshdr，将sds复制到新的sdshdr后面，回收旧的sdshdr占用的内存。</p> <h3 id="sds和c字符串的区别"><a href="#sds和c字符串的区别" aria-hidden="true" class="header-anchor">#</a> SDS和C字符串的区别</h3> <p>SDS相对于C字符串有以下优势：</p> <ol><li>常数复杂度获取字符串长度</li> <li>杜绝缓冲区溢出</li> <li>减少修改字符串时带来的内存重分配次数</li> <li>二进制安全</li> <li>兼容部分C字符串函数，如 <code>printf(&quot;%s&quot;, s-&gt;buf);</code>。</li></ol> <h3 id="编译测试"><a href="#编译测试" aria-hidden="true" class="header-anchor">#</a> 编译测试</h3> <p>Redis SDS可以作为独立的模块使用。编译测试：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>gcc -DSDS_TEST_MAIN -o sds sds.c zmalloc.c
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="链表"><a href="#链表" aria-hidden="true" class="header-anchor">#</a> 链表</h2> <p>作为一种常用数据结构，C 语言并没有内置这种数据结构，所以 Redis 构建了自己的链表实现。</p> <blockquote><p>相关源文件： <a href="https://github.com/antirez/redis/blob/5.0/src/adlist.h" target="_blank" rel="noopener noreferrer">adlist.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/antirez/redis/blob/5.0/src/adlist.c" target="_blank" rel="noopener noreferrer">adlist.c<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/antirez/redis/blob/5.0/src/zmalloc.h" target="_blank" rel="noopener noreferrer">zmalloc.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>Redis的链表是一个双向链表，使用list结构持有链表。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> listNode <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> listNode <span class="token operator">*</span>prev<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> listNode <span class="token operator">*</span>next<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span> listNode<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> listIter <span class="token punctuation">{</span>
    listNode <span class="token operator">*</span>next<span class="token punctuation">;</span>
    <span class="token keyword">int</span> direction<span class="token punctuation">;</span>
<span class="token punctuation">}</span> listIter<span class="token punctuation">;</span>

<span class="token comment">/* 使用list持有链表 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> list <span class="token punctuation">{</span>
    <span class="token comment">// 表头节点</span>
    listNode <span class="token operator">*</span>head<span class="token punctuation">;</span>
    <span class="token comment">// 表尾节点</span>
    listNode <span class="token operator">*</span>tail<span class="token punctuation">;</span>
    <span class="token comment">// 链表所包含的节点数量</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> len<span class="token punctuation">;</span>
    <span class="token comment">// 节点值复制函数</span>
    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>dup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 节点值释放函数</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>free<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 节点值对比函数</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>match<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> list<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>Redis链表的实现和常规的类似，不同的是，<code>list</code>结构体中有定义的三个指针函数成员<code>dup</code> 、<code>free</code> 和 <code>match</code>，用于指定实现多态链表所需的类型特定函数。</p> <h3 id="redis链表的特点"><a href="#redis链表的特点" aria-hidden="true" class="header-anchor">#</a> Redis链表的特点</h3> <ol><li>双端无环，带表头指针和表尾指针</li> <li>链表长度获取时间复杂度O(1)</li> <li>多态，链表节点使用 <code>void*</code> 指针来保存节点值， 并且可以通过 <code>list</code> 结构的 <code>dup</code> 、 <code>free</code> 、 <code>match</code> 三个属性为节点值设置类型特定函数， 所以链表可以用于保存各种不同类型的值。</li></ol> <h3 id="编译测试-2"><a href="#编译测试-2" aria-hidden="true" class="header-anchor">#</a> 编译测试</h3> <p>同样，Redis的链表作为Redis的基本数据结构也可以单独作为模块使用。</p> <h2 id="字典"><a href="#字典" aria-hidden="true" class="header-anchor">#</a> 字典</h2> <p>Redis的字典使用的哈希表作为底层实现的，一个哈希表里面可以有多个哈希表节点，每个节点保存了字典中的一个键值对。</p> <blockquote><p>相关源文件： <a href="https://github.com/antirez/redis/blob/5.0/src/dict.h" target="_blank" rel="noopener noreferrer">dict.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/antirez/redis/blob/5.0/src/dict.c" target="_blank" rel="noopener noreferrer">dict.c<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/antirez/redis/blob/5.0/src/zmalloc.h" target="_blank" rel="noopener noreferrer">zmalloc.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> , <a href="https://github.com/antirez/redis/blob/5.0/src/fmacros.h" target="_blank" rel="noopener noreferrer">fmacros.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/antirez/redis/blob/5.0/src/sds.h" target="_blank" rel="noopener noreferrer">sds.c<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/antirez/redis/blob/5.0/src/siphash.h" target="_blank" rel="noopener noreferrer">siphash.c<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>如下图展示了一个普通状态下Redis的字典结构：</p> <p><img src="/assets/img/redis_dict.88d0581d.png" alt="普通状态下Redis的字典"></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> dict <span class="token punctuation">{</span>           <span class="token comment">/* 字典的结构 */</span>
    dictType <span class="token operator">*</span>type<span class="token punctuation">;</span>             <span class="token comment">/* 类型特定函数 */</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">;</span>             <span class="token comment">/* 私有数据 */</span>
    dictht ht<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>               <span class="token comment">/* 二元哈希表 */</span>
    <span class="token keyword">long</span> rehashidx<span class="token punctuation">;</span>             <span class="token comment">/* rehash索引进度，值为-1时表示没有在进行rehash */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> iterators<span class="token punctuation">;</span>    <span class="token comment">/* 当前运行的迭代器个数 */</span>
<span class="token punctuation">}</span> dict<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>ht</code>成员是一个两个元素的数组，数组中的每个项都是一个<code>dictht</code>哈希表，一般情况下，字典使用的是 <code>ht[0]</code> 哈希表， <code>ht[1]</code> 哈希表只会在对 <code>ht[0]</code>哈希表进行 <code>rehash</code> 时使用。<code>rehashidx</code> 记录着当前字典<code>rehash</code>索引进度，值为-1时表示没有在进行<code>rehash</code>。判断字典是否在<code>rehash</code>的宏定义如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">define</span> dictIsRehashing(d) ((d)-&gt;rehashidx != -1)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Redis的哈希表结构体<code>dicht</code>，其结构如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> dictht <span class="token punctuation">{</span>         <span class="token comment">/* 哈希表的结构 */</span>
    dictEntry <span class="token operator">*</span><span class="token operator">*</span>table<span class="token punctuation">;</span>          <span class="token comment">/* 哈希表键值对指针数组 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">;</span>         <span class="token comment">/* 哈希表的大小 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> sizemask<span class="token punctuation">;</span>     <span class="token comment">/* 哈希表大小掩码，用于计算索引值，总是等于size-1*/</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> used<span class="token punctuation">;</span>         <span class="token comment">/* 该哈希表已有的节点（键值对）数目 */</span>
<span class="token punctuation">}</span> dictht<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>起始哈希表大小为<code>DICT_HT_INITIAL_SIZE</code>（4），<code>table</code>成员是<code>dictEntry</code>键值对指针的数组，每个元素都是指向<code>dictEntry</code>的指针。<code>sizemask</code> 用于计算索引值，总是等于size-1，方便通过hash值与sizemask得到索引。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>h <span class="token operator">=</span> <span class="token function">dictHashKey</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> de<span class="token operator">-&gt;</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sizemask<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>键值对结构体如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> dictEntry <span class="token punctuation">{</span>          <span class="token comment">/* 保存hash表中的键值对 */</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>                      <span class="token comment">/* 键 */</span>
    <span class="token keyword">union</span> <span class="token punctuation">{</span>                         <span class="token comment">/* 值 */</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>val<span class="token punctuation">;</span>
        uint64_t u64<span class="token punctuation">;</span>
        int64_t s64<span class="token punctuation">;</span>
        <span class="token keyword">double</span> d<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> v<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> dictEntry <span class="token operator">*</span>next<span class="token punctuation">;</span>         <span class="token comment">/* 指向哈希表中哈希值相同的下一个节点，用于解决键冲突问题 */</span>
<span class="token punctuation">}</span> dictEntry<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>看到<code>next</code>成员可以证实上图中Redis使用链地址法解决键冲突的问题。</p> <h3 id="rehash"><a href="#rehash" aria-hidden="true" class="header-anchor">#</a> Rehash</h3> <h4 id="_1-哈希方法"><a href="#_1-哈希方法" aria-hidden="true" class="header-anchor">#</a> 1. 哈希方法</h4> <p>Redis默认使用SipHash作为哈希方法，并封装了两个函数：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>uint64_t <span class="token function">dictGenHashFunction</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
uint64_t <span class="token function">dictGenCaseHashFunction</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_2-扩容和rehash初始化"><a href="#_2-扩容和rehash初始化" aria-hidden="true" class="header-anchor">#</a> 2. 扩容和rehash初始化</h4> <p>当调用<code>dictReplace()</code>, <code>dictAdd()</code>, <code>dictAddOrFind()</code>为字典添加/更新一个新的<code>dictEntry</code>时，Redis会调用<code>dictAddRaw()</code>。</p> <p><code>dictAddRaw()</code>方法会调用<code>_dictKeyIndex()</code>找到键值对的存放索引，查找索引位置前会先调用<code>_dictExpandIfNeeded()</code>判断是否需要对哈希表扩容。</p> <p>如果字典正在进行rehash，那么就不需要再扩容；如果哈希表是空的，将其扩充到起始大小<code>DICT_HT_INITIAL_SIZE</code>（值为4）；如果<code>键值对的数目/哈希表的大小</code>大于 <code>dict_force_resize_ratio</code>（值为5）时或者键值对的数目大于哈希表的大小并且<code>dict_can_resize</code>值为1时就对哈希表扩容。满足这些要求后调用<code>dictExpand()</code>为rehash做初始化工作。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* Expand the hash table if needed */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">_dictExpandIfNeeded</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* 正在hash中，返回 0 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> DICT_OK<span class="token punctuation">;</span>

    <span class="token comment">/* 如果哈希表是空的，将其扩充到起始大小 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">dictExpand</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> DICT_HT_INITIAL_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* If we reached the 1:1 ratio, and we are allowed to resize the hash
     * table (global setting) or we should avoid it but the ratio between
     * elements/buckets is over the &quot;safe&quot; threshold, we resize doubling
     * the number of buckets.
     *
     * 如果比例达到了1:1，并且我们允许调整哈希表的大小或者 键值对的数目/哈希表的大小 超过了
     * 安全阈值，我们将哈希表的大小调整到键值对数目的两倍
     * */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">&gt;=</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>dict_can_resize <span class="token operator">||</span>
         d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used<span class="token operator">/</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">&gt;</span> dict_force_resize_ratio<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">dictExpand</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> DICT_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p><code>dictExpand()</code>函数做了以下工作：</p> <ol><li>计算扩容大小<code>realsize</code>（大于扩容size的最小2<sup>n</sup>）;</li> <li>初始化<code>dict</code>第二个哈希表<code>ht[1]</code>，大小为扩容大小<code>realsize</code>，<code>sizemark</code>为<code>realsize-1</code>，<code>used</code> 为 0；</li> <li>将<code>dict</code>的<code>rehashidx</code>设置为<code>0</code>。</li></ol> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* Expand or create the hash table
 * 对已有hash表扩容或者创建一个新的hash表ht[1] */</span>
<span class="token keyword">int</span> <span class="token function">dictExpand</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* the size is invalid if it is smaller than the number of
     * elements already inside the hash table 
     * 如果正在reharsh，或者size小于元素（键值对）的个数，那么是无效的
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token operator">||</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">&gt;</span> size<span class="token punctuation">)</span>
        <span class="token keyword">return</span> DICT_ERR<span class="token punctuation">;</span> <span class="token comment">/* 返回的是1 */</span>

    dictht n<span class="token punctuation">;</span> <span class="token comment">/* the new hash table */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> realsize <span class="token operator">=</span> <span class="token function">_dictNextPower</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Rehashing to the same table size is not useful. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>realsize <span class="token operator">==</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token keyword">return</span> DICT_ERR<span class="token punctuation">;</span>

    <span class="token comment">/* Allocate the new hash table and initialize all pointers to NULL */</span>
    n<span class="token punctuation">.</span>size <span class="token operator">=</span> realsize<span class="token punctuation">;</span>
    n<span class="token punctuation">.</span>sizemask <span class="token operator">=</span> realsize<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    n<span class="token punctuation">.</span>table <span class="token operator">=</span> <span class="token function">zcalloc</span><span class="token punctuation">(</span>realsize<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>dictEntry<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    n<span class="token punctuation">.</span>used <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/* Is this the first initialization? If so it's not really a rehashing
     * we just set the first hash table so that it can accept keys. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>table <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token punctuation">;</span>
        <span class="token keyword">return</span> DICT_OK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Prepare a second hash table for incremental rehashing */</span>
    d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token punctuation">;</span>
    d<span class="token operator">-&gt;</span>rehashidx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> DICT_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h4 id="_3-rehash-方式"><a href="#_3-rehash-方式" aria-hidden="true" class="header-anchor">#</a> 3. rehash 方式</h4> <p>当字典完成初始化工作后才有可能开始rehash，rehash的条件是<code>rehashidx</code>是否为-1。为了防止rehash过程持续太久而导致进程处于block的状态，redis采用的是<strong>渐进式的rehash策略</strong>。</p> <p>redis的rehash有两种策略：</p> <ul><li>定时执行：调用<code>dictRehashMilliseconds()</code>执行一毫秒的rehash。在redis的<code>serverCron</code>里调用，每次执行1ms的<code>dictRehash()</code>，一般redis运行时用的字典结构会采用这种方法rehash，如<code>redisDb</code>结构体中的<code>dict</code>类型的成员。</li> <li>被动执行：字典调用<code>dictAddRaw()</code>,<code>dictGenericDelete()</code>，<code>dicFind()</code>, <code>dictGetSomeKeys()</code>，<code>dictGetRandomKey()</code>等函数时，会调用<code>_dictRehashStep</code>，迁移buckets中的一个非空bucket（或者跳过100个空的bucket）。</li></ul> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* Rehash for an amount of time between ms milliseconds and ms+1 milliseconds */</span>
<span class="token keyword">int</span> <span class="token function">dictRehashMilliseconds</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">int</span> ms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token function">timeInMilliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> rehashes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">dictRehash</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rehashes <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">timeInMilliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start <span class="token operator">&gt;</span> ms<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> rehashes<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* This function performs just a step of rehashing, and only if there are
 * no safe iterators bound to our hash table. When we have iterators in the
 * middle of a rehashing we can't mess with the two hash tables otherwise
 * some element can be missed or duplicated.
 *
 * This function is called by common lookup or update operations in the
 * dictionary so that the hash table automatically migrates from H1 to H2
 * while it is actively used. */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_dictRehashStep</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-&gt;</span>iterators <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">dictRehash</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h4 id="_4-rehash-原理"><a href="#_4-rehash-原理" aria-hidden="true" class="header-anchor">#</a> 4.rehash 原理</h4> <p>上面两种rehash方式都会调用<code>dictRehash()</code>执行rehash，先上代码！</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* Performs N steps of incremental rehashing. Returns 1 if there are still
 * keys to move from the old to the new hash table, otherwise 0 is returned.
 *
 * Note that a rehashing step consists in moving a bucket (that may have more
 * than one key as we use chaining) from the old to the new hash table, however
 * since part of the hash table may be composed of empty spaces, it is not
 * guaranteed that this function will rehash even a single bucket, since it
 * will visit at max N*10 empty buckets in total, otherwise the amount of
 * work it does would be unbound and the function may block for a long time.
 * */</span>
<span class="token keyword">int</span> <span class="token function">dictRehash</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 哈希表中会存在大量的空的 buckets，设置最大的数目。否则不可预期结束时间 */</span>
    <span class="token keyword">int</span> empty_visits <span class="token operator">=</span> n<span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">/* Max number of empty buckets to visit. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>n<span class="token operator">--</span> <span class="token operator">&amp;&amp;</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dictEntry <span class="token operator">*</span>de<span class="token punctuation">,</span> <span class="token operator">*</span>nextde<span class="token punctuation">;</span>

        <span class="token comment">/* Note that rehashidx can't overflow as we are sure there are more
         * elements because ht[0].used != 0 */</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>d<span class="token operator">-&gt;</span>rehashidx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>d<span class="token operator">-&gt;</span>rehashidx<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 跳过空buckets：如果该table数组该索引是空值，rehashidx加1 */</span>
            d<span class="token operator">-&gt;</span>rehashidx<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>empty_visits <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        de <span class="token operator">=</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>d<span class="token operator">-&gt;</span>rehashidx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">/* Move all the keys in this bucket from the old to the new hash HT */</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            uint64_t h<span class="token punctuation">;</span>

            nextde <span class="token operator">=</span> de<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span> <span class="token comment">/* 之前在同一hash index下的其他键值对重新计算index */</span>
            <span class="token comment">/* Get the index in the new hash table */</span>
            h <span class="token operator">=</span> <span class="token function">dictHashKey</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> de<span class="token operator">-&gt;</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sizemask<span class="token punctuation">;</span>
            de<span class="token operator">-&gt;</span>next <span class="token operator">=</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>h<span class="token punctuation">]</span><span class="token punctuation">;</span>
            d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">=</span> de<span class="token punctuation">;</span>
            d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used<span class="token operator">--</span><span class="token punctuation">;</span>
            d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used<span class="token operator">++</span><span class="token punctuation">;</span>
            de <span class="token operator">=</span> nextde<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>d<span class="token operator">-&gt;</span>rehashidx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* ht[1]的table中该位置清空值 */</span>
        d<span class="token operator">-&gt;</span>rehashidx<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Check if we already rehashed the whole table...
     * 判断是否整个表以前rehash完成，完成后rehashidx设为-1，原始的ht[0]被ht[1]替代，重新初始化ht[1] */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">zfree</span><span class="token punctuation">(</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>
        d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">_dictReset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d<span class="token operator">-&gt;</span>rehashidx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* More to rehash... */</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>rehash过程包括将一个bucket（有可能包含多个key，这些key以链表的形式存储）从旧的哈希表（ht[0]）移动到新的哈希表(ht[1])中。哈希表中会存在大量的空的 buckets，redis设置了跳过空的bucket的最大的数目，否则不可预期结束时间（参数<code>n</code>表示rehash的非空bucket)。重新hash后，之后hash的键值对会插入到键值对链表的表头。</p> <p>当 <code>d-&gt;ht[0].used == 0</code> 时rehash结束，<code>rehashidx</code>重新设置为 -1。</p> <h3 id="字典的基本操作"><a href="#字典的基本操作" aria-hidden="true" class="header-anchor">#</a> 字典的基本操作</h3> <h4 id="创建字典"><a href="#创建字典" aria-hidden="true" class="header-anchor">#</a> 创建字典</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* Reset a hash table already initialized with ht_init().
 * NOTE: This function should only be called by ht_destroy(). */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_dictReset</span><span class="token punctuation">(</span>dictht <span class="token operator">*</span>ht<span class="token punctuation">)</span> <span class="token comment">/* 初始化dictht表结构 */</span>
<span class="token punctuation">{</span>
    ht<span class="token operator">-&gt;</span>table <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    ht<span class="token operator">-&gt;</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    ht<span class="token operator">-&gt;</span>sizemask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    ht<span class="token operator">-&gt;</span>used <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Create a new hash table */</span>
dict <span class="token operator">*</span><span class="token function">dictCreate</span><span class="token punctuation">(</span>dictType <span class="token operator">*</span>type<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>privDataPtr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    dict <span class="token operator">*</span>d <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">_dictInit</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span>type<span class="token punctuation">,</span>privDataPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> d<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 初始化字典结构体 */</span>
<span class="token keyword">int</span> <span class="token function">_dictInit</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> dictType <span class="token operator">*</span>type<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>privDataPtr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">_dictReset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_dictReset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    d<span class="token operator">-&gt;</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
    d<span class="token operator">-&gt;</span>privdata <span class="token operator">=</span> privDataPtr<span class="token punctuation">;</span>
    d<span class="token operator">-&gt;</span>rehashidx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    d<span class="token operator">-&gt;</span>iterators <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> DICT_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><code>dictCreate()</code>函数创建一个新的字典，并对所有的成员设置了初始值，其中<code>ht</code>的两个元素都设置为<code>NULL</code>。</p> <h4 id="插入一个键值对"><a href="#插入一个键值对" aria-hidden="true" class="header-anchor">#</a> 插入一个键值对</h4> <p><code>dictAdd()</code>方法用于插入一个键值对。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* Add an element to the target hash table */</span>
<span class="token keyword">int</span> <span class="token function">dictAdd</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>val<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    dictEntry <span class="token operator">*</span>entry <span class="token operator">=</span> <span class="token function">dictAddRaw</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">)</span> <span class="token keyword">return</span> DICT_ERR<span class="token punctuation">;</span>
    <span class="token function">dictSetVal</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> DICT_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Low level add or find:
 * This function adds the entry but instead of setting a value returns the
 * dictEntry structure to the user, that will make sure to fill the value
 * field as he wishes.
 *
 * This function is also directly exposed to the user API to be called
 * mainly in order to store non-pointers inside the hash value, example:
 *
 * entry = dictAddRaw(dict,mykey,NULL);
 * if (entry != NULL) dictSetSignedIntegerVal(entry,1000);
 *
 * Return values:
 *
 * If key already exists NULL is returned, and &quot;*existing&quot; is populated
 * with the existing entry if existing is not NULL.
 *
 * If key was added, the hash entry is returned to be manipulated by the caller.
 */</span>
dictEntry <span class="token operator">*</span><span class="token function">dictAddRaw</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> dictEntry <span class="token operator">*</span><span class="token operator">*</span>existing<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">long</span> index<span class="token punctuation">;</span>
    dictEntry <span class="token operator">*</span>entry<span class="token punctuation">;</span>
    dictht <span class="token operator">*</span>ht<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">_dictRehashStep</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Get the index of the new element, or -1 if
     * the element already exists. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token function">_dictKeyIndex</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token function">dictHashKey</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> existing<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">/* Allocate the memory and store the new entry.
     * Insert the element in top, with the assumption that in a database
     * system it is more likely that recently added entries are accessed
     * more frequently. */</span>
    ht <span class="token operator">=</span> <span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token operator">&amp;</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token operator">&amp;</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    entry <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 新的键值对插入链表的头部 */</span>
    entry<span class="token operator">-&gt;</span>next <span class="token operator">=</span> ht<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    ht<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> entry<span class="token punctuation">;</span>
    ht<span class="token operator">-&gt;</span>used<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token comment">/* Set the hash entry fields. */</span>
    <span class="token function">dictSetKey</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> entry<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p>插入一个新的键值对的过程如下：</p> <ol><li>如果要插入的字典正在rehash，执行一步rehash（调用<code>_dictRehashStep()</code>）</li> <li>如果这个key在字典中存在，插入函数<code>dictAdd()</code>直接返回错误<code>DICT_ERR</code>；如果不存在，<code>dictAddRaw()</code>新建一个<code>dictEntry</code>结构体并插入到对应bucket链表的头部，并调用<code>dictSetKey()</code>设置<code>dictEntry</code>的key的值。其中有一个细节，当字典在rehash时，新的键值对插入到<code>ht[1].table</code>中。</li> <li>如果成功插入了一个新的<code>dictEntry</code>，<code>dictAdd()</code>调用<code>dictSetVal()</code>设置这个键值对的值。</li></ol> <p>判断key是否在字典中存在并找到索引是通过<code>_dictKeyIndex()</code>函数实现的：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* Returns the index of a free slot that can be populated with
 * a hash entry for the given 'key'.
 * If the key already exists, -1 is returned
 * and the optional output parameter may be filled.
 *
 * Note that if we are in the process of rehashing the hash table, the
 * index is always returned in the context of the second (new) hash table. */</span>
<span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">_dictKeyIndex</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> uint64_t hash<span class="token punctuation">,</span> dictEntry <span class="token operator">*</span><span class="token operator">*</span>existing<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> idx<span class="token punctuation">,</span> table<span class="token punctuation">;</span>
    dictEntry <span class="token operator">*</span>he<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>existing<span class="token punctuation">)</span> <span class="token operator">*</span>existing <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* 判断existing是否为空指针，如果是则将其指向的值设为NULL */</span>

    <span class="token comment">/* Expand the hash table if needed */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_dictExpandIfNeeded</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token operator">==</span> DICT_ERR<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>table <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> table <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> table<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        idx <span class="token operator">=</span> hash <span class="token operator">&amp;</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span>sizemask<span class="token punctuation">;</span> <span class="token comment">/* 用hash值与掩码进行与操作得出索引值 */</span>
        <span class="token comment">/* Search if this slot does not already contain the given key */</span>
        he <span class="token operator">=</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">/* 当前索引下的dictEntry */</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>he<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 遍历查找相同key的dictEntry */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token operator">==</span>he<span class="token operator">-&gt;</span>key <span class="token operator">||</span> <span class="token function">dictCompareKeys</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> key<span class="token punctuation">,</span> he<span class="token operator">-&gt;</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>existing<span class="token punctuation">)</span> <span class="token operator">*</span>existing <span class="token operator">=</span> he<span class="token punctuation">;</span> <span class="token comment">/* 如果existing不是空指针，将其指向找到的dictEntry */</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            he <span class="token operator">=</span> he<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">/* 如果没有在rehashing，则遍历ht[1] */</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> idx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p><code>existing</code> 是一个可选的输出参数，如果key存在，该指针指向找到的键值对<code>dictEntry</code>。查找的逻辑如下：</p> <ol><li>在<code>ht[0].table</code>中查找存在该key对应的索引</li> <li>如果相应的bucket不为空时，遍历的bucket中的<code>DictEntry</code>链表以查找相同key值的<code>DictEntry</code></li> <li>如果该字典在rehash中，如果没有找到还需遍历<code>ht[1].table</code></li> <li>如果找到了，<code>existing</code>不为<code>NULL</code>时将<code>existing</code>指向找到的<code>DictEntry</code>，并返回索引；没有找到则返回-1</li></ol> <p>设置键值对的key和value的值的方法<code>dictSetKey()</code>和<code>dictSetVal()</code>是宏函数：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">define</span> dictSetKey(d, entry, _key_) do { \
    if ((d)-&gt;type-&gt;keyDup) \
        (entry)-&gt;key = (d)-&gt;type-&gt;keyDup((d)-&gt;privdata, _key_); \
    else \
        (entry)-&gt;key = (_key_); \
} while(0)</span>

<span class="token macro property">#<span class="token directive keyword">define</span> dictSetVal(d, entry, _val_) do { \
    if ((d)-&gt;type-&gt;valDup) \
        (entry)-&gt;v.val = (d)-&gt;type-&gt;valDup((d)-&gt;privdata, _val_); \
    else \
        (entry)-&gt;v.val = (_val_); \
} while(0)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="删除一个键值对"><a href="#删除一个键值对" aria-hidden="true" class="header-anchor">#</a> 删除一个键值对</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* Search and remove an element. This is an helper function for
 * dictDelete() and dictUnlink(), please check the top comment
 * of those functions. */</span>
<span class="token keyword">static</span> dictEntry <span class="token operator">*</span><span class="token function">dictGenericDelete</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">int</span> nofree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uint64_t h<span class="token punctuation">,</span> idx<span class="token punctuation">;</span>
    dictEntry <span class="token operator">*</span>he<span class="token punctuation">,</span> <span class="token operator">*</span>prevHe<span class="token punctuation">;</span>
    <span class="token keyword">int</span> table<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">_dictRehashStep</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    h <span class="token operator">=</span> <span class="token function">dictHashKey</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>table <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> table <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> table<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        idx <span class="token operator">=</span> h <span class="token operator">&amp;</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span>sizemask<span class="token punctuation">;</span>
        he <span class="token operator">=</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        prevHe <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>he<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token operator">==</span>he<span class="token operator">-&gt;</span>key <span class="token operator">||</span> <span class="token function">dictCompareKeys</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> key<span class="token punctuation">,</span> he<span class="token operator">-&gt;</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/* Unlink the element from the list */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>prevHe<span class="token punctuation">)</span>
                    prevHe<span class="token operator">-&gt;</span>next <span class="token operator">=</span> he<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                    d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> he<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nofree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">dictFreeKey</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> he<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">dictFreeVal</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> he<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">zfree</span><span class="token punctuation">(</span>he<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span>used<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> he<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            prevHe <span class="token operator">=</span> he<span class="token punctuation">;</span>
            he <span class="token operator">=</span> he<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* not found */</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Remove an element, returning DICT_OK on success or DICT_ERR if the
 * element was not found. */</span>
<span class="token keyword">int</span> <span class="token function">dictDelete</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>ht<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">dictGenericDelete</span><span class="token punctuation">(</span>ht<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> DICT_OK <span class="token punctuation">:</span> DICT_ERR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>删除一个键值对的过程比较简单，就是找到相应的key，将从链表中删除这个<code>DictEntry</code>并调用<code>dictFreeKey()</code>，<code>dictFreeVal()</code>和<code>zfree()</code>回收内存。同时还要对哈希表的<code>used</code>成员执行自减操作。</p> <h4 id="修改一个键值对的值"><a href="#修改一个键值对的值" aria-hidden="true" class="header-anchor">#</a> 修改一个键值对的值</h4> <p>实现了上述操作后，修改一个键值对变得简单的多。调用<code>dictAddRaw()</code>找到相应的<code>dictEntry</code>，设置新的值并回收旧值占用的内存。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* Add or Overwrite:
 * Add an element, discarding the old value if the key already exists.
 * Return 1 if the key was added from scratch, 0 if there was already an
 * element with such key and dictReplace() just performed a value update
 * operation. */</span>
<span class="token keyword">int</span> <span class="token function">dictReplace</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>val<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    dictEntry <span class="token operator">*</span>entry<span class="token punctuation">,</span> <span class="token operator">*</span>existing<span class="token punctuation">,</span> auxentry<span class="token punctuation">;</span>

    <span class="token comment">/* Try to add the element. If the key
     * does not exists dictAdd will succeed. */</span>
    entry <span class="token operator">=</span> <span class="token function">dictAddRaw</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token operator">&amp;</span>existing<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dictSetVal</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Set the new value and free the old one. Note that it is important
     * to do that in this order, as the value may just be exactly the same
     * as the previous one. In this context, think to reference counting,
     * you want to increment (set), and then decrement (free), and not the
     * reverse. */</span>
    auxentry <span class="token operator">=</span> <span class="token operator">*</span>existing<span class="token punctuation">;</span>
    <span class="token function">dictSetVal</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> existing<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dictFreeVal</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token operator">&amp;</span>auxentry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h4 id="根据key查找"><a href="#根据key查找" aria-hidden="true" class="header-anchor">#</a> 根据key查找</h4> <p>根据key查找<code>dictEnty</code>的方法<code>dictFind()</code>类似于前面提到的<code>_dictKeyIndex()</code>。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>dictEntry <span class="token operator">*</span><span class="token function">dictFind</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    dictEntry <span class="token operator">*</span>he<span class="token punctuation">;</span>
    uint64_t h<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> table<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">+</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* dict is empty */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">_dictRehashStep</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    h <span class="token operator">=</span> <span class="token function">dictHashKey</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>table <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> table <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> table<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        idx <span class="token operator">=</span> h <span class="token operator">&amp;</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span>sizemask<span class="token punctuation">;</span>
        he <span class="token operator">=</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>he<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token operator">==</span>he<span class="token operator">-&gt;</span>key <span class="token operator">||</span> <span class="token function">dictCompareKeys</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> key<span class="token punctuation">,</span> he<span class="token operator">-&gt;</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> he<span class="token punctuation">;</span>
            he <span class="token operator">=</span> he<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="迭代器"><a href="#迭代器" aria-hidden="true" class="header-anchor">#</a> 迭代器</h3> <p>当字典中的键值对数量很大时，可能会使用迭代器分配遍历值（<code>hscan</code>或者<code>scan</code>遍历redis中的所有键）。redis字典的迭代器分为两种，一种是safe迭代器另一种是unsafe迭代器，safe迭代器在迭代的过程中用户可以对该dict进行CURD操作，unsafe迭代器在迭代过程中用户只能对该dict执行迭代操作。</p> <p>当对字典执行safe迭代时会停止rehash操作以免扰乱迭代器的迭代。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_dictRehashStep</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-&gt;</span>iterators <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">dictRehash</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>unsafe迭代器在执行迭代过程中不允许对字典进行其他操作，通过计算指纹来判断字典是否发生了变化，若不一致，则结束进程。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* A fingerprint is a 64 bit number that represents the state of the dictionary
 * at a given time, it's just a few dict properties xored together.
 * When an unsafe iterator is initialized, we get the dict fingerprint, and check
 * the fingerprint again when the iterator is released.
 * If the two fingerprints are different it means that the user of the iterator
 * performed forbidden operations against the dictionary while iterating. */</span>
<span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token function">dictFingerprint</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> integers<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> hash <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> j<span class="token punctuation">;</span>

    integers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">;</span>
    integers<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">;</span>
    integers<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used<span class="token punctuation">;</span>
    integers<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">;</span>
    integers<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">;</span>
    integers<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used<span class="token punctuation">;</span>

    <span class="token comment">/* We hash N integers by summing every successive integer with the integer
     * hashing of the previous sum. Basically:
     *
     * Result = hash(hash(hash(int1)+int2)+int3) ...
     *
     * This way the same set of integers in a different order will (likely) hash
     * to a different number. */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hash <span class="token operator">+</span><span class="token operator">=</span> integers<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">/* For the hashing step we use Tomas Wang's 64 bit integer hash. */</span>
        hash <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">~</span>hash<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>hash <span class="token operator">&lt;&lt;</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hash = (hash &lt;&lt; 21) - hash - 1;</span>
        hash <span class="token operator">=</span> hash <span class="token operator">^</span> <span class="token punctuation">(</span>hash <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hash <span class="token operator">=</span> <span class="token punctuation">(</span>hash <span class="token operator">+</span> <span class="token punctuation">(</span>hash <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>hash <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hash * 265</span>
        hash <span class="token operator">=</span> hash <span class="token operator">^</span> <span class="token punctuation">(</span>hash <span class="token operator">&gt;&gt;</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hash <span class="token operator">=</span> <span class="token punctuation">(</span>hash <span class="token operator">+</span> <span class="token punctuation">(</span>hash <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>hash <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hash * 21</span>
        hash <span class="token operator">=</span> hash <span class="token operator">^</span> <span class="token punctuation">(</span>hash <span class="token operator">&gt;&gt;</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hash <span class="token operator">=</span> hash <span class="token operator">+</span> <span class="token punctuation">(</span>hash <span class="token operator">&lt;&lt;</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> hash<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h5 id="dictscan迭代"><a href="#dictscan迭代" aria-hidden="true" class="header-anchor">#</a> dictScan迭代</h5> <p>safe迭代器和unsafe迭代器的前提都是不能rehash，要通过这两种迭代的方式遍历所有节点会停止该dict的被动rehash，阻止了rehash的正常进行。<code>dictScan()</code>可以在不停止rehash的前提下遍历到所有dictEntry节点，尽管会有非常小的可能性出现重复的键值对。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* dictScan() is used to iterate over the elements of a dictionary.
 *
 * Iterating works the following way:
 *
 * 1) Initially you call the function using a cursor (v) value of 0.
 * 2) The function performs one step of the iteration, and returns the
 *    new cursor value you must use in the next call.
 * 3) When the returned cursor is 0, the iteration is complete.
 *
 * The function guarantees all elements present in the
 * dictionary get returned between the start and end of the iteration.
 * However it is possible some elements get returned multiple times.
 *
 * For every element returned, the callback argument 'fn' is
 * called with 'privdata' as first argument and the dictionary entry
 * 'de' as second argument.
 *
 * HOW IT WORKS.
 *
 * The iteration algorithm was designed by Pieter Noordhuis.
 * The main idea is to increment a cursor starting from the higher order
 * bits. That is, instead of incrementing the cursor normally, the bits
 * of the cursor are reversed, then the cursor is incremented, and finally
 * the bits are reversed again.
 *
 * This strategy is needed because the hash table may be resized between
 * iteration calls.
 *
 * dict.c hash tables are always power of two in size, and they
 * use chaining, so the position of an element in a given table is given
 * by computing the bitwise AND between Hash(key) and SIZE-1
 * (where SIZE-1 is always the mask that is equivalent to taking the rest
 *  of the division between the Hash of the key and SIZE).
 *
 * For example if the current hash table size is 16, the mask is
 * (in binary) 1111. The position of a key in the hash table will always be
 * the last four bits of the hash output, and so forth.
 *
 * WHAT HAPPENS IF THE TABLE CHANGES IN SIZE?
 *
 * If the hash table grows, elements can go anywhere in one multiple of
 * the old bucket: for example let's say we already iterated with
 * a 4 bit cursor 1100 (the mask is 1111 because hash table size = 16).
 *
 * If the hash table will be resized to 64 elements, then the new mask will
 * be 111111. The new buckets you obtain by substituting in ??1100
 * with either 0 or 1 can be targeted only by keys we already visited
 * when scanning the bucket 1100 in the smaller hash table.
 *
 * By iterating the higher bits first, because of the inverted counter, the
 * cursor does not need to restart if the table size gets bigger. It will
 * continue iterating using cursors without '1100' at the end, and also
 * without any other combination of the final 4 bits already explored.
 *
 * Similarly when the table size shrinks over time, for example going from
 * 16 to 8, if a combination of the lower three bits (the mask for size 8
 * is 111) were already completely explored, it would not be visited again
 * because we are sure we tried, for example, both 0111 and 1111 (all the
 * variations of the higher bit) so we don't need to test it again.
 *
 * WAIT... YOU HAVE *TWO* TABLES DURING REHASHING!
 *
 * Yes, this is true, but we always iterate the smaller table first, then
 * we test all the expansions of the current cursor into the larger
 * table. For example if the current cursor is 101 and we also have a
 * larger table of size 16, we also test (0)101 and (1)101 inside the larger
 * table. This reduces the problem back to having only one table, where
 * the larger one, if it exists, is just an expansion of the smaller one.
 *
 * LIMITATIONS
 *
 * This iterator is completely stateless, and this is a huge advantage,
 * including no additional memory used.
 *
 * The disadvantages resulting from this design are:
 *
 * 1) It is possible we return elements more than once. However this is usually
 *    easy to deal with in the application level.
 * 2) The iterator must return multiple elements per call, as it needs to always
 *    return all the keys chained in a given bucket, and all the expansions, so
 *    we are sure we don't miss keys moving during rehashing.
 * 3) The reverse cursor is somewhat hard to understand at first, but this
 *    comment is supposed to help.
 */</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">dictScan</span><span class="token punctuation">(</span>dict <span class="token operator">*</span>d<span class="token punctuation">,</span>
                       <span class="token keyword">unsigned</span> <span class="token keyword">long</span> v<span class="token punctuation">,</span>
                       dictScanFunction <span class="token operator">*</span>fn<span class="token punctuation">,</span>
                       dictScanBucketFunction<span class="token operator">*</span> bucketfn<span class="token punctuation">,</span>
                       <span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    dictht <span class="token operator">*</span>t0<span class="token punctuation">,</span> <span class="token operator">*</span>t1<span class="token punctuation">;</span>
    <span class="token keyword">const</span> dictEntry <span class="token operator">*</span>de<span class="token punctuation">,</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> m0<span class="token punctuation">,</span> m1<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictSize</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        t0 <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m0 <span class="token operator">=</span> t0<span class="token operator">-&gt;</span>sizemask<span class="token punctuation">;</span>

        <span class="token comment">/* Emit entries at cursor */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bucketfn<span class="token punctuation">)</span> <span class="token function">bucketfn</span><span class="token punctuation">(</span>privdata<span class="token punctuation">,</span> <span class="token operator">&amp;</span>t0<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>v <span class="token operator">&amp;</span> m0<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        de <span class="token operator">=</span> t0<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>v <span class="token operator">&amp;</span> m0<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>de<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            next <span class="token operator">=</span> de<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
            <span class="token function">fn</span><span class="token punctuation">(</span>privdata<span class="token punctuation">,</span> de<span class="token punctuation">)</span><span class="token punctuation">;</span>
            de <span class="token operator">=</span> next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* Set unmasked bits so incrementing the reversed cursor
         * operates on the masked bits */</span>
        v <span class="token operator">|</span><span class="token operator">=</span> <span class="token operator">~</span>m0<span class="token punctuation">;</span>

        <span class="token comment">/* Increment the reverse cursor */</span>
        v <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
        v<span class="token operator">++</span><span class="token punctuation">;</span>
        v <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        t0 <span class="token operator">=</span> <span class="token operator">&amp;</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        t1 <span class="token operator">=</span> <span class="token operator">&amp;</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">/* Make sure t0 is the smaller and t1 is the bigger table */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t0<span class="token operator">-&gt;</span>size <span class="token operator">&gt;</span> t1<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            t0 <span class="token operator">=</span> <span class="token operator">&amp;</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            t1 <span class="token operator">=</span> <span class="token operator">&amp;</span>d<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        m0 <span class="token operator">=</span> t0<span class="token operator">-&gt;</span>sizemask<span class="token punctuation">;</span>
        m1 <span class="token operator">=</span> t1<span class="token operator">-&gt;</span>sizemask<span class="token punctuation">;</span>

        <span class="token comment">/* Emit entries at cursor */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bucketfn<span class="token punctuation">)</span> <span class="token function">bucketfn</span><span class="token punctuation">(</span>privdata<span class="token punctuation">,</span> <span class="token operator">&amp;</span>t0<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>v <span class="token operator">&amp;</span> m0<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        de <span class="token operator">=</span> t0<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>v <span class="token operator">&amp;</span> m0<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>de<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            next <span class="token operator">=</span> de<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
            <span class="token function">fn</span><span class="token punctuation">(</span>privdata<span class="token punctuation">,</span> de<span class="token punctuation">)</span><span class="token punctuation">;</span>
            de <span class="token operator">=</span> next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* Iterate over indices in larger table that are the expansion
         * of the index pointed to by the cursor in the smaller table */</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token comment">/* Emit entries at cursor */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bucketfn<span class="token punctuation">)</span> <span class="token function">bucketfn</span><span class="token punctuation">(</span>privdata<span class="token punctuation">,</span> <span class="token operator">&amp;</span>t1<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>v <span class="token operator">&amp;</span> m1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            de <span class="token operator">=</span> t1<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>v <span class="token operator">&amp;</span> m1<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>de<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                next <span class="token operator">=</span> de<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
                <span class="token function">fn</span><span class="token punctuation">(</span>privdata<span class="token punctuation">,</span> de<span class="token punctuation">)</span><span class="token punctuation">;</span>
                de <span class="token operator">=</span> next<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/* Increment the reverse cursor not covered by the smaller mask.*/</span>
            v <span class="token operator">|</span><span class="token operator">=</span> <span class="token operator">~</span>m1<span class="token punctuation">;</span>
            v <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
            v<span class="token operator">++</span><span class="token punctuation">;</span>
            v <span class="token operator">=</span> <span class="token function">rev</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/* Continue while bits covered by mask difference is non-zero */</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>v <span class="token operator">&amp;</span> <span class="token punctuation">(</span>m0 <span class="token operator">^</span> m1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> v<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br></div></div><h3 id="编译测试-3"><a href="#编译测试-3" aria-hidden="true" class="header-anchor">#</a> 编译测试</h3> <p>Redis字典依赖于SDS，可以通过下面的方法编译测试。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>gcc -DDICT_BENCHMARK_MAIN -o dict dict.c sds.c zmalloc.c siphash.c 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="跳跃表"><a href="#跳跃表" aria-hidden="true" class="header-anchor">#</a> 跳跃表</h2> <p>跳跃表（skiplist）是一种有序链表扩展， 通过在每个节点中维持多个指向其他节点的指针， 来达到快速访问节点的目的。跳跃表的原理可以看这篇<a href="https://www.cnblogs.com/thrillerz/p/4505550.html" target="_blank" rel="noopener noreferrer">文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。跳跃表支持平均 O(log N) 最坏 O(N) 复杂度的节点查找， 还可以通过顺序性操作来批量处理节点。</p> <blockquote><p>相关源文件：<a href="https://github.com/antirez/redis/blob/5.0/src/dict.h" target="_blank" rel="noopener noreferrer">server.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/antirez/redis/blob/5.0/src/t_zset.c" target="_blank" rel="noopener noreferrer">t_zset.c<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>Redis的跳跃表的结构定义如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* ZSETs use a specialized version of Skiplists */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> zskiplistNode <span class="token punctuation">{</span>
    sds ele<span class="token punctuation">;</span>
    <span class="token keyword">double</span> score<span class="token punctuation">;</span>                           <span class="token comment">/* 分值，跳跃表中的节点按各自的分值从小到大排列 */</span>
    <span class="token keyword">struct</span> zskiplistNode <span class="token operator">*</span>backward<span class="token punctuation">;</span>         <span class="token comment">/* 后退指针 */</span>
    <span class="token keyword">struct</span> zskiplistLevel <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> zskiplistNode <span class="token operator">*</span>forward<span class="token punctuation">;</span>      <span class="token comment">/* 前进指针 */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> span<span class="token punctuation">;</span>                  <span class="token comment">/* 跨度，前进指针所指向节点和当前节点的距离 */</span>
    <span class="token punctuation">}</span> level<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                              <span class="token comment">/* 层 */</span>
<span class="token punctuation">}</span> zskiplistNode<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> zskiplist <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> zskiplistNode <span class="token operator">*</span>header<span class="token punctuation">,</span> <span class="token operator">*</span>tail<span class="token punctuation">;</span> <span class="token comment">/* 跳跃表的头尾指针 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> length<span class="token punctuation">;</span>                <span class="token comment">/* 跳跃表的长度 */</span>
    <span class="token keyword">int</span> level<span class="token punctuation">;</span>                           <span class="token comment">/* 目前跳跃表内，层数最大的那个节点的层数（表头节点不计算在内）*/</span>
<span class="token punctuation">}</span> zskiplist<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> zset <span class="token punctuation">{</span>
    dict <span class="token operator">*</span>dict<span class="token punctuation">;</span>
    zskiplist <span class="token operator">*</span>zsl<span class="token punctuation">;</span>
<span class="token punctuation">}</span> zset<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>Redis的<code>zset</code>结构体中包含了<code>dict</code>和<code>zskiplist</code>两个成员，字典可以快速的定位一个member是否存在<code>zset</code>中，跳跃表可以快速查得member的排行和分数。结合两者的优势使得性能更优。</p> <p>示意图如下：</p> <p><img src="/assets/img/redis_skiplist.67948baf.png" alt="跳跃表"></p> <p>最右边是<code>zskiplist</code>结构：</p> <ul><li>header ：指向跳跃表的表头节点，表头节点比较特殊，它定义了跳跃表的最大层数，level和legnth的计算都不包含它</li> <li>tail ：指向跳跃表的表尾节点</li> <li>level ：记录目前跳跃表内，层数最大的那个节点的层数</li> <li>length ：记录跳跃表的长度，也即是，跳跃表目前包含节点的数量</li></ul> <p><code>zskiplist</code>右边是4个<code>zskiplistNode</code>结构体，每个结构体都包含四个成员：</p> <ul><li>层（level）：每个层都带有两个属性：前进指针和跨度。前进指针用于访问位于表尾方向的其他节点，而跨度则记录了前进指针所指向节点和当前节点的距离。</li> <li>后退（backward）指针：后退指针在程序从表尾向表头遍历时使用。</li> <li>分值（score）：在跳跃表中，节点按各自所保存的分值从小到大排列。</li> <li>成员对象（obj）：各个节点中的 o1 、 o2 和 o3 是节点所保存的成员对象。</li></ul> <h2 id="整数集合"><a href="#整数集合" aria-hidden="true" class="header-anchor">#</a> 整数集合</h2> <p>整数集合是redis用来保存整数集合的结构体。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> intset <span class="token punctuation">{</span>
    uint32_t encoding<span class="token punctuation">;</span>  <span class="token comment">/* 编码方式 */</span>
    uint32_t length<span class="token punctuation">;</span>    <span class="token comment">/* 集合包含的元素数目 */</span>
    int8_t contents<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">/* 保存元素的数组。虽然声明为int8_t类型的数组，但实际上并不保存该类型的值，数组类型取决于encoding属性的值 */</span>
<span class="token punctuation">}</span> intset<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>和之前的<code>SDSHDR</code>结构体一样，最后的成员<code>contents</code>的元素个数没有定义。<code>encoding</code>表示编码方式，<code>length</code>表示集合包含的元素数目，<code>contents</code>指向真正的数据所在的地址。</p> <p><img src="/assets/img/redis_inset.12613d06.png" alt="整数集合"></p> <p>上图展示的是一个包含4个整数的集合，集合元素类型是<code>int16_t</code>，<code>contents</code>数组的大小等于<code>sizeof(int16_t) * 5 = 16 * 5 = 80</code>位。</p> <h3 id="整数集合的基本操作"><a href="#整数集合的基本操作" aria-hidden="true" class="header-anchor">#</a> 整数集合的基本操作</h3> <p><code>intsetResize()</code>函数用来对现有的整数集合升级。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* Resize the intset */</span>
<span class="token keyword">static</span> intset <span class="token operator">*</span><span class="token function">intsetResize</span><span class="token punctuation">(</span>intset <span class="token operator">*</span>is<span class="token punctuation">,</span> uint32_t len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uint32_t size <span class="token operator">=</span> len<span class="token operator">*</span><span class="token function">intrev32ifbe</span><span class="token punctuation">(</span>is<span class="token operator">-&gt;</span>encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
    is <span class="token operator">=</span> <span class="token function">zrealloc</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>intset<span class="token punctuation">)</span><span class="token operator">+</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/*  realloc函数用于修改一个原先已经分配的内存块的大小，可以使一块内存的扩大或缩小。 */</span>
    <span class="token keyword">return</span> is<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>升级集合到新的大小时，先计算升级后的<code>content</code>后面的存储空间（编码*元素个数），加上<code>intset</code>结构体的大小作为升级后的整数集合大小。当插入一个大值时，需要将整数集合升级到更大的编码，<code>intsetUpgradeAndAdd()</code>实现了整数集合的插入升级。</p> <div class="language-c line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br></div><pre class="language-c"><code><span class="token comment">/* Upgrades the intset to a larger encoding and inserts the given integer. */</span>
<span class="token keyword">static</span> intset <span class="token operator">*</span><span class="token function">intsetUpgradeAndAdd</span><span class="token punctuation">(</span>intset <span class="token operator">*</span>is<span class="token punctuation">,</span> int64_t value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uint8_t curenc <span class="token operator">=</span> <span class="token function">intrev32ifbe</span><span class="token punctuation">(</span>is<span class="token operator">-&gt;</span>encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
    uint8_t newenc <span class="token operator">=</span> <span class="token function">_intsetValueEncoding</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> length <span class="token operator">=</span> <span class="token function">intrev32ifbe</span><span class="token punctuation">(</span>is<span class="token operator">-&gt;</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> prepend <span class="token operator">=</span> value <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/* First set new encoding and resize */</span>
    is<span class="token operator">-&gt;</span>encoding <span class="token operator">=</span> <span class="token function">intrev32ifbe</span><span class="token punctuation">(</span>newenc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    is <span class="token operator">=</span> <span class="token function">intsetResize</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span><span class="token function">intrev32ifbe</span><span class="token punctuation">(</span>is<span class="token operator">-&gt;</span>length<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Upgrade back-to-front so we don't overwrite values.
     * Note that the &quot;prepend&quot; variable is used to make sure we have an empty
     * space at either the beginning or the end of the intset. */</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>length<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token comment">/* 从后往前写，这样就不会覆盖数据 */</span>
        <span class="token function">_intsetSet</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span>length<span class="token operator">+</span>prepend<span class="token punctuation">,</span><span class="token function">_intsetGetEncoded</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span>length<span class="token punctuation">,</span>curenc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Set the value at the beginning or the end. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prepend<span class="token punctuation">)</span>
        <span class="token function">_intsetSet</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">_intsetSet</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span><span class="token function">intrev32ifbe</span><span class="token punctuation">(</span>is<span class="token operator">-&gt;</span>length<span class="token punctuation">)</span><span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    is<span class="token operator">-&gt;</span>length <span class="token operator">=</span> <span class="token function">intrev32ifbe</span><span class="token punctuation">(</span><span class="token function">intrev32ifbe</span><span class="token punctuation">(</span>is<span class="token operator">-&gt;</span>length<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> is<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p><code>_intsetValueEncoding()</code>通过将<code>value</code>和<code>INT32_MIN</code>,<code>INT32_MAX</code>等比较计算出升级后的编码类型，之后调整集合的大小。调整之后需要对当前存储的数值进行类型转换并重写到相应的内存中，<code>_intsetSet()</code>方法就是用来根据整数集合的编码类型来写值。redis在对整数集合升级时，采取的是从后往前写的策略，这样先重写的数据不会覆盖还未重写的数据。</p> <p>从整数集合中删除一个元素比较简单，先判断要删除的元素是不是小于集合类型的最大值，如果是则在整数集合中找到该元素的位置。假设找到要删除的元素的位置是<code>pos</code>，redis要做的是将<code>pos+1</code>及其后面的元素往前移，这样就是覆盖了<code>pos</code>的值，最后对整数集合的大小进行调整<code>intsetResize()</code>。</p> <div class="language-c line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-c"><code><span class="token comment">/* Delete integer from intset */</span>
intset <span class="token operator">*</span><span class="token function">intsetRemove</span><span class="token punctuation">(</span>intset <span class="token operator">*</span>is<span class="token punctuation">,</span> int64_t value<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uint8_t valenc <span class="token operator">=</span> <span class="token function">_intsetValueEncoding</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    uint32_t pos<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token operator">*</span>success <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>valenc <span class="token operator">&lt;=</span> <span class="token function">intrev32ifbe</span><span class="token punctuation">(</span>is<span class="token operator">-&gt;</span>encoding<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">intsetSearch</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span>value<span class="token punctuation">,</span><span class="token operator">&amp;</span>pos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        uint32_t len <span class="token operator">=</span> <span class="token function">intrev32ifbe</span><span class="token punctuation">(</span>is<span class="token operator">-&gt;</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* We know we can delete */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token operator">*</span>success <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token comment">/* Overwrite value with tail and update length */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;</span> <span class="token punctuation">(</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">intsetMoveTail</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span>pos<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        is <span class="token operator">=</span> <span class="token function">intsetResize</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        is<span class="token operator">-&gt;</span>length <span class="token operator">=</span> <span class="token function">intrev32ifbe</span><span class="token punctuation">(</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> is<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>整数集合的值是按照从小到大的顺序排列的，因此可以通过二分法来快速查询值的位置。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>
<span class="token comment">/* Search for the position of &quot;value&quot;. Return 1 when the value was found and
 * sets &quot;pos&quot; to the position of the value within the intset. Return 0 when
 * the value is not present in the intset and sets &quot;pos&quot; to the position
 * where &quot;value&quot; can be inserted. */</span>
<span class="token keyword">static</span> uint8_t <span class="token function">intsetSearch</span><span class="token punctuation">(</span>intset <span class="token operator">*</span>is<span class="token punctuation">,</span> int64_t value<span class="token punctuation">,</span> uint32_t <span class="token operator">*</span>pos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> min <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> max <span class="token operator">=</span> <span class="token function">intrev32ifbe</span><span class="token punctuation">(</span>is<span class="token operator">-&gt;</span>length<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> mid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    int64_t cur <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">/* The value can never be found when the set is empty */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">intrev32ifbe</span><span class="token punctuation">(</span>is<span class="token operator">-&gt;</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pos<span class="token punctuation">)</span> <span class="token operator">*</span>pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Check for the case where we know we cannot find the value,
         * but do know the insert position. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&gt;</span> <span class="token function">_intsetGet</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span>max<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pos<span class="token punctuation">)</span> <span class="token operator">*</span>pos <span class="token operator">=</span> <span class="token function">intrev32ifbe</span><span class="token punctuation">(</span>is<span class="token operator">-&gt;</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&lt;</span> <span class="token function">_intsetGet</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pos<span class="token punctuation">)</span> <span class="token operator">*</span>pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>max <span class="token operator">&gt;=</span> min<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>min <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>max<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
        cur <span class="token operator">=</span> <span class="token function">_intsetGet</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span>mid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&gt;</span> cur<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            min <span class="token operator">=</span> mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&lt;</span> cur<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            max <span class="token operator">=</span> mid<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> cur<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pos<span class="token punctuation">)</span> <span class="token operator">*</span>pos <span class="token operator">=</span> mid<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pos<span class="token punctuation">)</span> <span class="token operator">*</span>pos <span class="token operator">=</span> min<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h2 id="压缩列表"><a href="#压缩列表" aria-hidden="true" class="header-anchor">#</a> 压缩列表</h2> <blockquote><p>相关源文件：<a href="https://github.com/antirez/redis/blob/5.0/src/ziplist.h" target="_blank" rel="noopener noreferrer">ziplist.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/antirez/redis/blob/5.0/src/ziplist.c" target="_blank" rel="noopener noreferrer">ziplist.c<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/antirez/redis/blob/5.0/src/zmalloc.c" target="_blank" rel="noopener noreferrer">zmalloc.c<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>,<a href="https://github.com/antirez/redis/blob/5.0/src/zmalloc.h" target="_blank" rel="noopener noreferrer">zmalloc.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>当一个列表键只包含少量列表项， 并且每个列表项小整数值，或者长度比较短的字符串时，redis会采用压缩列表来作为列表键的底层实现。当一个哈希键只包含少量键值对， 并且每个键值对的键和值是小整数值， 或者长度比较短的字符串时，redis会采用压缩列表来作为哈希键的底层实现。</p> <p>压缩列表时redis为了节省内存开发的一种顺序编码的列表。它可以同时存储整数或者字符串，因为每次操作都需要对内存进行重新分配，因此实际的复杂度和内存的使用量相关。</p> <p>压缩列表的结构如下：
<img src="data:image/png;base64,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IAESIAESIIFIAjQUItHwBAmQAAmQAAmQAA0F6gAJkAAJkAAJkEAkARoKkWh4ggRIgARIgARIgIYCdYAESIAESIAESCCSQKaGwr///isvvviinH766fL000/bTP7+++/y2GOPif4v9chM17cTYZzqwuDzzz+XY445Rr7++mubTNrp1yVvYXkJC6vLPXjtfwTwrP3999//BdTjX2+88YZcdNFFMnLkSHn77bfrMYnSKvrzzz8vDzzwgP28//77NTL3yy+/eOddvEWLFtWIV4yAYrdV6C+feOIJGTZsWEGLl6mhMH36dBk/frxcd9118u2339qCTpw4UQYNGmQrvqAlL6PEwzjVJfvvvfee3HnnnYJ0IWmnX5e8heUlLKwu9+C1Ik899ZRsscUWst9++8lff/1V75Gceuqpstdee9nn4vzzz5cePXrIFVdcUe+5lAKAbbfdVmbNmiWHHXaY7LjjjjJnzpxq2VpllVWkU6dOcvnll8ull14qbdq0kRYtWlSLU6yDYrdVzz77rAwZMkQefPDBghYxU0Nh8803l5NOOqlaAY866ijbgFULrOPB3XffXccUsr08jJPL0cKFCwXKkkQOOuggwXV77rmnvSxX+knSTSNuWF7CwtK4V7mkkbb+fvXVV7LxxhtLx44dywVBjXymyeSRRx6Rhg0byk8//SRffPGFTJ48WVZddVU577zzBN43SnICadbPiiuuaD3MTZo0kcWLF1vj9rfffvMy1aBBA0EbcfDBB9tP7969BWFZSLHbKrTlW221lTRu3Ligxc3UUEDJXAH9FduoUaPUKvrll1+Wc889t6AQi5F4GKeqqiprZaNxSyqrrbZatUvC0q8WoYgHYXkJCytiljK7VSH0d9111xV82rZtm1m56nLjtJlMnTpVrrrqKnHtzs4772w7nKVLl8q0adPqktV6eW3a9eMgtm/fXnbbbTeZOXOmDBgwQIwx7pT9btmypTXwqgVmcFDstgpGLj6FlMKaIZrze+65R9ChBQUjmu7duweDaxxj3vC5556TTTbZRA488EB7HpY/5mUgMDBwbrPNNpM//vhDJk2aJJgngosKo4F9993Xxrn11ltlzTXXlH322cdeh6kOjMQxTw/XFhoHvyxYsMC6Z/G9wQYbWIt1/fXX90dJ9XdSTv/8848cfvjhdvTTqlUrW8a+fftatxtcya+88opgigGN35FHHilrrbWWl99ly5bJq6++KiuttJJsueWWXngxfsA19+6779a4FerxiCOOsPmtcbKWAIwA33rrLdtIYFSBBgOChh6NFh6ibbbZxurM7Nmz5ZBDDinKaDqXjsXJG/Iepr+Yf8Vc7IknnijPPPOMfPTRR1b/3fRd06ZN5YADDhB8Y679k08+sWyQVtZSTCbwToIPJFc7MXTo0Bp6t/fee8stt9xSEh1Psess6nlCPubPny/wwJxyyilWr7DGBUYn2iI8Z1E6i2vRli9ZskQ6d+4sd911l9XZb775Bqdy1s96661n46ADhosdbRbaeUwzXHDBBfYc/hSjw8R9krbVuAZSV93//1REfv75Z8EUPQaImD6EweQfaLt4aX4X1gzRnF577bV2vgguGXTmmPdDA7fyyivnLAc6QnTql112mUyYMEHgYkGHB0FHAKU4+uij7WJIpAuBi8p1glBeuA9hRKDBxBzWOuusY+NBmbFoCddBadGA+qdAsDgG85X9+vWTM8880z4Y6HQLKUk5YQHaHnvsYbMEIwDla9asmWBxS4cOHezvs88+23aWMITcPDQ6DXSmO+20U2iHXcgyIm00LJ999pnlDp349ddfbT2+9tprNRrr2vKCRufYY4+VH3/8UdCwo1433HBD24ChM4W+YASC9RiIh5HjzTffLL1797YPW23p1+V8Lh2Lm7cw/UUDu/baawvm1G+88UY555xzBPWMeVqMivFMbL311lbnkX+4JUeNGmV516U8aVxbbCY//PBDrHZi9dVXr1E8dIjgj7UK9UVyPU9ggMEZBnennXaaXH/99XLNNdfIm2++aUf30DFImM5++eWX0qdPHzsge/TRR+W4446zUwkwxOK04zbh//1B+jAS0NZfeOGF8uSTT/pPF+V30rYamUpD95EOBjpo9zHQvuSSS2zbBx6FNhRgjcQWXXgIX0/s+IioDZsXf8yYMfZ6bdC8sI8//tiG3X777V6YKpXR+SijC1hsmHb+RjtzG093R3jxtKMxam0a9SB4YSeccIL58MMPvWNdrGXUQPCOdW7LqGfAaIfqhQ0cONCmrR2JDbvhhhvMDjvs4J1Xz4S5//77vePafsybN8+mp27L2qJ65/Ph9MEHH9j7jBs3zkvn3nvvNfrwme+//96GuTg6svTi6AjUXqcPqhcWVg/eyRw/dIW4UcMkR4zq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" alt="压缩列表的结构"></p> <p>节点结构如下：
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAW4AAAA6CAYAAACQyrPaAAAKxGlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWQO976Y0WCB1Cb4J0AkgJPXTpYCMkgYQSQkJQsSODIzgWRERAGdFBEQVHpchYEAu2QbCBik6QQUX9DhZsqPwHDGHm//X/X/+8ddbd77xzzzn3rnvXOg8ACp4tEmXCSgBkCXPFUYE+9ITEJDpuCEDIQwDqgMjmSETMyMhQgMjM+Hd5fxfxReSW9WSsf//+X0WZy5NwAIAiEU7hSjhZCJ9A9BVHJM4FALUfsRstzRVN8mWEVcVIgQgPTHLaNI9OcsoUo9FTPjFRvghrAIAns9niNADIxoidnsdJQ+KQ/RC2FXIFQoSRd+DJ4bO5CCN5wZysrOxJliFsnvKXOGl/i5kij8lmp8l5ei1TgvcTSESZ7OX/53b8b8nKlM7kMEWUzBcHRSEjDdmz/ozsEDkLU8IjZljAnfKfYr40KHaGORLfpBnmsv1C5HMzw0NnOFUQwJLHyWXFzDBP4h89w+LsKHmuVLEvc4bZ4tm80oxYuZ3PY8nj5/Nj4mc4TxAXPsOSjOiQWR9fuV0sjZLXzxMG+szmDZCvPUvyl/UKWPK5ufyYIPna2bP184TM2ZiSBHltXJ6f/6xPrNxflOsjzyXKjJT78zID5XZJXrR8bi5yIGfnRsr3MJ0dHDnDwA/4g1DkoYNIYA8cgR1gIDaQy1s2eUaBb7ZouViQxs+lM5FbxqOzhBybOXR7WztXACbv7PSReNs/dRchGn7Wlk0GwPkJAp2zNvbvALSt/vM6/WkzQXyUqgE4/YkjFedN2yavE8AAIlAEqkAT6AEjYA6skfqcgTvwRioOBhEgBiSCxYAD+CALiMFSsBKsA0WgBGwFO0AlqAH7wEFwBBwDreAUOAcugWugB9wBD4AMDIMXYBS8B+MQBOEgCkSFNCF9yASyguwhBuQJ+UOhUBSUCCVDaZAQkkIrofVQCVQKVUJ7oXroZ+gkdA66AvVC96BBaAR6A32GUTAZVoV1YVN4LsyAmXAIHAMvgtPgHDgfLoQ3wxVwLXwYboHPwdfgO7AMfgGPoQCKhKKhDFDWKAbKFxWBSkKlosSo1ahiVDmqFtWIakd1oW6hZKiXqE9oLJqKpqOt0e7oIHQsmoPOQa9Gb0JXog+iW9AX0LfQg+hR9DcMBaODscK4YViYBEwaZimmCFOOqcM0Yy5i7mCGMe+xWCwNa4Z1wQZhE7Hp2BXYTdjd2CZsB7YXO4Qdw+FwmjgrnAcuAsfG5eKKcLtwh3FncTdxw7iPeBJeH2+PD8An4YX4Anw5/hD+DP4m/il+nKBEMCG4ESIIXMJywhbCfkI74QZhmDBOVCaaET2IMcR04jpiBbGReJE4QHxLIpEMSa6k+SQBaS2pgnSUdJk0SPpEViFbkn3JC8lS8mbyAXIH+R75LYVCMaV4U5IouZTNlHrKecojykcFqoKNAkuBq7BGoUqhReGmwitFgqKJIlNxsWK+YrniccUbii+VCEqmSr5KbKXVSlVKJ5X6lMaUqcp2yhHKWcqblA8pX1F+poJTMVXxV+GqFKrsUzmvMkRFUY2ovlQOdT11P/UidVgVq2qmylJNVy1RPaLarTqqpqLmqBantkytSu20moyGopnSWLRM2hbaMdpd2md1XXWmOk99o3qj+k31DxraGt4aPI1ijSaNOxqfNema/poZmts0WzUfaqG1LLXmay3V2qN1Ueultqq2uzZHu1j7mPZ9HVjHUidKZ4XOPp3rOmO6erqBuiLdXbrndV/q0fS89dL1yvTO6I3oU/U99QX6Zfpn9Z/T1ehMeia9gn6BPmqgYxBkIDXYa9BtMG5oZhhrWGDYZPjQiGjEMEo1KjPqNBo11jcOM15p3GB834RgwjDhm+w06TL5YGpmGm+6wbTV9JmZhhnLLN+swWzAnGLuZZ5jXmt+2wJrwbDIsNht0WMJWzpZ8i2rLG9YwVbOVgKr3Va9czBzXOcI59TO6bMmWzOt86wbrAdtaDahNgU2rTav5hrPTZq7bW7X3G+2TraZtvttH9ip2AXbFdi1272xt7Tn2FfZ33agOAQ4rHFoc3jtaOXIc9zj2O9EdQpz2uDU6fTV2cVZ7NzoPOJi7JLsUu3Sx1BlRDI2MS67Ylx9XNe4nnL95Obslut2zO0Pd2v3DPdD7s/mmc3jzds/b8jD0IPtsddD5kn3TPb80VPmZeDF9qr1euxt5M31rvN+yrRgpjMPM1/52PqIfZp9Pvi6+a7y7fBD+QX6Fft1+6v4x/pX+j8KMAxIC2gIGA10ClwR2BGECQoJ2hbUx9JlcVj1rNFgl+BVwRdCyCHRIZUhj0MtQ8Wh7WFwWHDY9rCBcJNwYXhrBIhgRWyPeBhpFpkT+ct87PzI+VXzn0TZRa2M6oqmRi+JPhT9PsYnZkvMg1jzWGlsZ5xi3MK4+rgP8X7xpfGyhLkJqxKuJWolChLbknBJcUl1SWML/BfsWDC80Glh0cK7i8wWLVt0ZbHW4szFp5coLmEvOZ6MSY5PPpT8hR3BrmWPpbBSqlNGOb6cnZwXXG9uGXeE58Er5T1N9UgtTX2W5pG2PW2E78Uv578U+AoqBa/Tg9Jr0j9kRGQcyJjIjM9sysJnJWedFKoIM4QXsvWyl2X3iqxERSJZjlvOjpxRcYi4TgJJFknaclWR5ui61Fz6nXQwzzOvKu/j0rilx5cpLxMuu77ccvnG5U/zA/J/WoFewVnRudJg5bqVg6uYq/auhlanrO5cY7SmcM3w2sC1B9cR12Ws+7XAtqC04N36+PXthbqFawuHvgv8rqFIoUhc1LfBfUPN9+jvBd93b3TYuGvjt2Ju8dUS25Lyki+bOJuu/mD3Q8UPE5tTN3dvcd6yZyt2q3Dr3W1e2w6WKpfmlw5tD9veUkYvKy57t2PJjivljuU1O4k7pTtlFaEVbbuMd23d9aWSX3mnyqeqqVqnemP1h93c3Tf3eO9prNGtKan5/KPgx/69gXtbak1ry/dh9+Xte7I/bn/XT4yf6uu06krqvh4QHpAdjDp4od6lvv6QzqEtDXCDtGHk8MLDPUf8jrQ1WjfubaI1lRwFR6VHn/+c/PPdYyHHOo8zjjeeMDlR3UxtLm6BWpa3jLbyW2VtiW29J4NPdra7tzf/YvPLgVMGp6pOq53ecoZ4pvDMxNn8s2Mdoo6X59LODXUu6XxwPuH87QvzL3RfDLl4+VLApfNdzK6zlz0un7riduXkVcbV1mvO11quO11v/tXp1+Zu5+6WGy432npce9p75/Weuel189wtv1uXbrNuX7sTfqf3buzd/r6FfbJ+bv+ze5n3Xt/Puz/+YO0AZqD4odLD8kc6j2p/s/itSeYsOz3oN3j9cfTjB0OcoRe/S37/Mlz4hPKk/Kn+0/pn9s9OjQSM9Dxf8Hz4hejF+Muifyj/o/qV+asTf3j/cX00YXT4tfj1xJtNbzXfHnjn+K5zLHLs0fus9+Mfij9qfjz4ifGp63P856fjS7/gvlR8tfja/i3k28BE1sSEiC1mT7UCKETh1FQA3hwAgJIIALUHAOKC6Z56SqDp/4ApAv+Jp/vuKXEGoH4tADGIhnUAsNsbaWkRVUQ4EhljvAHs4CDXP0WS6mA/HYvUirQm5RMTb5H+EWcBwNe+iYnx1omJr3VIsfcB6Hg/3ctPitJhAHrO2SbGxvTVNIN/lX8CjpYUPaGOcbcAABLmSURBVHgB7Z0FsBxFE8cnQBLcCe7uFtw9ELwgeBHcXYJLFVKFuwd3dymconAnWBUQXII7BJmvf13fbPY2e3tzd3vJvqvuqvd2d3a2t/vfsz0zPb23vbyQMzIEDAFDwBDoMQiM02MkNUENAUPAEDAEFAFz3NYQDAFDwBDoYQiY4+5hBjNxDQFDwBAYLw3BsGHD3E477eT+/fffdLHtGwJdiwBLPCNHjnS9e/d244xj45hOGfq///5zf//9t+vTp4/r1atXp27TVXzHHXdcN3ToULfQQguNpleN437nnXfcCy+84IYMGTJaRSswBLoRAZzJGWec4TbbbDM355xzdqOKldDpww8/dLfccovbf//9Xd++fSshU5WFYEBxyimnuHfffTfXcfdKZ5UA7KBBg5wlmlTZpCZbmQj88ccfbsIJJ3T33nuvGzhwYJmsjVcKgYceesgNGDDA/fzzz26SSSZJnbHdPATwwcwA8ckMKrJkc8MsInZsCBgChkDFETDHXXEDmXiGgCFgCGQRMMedRcSODQFDwBCoOALmuCtuIBPPEDAEDIEsAua4s4jYsSFgCBgCFUfAHHfFDWTiGQKGgCGQRcAcdxYROzYEDAFDoOIImOOuuIFMPEPAEDAEsgiY484iYseGgCFgCFQcAXPcFTeQiWcIGAKGQBYBc9xZROzYEDAEDIGKI2COu+IGMvEMAUPAEMgiYI47i4gdGwKGgCFQcQTMcVfcQCaeIWAIGAJZBMxxZxGxY0PAEDAEKo5AVzhufqR9xx13dJ999lnF4e554vGhgUcffdQdcMAB7v7776+MAvzA/GmnneYee+yxyshUFUH4IArYPPzww4lIfCziggsuSI5tp2cj0BWO+5VXXnFXXHGFe/PNN3u2NSooPZjefPPN7qyzznJffPFFJST8/PPP3TnnnOMOOeQQN3z48ErIVBUhPvjgA3fxxRcrNumBzOWXX+6uvvrqqohpcrSJQFc4br4Q8c0337h11123TTiqf/mYfviWWGIJt9dee411YNJ6zzjjjO7ggw8e6zJVUQA+v7bbbrupaOONN+rLhM8//7x7/PHHqyhyZWRKt7EyhcI3Pfjgg2WydF3huEFk6qmnLhWYKjLjwTviiCPGuGjBAYytj7zm6c2HVI3yEQgfPQ5bak000URuggkmyL/ASrVT68SzxYfXt956a/fRRx+VivKoLrlFtkzH7r77brfHHnu4J5980vFtOUZEfC0+NJQffvjB3XDDDW7PPfd0DzzwgHvjjTfcQQcd5IJDeOSRRxwjgimmmMJtscUWbqqppnK//vqru/TSS/UL3DRARtN87Zhv1l111VXu999/d5tuuqmbe+65HV+Q5t4TTzyxW2qppRJNfvnlF43LEvObeeaZ3dprr61bKnz55Zfu9ttv1y9Pr7XWWm7BBRdU473++ut6PbxnmWUW3ef7b/B/7bXXHA5jvvnmc1zTLOXpCY9//vlH742eyy23nLvnnnvce++957bccks3zzzz6G1wXhtttJF+IZup8AwzzOA22GADl4ft4MGDFWcuxNkussgibvHFF3e//fabu/POO1Xn1VZbzc0666zKu9V/hE4YSdAGVlhhBbfGGmskrGJ0CpWx9TXXXOM++eQTtefSSy/t5p9/fsW6nt7hWrbff/+9YoYcm2++eYJZuk7Z+2Xp/tJLL7mnnnrK/fnnn2699dZziy22WI2oRW04XREeTzzxhH6Il1kSlO5oR4wYod/VZC0o0KeffqrPwD777OPefvttd9ddd2mb32abbWq+eF9kn8CrU1vuTZvleVh44YXdOuus4yabbLLkdo3wiWmHRW2syM6N8Pvrr78cWPLc9+vXT+2x4YYbuumnnz6Rv+UdPhYcSGKZXhiFw4bba6+91ouz9eKg/e677+6lUXhpfMpDHj4/cuRIf+WVV3r5GKsXJ+3PPfdcv+iii+p5cZBeFPM777yzF6fuxSl6CXl4GTn7t956S+8tX5z34ii9GKtGlosuusjL9F3LqMt1yH3hhRcm9eAnhva33Xabl0brZbHGy6jDi9NP6gR9L7vssqTs+OOPV17SASVl0hN76UT0+MUXX/To1gwV6SlOx4uD1nuKkb30zn6//fbz0047rRcD+++++05v9eqrr3pxjn6aaabx0tA8x0XYoieYbLfddjWiynTQi2P30tnVlBcdgDG80jjJoqDfZZddvKwveHAEW+mYlU2sTlSmrnROXhyPl4fUb7LJJnov6YC9fBFc9czqzXUygtF6yLDmmmt6CZ346aabTnH79ttvqRJFMgBQPvKx4Kj6VCpL96OOOsofd9xxHhlorzwj6Bwopg1Tl/bJcwR+4LLiiiuqTtdff70Xx+Vl/cfLB3oVm8BbBlvalrDrmWee6XfYYQe//vrr63UnnXRSqNbQPknFBjvSwStvGXg1qDnqtAy41J/gK2SR3G+11VZeBnVe4vhaqRE+se0w79niBkV2jsHvxx9/VL8BxrIeo8+tDLRGKViwx/PJdfKx4NxaNV46OLLcmnUKt912Wy89ux82bFhS4+ijj9ab4mAhHBJCyAhXjzEIhDM99thjdZ9/0oNpvbSj3n777dXxA0IgGikNNJCM4PW64LhxlDIq9sccc0yoolucYp8+fZKOAZmRK+2QMAhlwXEDIJ0JzjLQCSecEHajto30lC+N6z1lFKwNFKZBDhl9J/fYeOONvcwckmN26mHLORl5eRlVJzwpk5mR50FohrKOW0Y5fo455lBHEfjIDEt1ePbZZ7UoVqfDDz9cZQx8Xn75ZeWDMwmUp3dw3DicQGCF7dKYhXP1ts067rJ0Z0AhM9MasWSW5/v3769lsW1YMn10cPPTTz8lvEKnjeMOBG8GA2k67LDDFC8ZESbFtJkll1wyOY6xT1K5YKdZx02HI7MPf8kllyRcaRs8v9g3Fp/YdphtYzF2jsGPzoU2OXTo0ESPmJ1GjrvtGDexM0IehBoCiUJaxvQNYloPMdWHCDVApChJb6eLXyyAnXzyyW7eeefVqa9WkH+UExaR0b0WMTXiLz3N79u3b6iuW6bvpIstu+yyNeVMs2QW4ATEmvKiA6abyEQIh6kk1OzCWCM9xx9/fJ1GsbAUwkcLLLCA3ovwQZrS01/K62HLuUMPPdR9/PHH7tZbb+VQQyTvv/++hk60oMV/hL3kgVD+2Ie/r776yiE//KFYnciCYPEGu0AyI9N4LNPQNGX1DueoH4hQGgTPTlFZup944olu4MCBNWJiJ+n4tCy2DfPMiKN1k046acKLUBOUxiz7jHA+hDLD80gZ7S7d5mLtw7VlEqmn4vRqMCIExLMvMwMN0cU847HtENnTeMXYOQa/gEmadyhrZ9t2jDvv5hIacTPNNJM+kJwPiyRhS5mMoDW9TEbPGqulLI+IWfNHXBcHceONN2rcKK9uKCNeBxHzTtNKK62kh8S8m6HzzjtPY6fSK2sc97rrrnMyeoliEatnlllYfJPeueZUtgEETMM2XZlsGxkZu9NPP13j5TwMxNjaJRmBa5zu/PPPb4pVnk7E2mWm555++mm3+uqra8weJ55dQ8jqnXfj0OmxINQpKkN35IMP9kkTOgYdYtswazJ5fNJ8m9nHRuk2F2ufZu4RUxe9GBRKaLCmuoy49TgWn5qL/3+Q1w45lW5j7dg5jV+4f5p3KGtn2/aIO+/mMo3RERhOox4FRxOTe43Dph6jERY3WcQpoimnnFJPh9FLqMsovXfv3roIGspitiwYkSvO4ioLQPT8Ej+LuTTptGL0jGHYTAOggbIIHBbAJF7mJE4Yc5vCOvBlsYiXc9olOm5kZHEb+SS8pTOvAQMG1LBuRu+aC0s+KEN3HmyZCuuCaj3xYtowC2/MRlnYz6MyMIu1T9792ykDHxbTJUSZyyYGn9wLCwrTeJVh5/St0rzT5a3ud8Rx4zBZJWdKU4+Y2s0+++xO4tI67U7XIyySnq6FTBPe3iNDAlCLaJllltHTIVQT6kpMW50NmRtQGN0gaz2iEyLjQRZ3HCPM++67L8lIqXdNurwZPdPX5e1j/GZHkxID1lGLLILpiIKMnXaJ8AQPlaxh1LBidtHs23nYgFV2XhDBthLbVkeeZtyK3unry9wvQ3d0Jmvmueeec7z1myZmc4ShYtpw4MPo8Ouvv06zKW0/xj6l3SzFiAwSSOL0qVLnZLHe3XHHHVH41FzY4CDbxsqwM7cMDrvZ57aBuOXkcdPzp8MPsvDiVllllcRx85BDgJ4m3nwjhYspMiNZ4t2yWOlkoSVJxaM+cSrSCxk5MgLIEs4VkmwC3QK6LGpqmlW6A2A6TvrgrrvuqvVItZttttk0/EIsmJgZoz4IWej1GR3hoML0h5RCcsabyRtvpCcpT/APcV7uH3ThIQ6EgyOWzMNO7BFc62EbriEOt/fee+vIpdXRNvaAkBOiIyW9klj/qaeeqrYn3AGuksWidWJ1ouMmtsvoHf2xF3HMNOXpHdpS2FI/zILCNs2jrP2ydKedY3NCEbz4wUxysKRxUobNYtvwkCFDVDVS+ngOaLM33XSTltHeAz6cw448q4FIrYWy7Y66ob3H2CfwK3NLSI8UVlJ/JWNNf3aBTp10RmbcsfjEtsNsG2PQ2aiNx+AHX4jBLJiSCl0KCbOEWskqkbe0dFVbnIOmvJDaJvnFPqT9kLHB6rkI6wcNGuRlWpfcTxqZZ9VaenU9z5aVWumdkjphZ/jw4Z6V3yzJqCVJB5TFKR/SulhNlhCLl0VTTZtDDlkM8uIYalhQPvnkk2s6G+lGkq/tJT6vaVkSDvDwEfA1ZY/UHHFUo2Wr1DDMOSjSUxqW33fffVV/0tlYMZdXupO0OGmgXjos5UpmCxghr7zyrdkw9bBNiyHOXnVgpb5Zwl5k+WA/eZA8WQyQxBg1jY9y/sCe1ECoGZ1k9KTYBz5hS4qf5Norv6ze0tl7ydfW+5I9JL+lonalfXG9LCZ7eVD02kb/ms0qgV9ZupNiii2RWWZmPmRhBZlj2zBtkpRbGeBoVgpZTKTN0f6feeYZbSsccx9ZsPYyOvcyUNLMIMpkMKRYk5aLHJTJDE2zkWLsE+Qt2jabVQIv7CxrHZq1JiNXv+qqq2pZuE8jfJpph9k2xj2K7ByLH3zk/QbFlKwxGSBS1JDwGdgBn5NHvSiUCkqMNqXxJ71tKC/a0hsyzaXXJhOA5HjCA82QGEBHkYROWNisR8Tzis7nXccog6kkL9OwYJpHhEoY8REOYUsoJsTgqc8ohZEMo93wUk4en0ZlsXoW8UEfZEPWWOIFAH6MSfJzYy+JrsdMhelgq7jwQ0j89ojkHiu+2JhZBKNwpstkKEGt6B2jBDahTUmHX5PBEHNtu7pzD9oVs07aZrrNpe8f04Zpo7RP+NCGeazDQl6aV7P7sfZpxJcX81i3YJTaTNuFLyE4cApx7ey9YvDJXpN3XK+NtWtnbMGLPLyYGEtcQ3vAJ2cXn+FRalYJU4tWiKlhOp2wHo9mnTZ86EiWX375eiy1nFAMfxCLl1kizgdlnROLlY2I8EF4Gy5WzyKe6bfGiuqlz0kurGaWpMuI1fNXRDS0I488sqhKTVpmYcWck5KXq+EBwiN0lnPNNVdSK2QzhIJW9A7XdmqbTklt9R48nNl2leUV04Zpo2FgkteGszxjjpuxTwy/VuvIrKTw0hh8Chn8/2S9NtaunRnYNOO0Y2Rt23EzQqK3J5aUTb+LEaAn18G5NKJsOlOj+mWdl7cvNV4c4vHZTpXZTSP56zXksmQk3sdPD0i4ykloRDsBebHGyRuzGguUMFpZtzI+LSBg9mkBtDF1iQzJE2o2xs0r77yNJbLq6868OmpUDQRkEU1jg8SnZQpYDaEyUhDHkxxzjV3KCyIa65aXprzk7OubcZnqHTlsJcbdEUEqyLRM+7QS464gJGNMJLDHr3Ykxk1MSDRJ+hjeziIcYFQNBMgOyHtjrhrS1UpBXLasKX4t5+KjdmLcxZy762y79mknxt1dSMZpg1/tWIy701PpOBWtVj0EeorTRv6x4bTr4WbloyNg9hkdk7FZ0pEXcMamQnZvQ8AQMAS6HQFz3N1uYdPPEDAEug4Bc9xdZ1JTyBAwBLodAXPc3W5h088QMAS6DgFz3F1nUlPIEDAEuh0Bc9zdbmHTzxAwBLoOAXPcXWdSU8gQMAS6HQFz3N1uYdPPEDAEug4Bc9xdZ1JTyBAwBLodAXPc3W5h088QMAS6DgFz3F1nUlPIEDAEuh2Bmp91Dd9H69+/f7frbfoZAooAP9DPBwcOPPBA/WyewdIZBPgcHTivvPLKDb8Z2xkJehbX8ON9wSdnpa/5As6IESPc2Wef3fQHabNM7dgQMAQMAUOgPQT4uAi/q9+vX7/RGNU47tHOWoEhYAgYAoZA5RCwGHflTGICGQKGgCFQjIA57mJ87KwhYAgYApVDwBx35UxiAhkChoAhUIzA/wBwWnL0Y3fYCgAAAABJRU5ErkJggg==" alt="节点结构"></p> <p>每一个节点都记录了上一个节点的长度，因此可以通过节点的<code>previous_entry_length</code>属性计算上一个节点的位置。因为这种前后节点的相关性，删除节点和增加节点都会导致连锁更新。连锁更新在最坏情况下需要对压缩列表执行 N 次空间重分配操作， 而每次空间重分配的最坏复杂度为 O(N) ， 所以连锁更新的最坏复杂度为 O(N^2) 。</p> <h2 id="对象"><a href="#对象" aria-hidden="true" class="header-anchor">#</a> 对象</h2> <p>Redis并没有直接使用上述的这几种数据结构来实现它的键值对数据库，而是基于这些数据结构创建了一个对象系统。这个系统包含<code>字符串对象</code>、<code>列表对象</code>、<code>哈希对象</code>、<code>集合对象</code>和<code>有序集合对象</code>这五种类型的对象，每种对象都用到了至少一种我们前面所介绍的数据结构。</p> <blockquote><p>相关源文件: <a href="https://github.com/antirez/redis/blob/5.0/src/server.h" target="_blank" rel="noopener noreferrer">server.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/antirez/redis/blob/5.0/src/server.c" target="_blank" rel="noopener noreferrer">server.c<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/antirez/redis/blob/5.0/src/object.c" target="_blank" rel="noopener noreferrer">object.c<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>Redis对象的定义是在<code>server.h</code>中的，<code>type</code>为redis的外部数据结构，即我们常用的redis五种数据类型，<code>encoding</code>为redis的内部数据结构实现，包括我们前面讲的数据类型。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> redisObject <span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> type<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">;</span>        <span class="token comment">/* 对象的类型 */</span>
    <span class="token keyword">unsigned</span> encoding<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">;</span>    <span class="token comment">/* 对象的编码，ptr指向对象的底层实现结构，结构由这个属性决定。
                            * 通过encoding属性来设定对象所使用的编码，而不是特定类型的对象关联一种固定的编码，
                            * 可以极大的提升redis的灵活性和效率。
                            * */</span>
    <span class="token keyword">unsigned</span> lru<span class="token punctuation">:</span>LRU_BITS<span class="token punctuation">;</span> <span class="token comment">/* LRU time (relative to global lru_clock) or
                            * LFU data (least significant 8 bits frequency
                            * and most significant 16 bits access time). */</span>
    <span class="token keyword">int</span> refcount<span class="token punctuation">;</span>          <span class="token comment">/* 引用计数 */</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span> robj<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>redis使用<code>refcount</code>来实现内存的回收机制。通过跟踪对象的引用计数信息， 在适当的时候自动释放对象并进行内存回收。<code>lru</code>属性记录了对象最后一次被命令程序访问的时间或者是8位的最近访问频率和16位的访问时间。如果服务器打开了 <code>maxmemory</code> 选项， 并且服务器用于回收内存的算法为 <code>volatile-lru</code> 或者 <code>allkeys-lru</code> ， 那么当服务器占用的内存数超过了 <code>maxmemory</code> 选项所设置的上限值时， 空转时长较高的那部分键会优先被服务器释放， 从而回收内存。</p> <ul><li>LRU: least recently used,最近最少使用</li> <li>LFU: Least Frequently Used,算法根据数据的历史访问频率来淘汰数据，其核心思想是“如果数据过去被访问多次，那么将来被访问的频率也更高”。</li></ul> <h4 id="对象的类型"><a href="#对象的类型" aria-hidden="true" class="header-anchor">#</a> 对象的类型</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* The actual Redis Object */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_STRING 0    </span><span class="token comment">/* String object. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_LIST 1      </span><span class="token comment">/* List object. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_SET 2       </span><span class="token comment">/* Set object. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_ZSET 3      </span><span class="token comment">/* Sorted set object. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_HASH 4      </span><span class="token comment">/* Hash object. */</span>

<span class="token comment">/* The &quot;module&quot; object type is a special one that signals that the object
 * is one directly managed by a Redis module. In this case the value points
 * to a moduleValue struct, which contains the object value (which is only
 * handled by the module itself) and the RedisModuleType struct which lists
 * function pointers in order to serialize, deserialize, AOF-rewrite and
 * free the object.
 *
 * Inside the RDB file, module types are encoded as OBJ_MODULE followed
 * by a 64 bit module type ID, which has a 54 bits module-specific signature
 * in order to dispatch the loading to the right module, plus a 10 bits
 * encoding version. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_MODULE 5    </span><span class="token comment">/* Module object. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_STREAM 6    </span><span class="token comment">/* Stream object. */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="对象的编码"><a href="#对象的编码" aria-hidden="true" class="header-anchor">#</a> 对象的编码</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* Objects encoding. Some kind of objects like Strings and Hashes can be
 * internally represented in multiple ways. The 'encoding' field of the object
 * is set to one of this fields for this object. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_ENCODING_RAW 0     </span><span class="token comment">/* Raw representation */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_ENCODING_INT 1     </span><span class="token comment">/* Encoded as integer */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_ENCODING_HT 2      </span><span class="token comment">/* Encoded as hash table */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_ENCODING_ZIPMAP 3  </span><span class="token comment">/* Encoded as zipmap */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_ENCODING_LINKEDLIST 4 </span><span class="token comment">/* No longer used: old list encoding. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_ENCODING_ZIPLIST 5 </span><span class="token comment">/* Encoded as ziplist */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_ENCODING_INTSET 6  </span><span class="token comment">/* Encoded as intset */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_ENCODING_SKIPLIST 7  </span><span class="token comment">/* Encoded as skiplist */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_ENCODING_EMBSTR 8  </span><span class="token comment">/* Embedded sds string encoding */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_ENCODING_QUICKLIST 9 </span><span class="token comment">/* Encoded as linked list of ziplists */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_ENCODING_STREAM 10 </span><span class="token comment">/* Encoded as a radix tree of listpacks */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>每种类型的对象都至少使用了两种不同的编码，如下表所示：</p> <table><thead><tr><th>类型</th> <th>编码</th> <th>对象</th></tr></thead> <tbody><tr><td>REDIS_STRING</td> <td>REDIS_ENCODING_INT</td> <td>使用整数值实现的字符串对象</td></tr> <tr><td>REDIS_STRING</td> <td>REDIS_ENCODING_EMBSTR</td> <td>使用embstr编码的简单动态字符串实现的字符串对象</td></tr> <tr><td>REDIS_STRING</td> <td>REDIS_ENCODING_RAW</td> <td>使用简单动态字符串实现的字符串对象</td></tr> <tr><td>REDIS_LIST</td> <td>REDIS_ENCODING_ZIPLIST</td> <td>使用压缩列表实现的列表对象</td></tr> <tr><td>REDIS_LIST</td> <td>REDIS_ENCODING_LINKEDLIST</td> <td>使用双端链表实现的列表对象</td></tr> <tr><td>REDIS_HASH</td> <td>REDIS_ENCODING_ZIPLIST</td> <td>使用压缩列表实现的哈希对象</td></tr> <tr><td>REDIS_HASH</td> <td>REDIS_ENCODING_HT</td> <td>使用字典实现的哈希对象</td></tr> <tr><td>REDIS_SET</td> <td>REDIS_ENCODING_INTSET</td> <td>使用整数集合实现的集合对象</td></tr> <tr><td>REDIS_SET</td> <td>REDIS_ENCODING_HT</td> <td>使用字典实现的集合对象</td></tr> <tr><td>REDIS_ZSET</td> <td>REDIS_ENCODING_ZIPLIST</td> <td>使用压缩列表实现的有序集合对象</td></tr> <tr><td>REDIS_ZSET</td> <td>REDIS_ENCODING_SKIPLIST</td> <td>使用跳跃表和字典实现的有序集合对象</td></tr></tbody></table> <h3 id="创建对象"><a href="#创建对象" aria-hidden="true" class="header-anchor">#</a> 创建对象</h3> <p>Redis封装了多种对象创建的方法，基本的创建方法如<code>createObject()</code>。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>robj <span class="token operator">*</span><span class="token function">createObject</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    robj <span class="token operator">*</span>o <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    o<span class="token operator">-&gt;</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
    o<span class="token operator">-&gt;</span>encoding <span class="token operator">=</span> OBJ_ENCODING_RAW<span class="token punctuation">;</span>
    o<span class="token operator">-&gt;</span>ptr <span class="token operator">=</span> ptr<span class="token punctuation">;</span>
    o<span class="token operator">-&gt;</span>refcount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">/* Set the LRU to the current lruclock (minutes resolution), or
     * alternatively the LFU counter. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        o<span class="token operator">-&gt;</span>lru <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">LFUGetTimeInMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> LFU_INIT_VAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        o<span class="token operator">-&gt;</span>lru <span class="token operator">=</span> <span class="token function">LRU_CLOCK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>基于<code>robj *createObject(int type, void *ptr);</code>方法可以创建各种类型的redis对象。相关的对象创建接口有：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>robj <span class="token operator">*</span><span class="token function">createObject</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
robj <span class="token operator">*</span><span class="token function">createStringObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>
robj <span class="token operator">*</span><span class="token function">createRawStringObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>
robj <span class="token operator">*</span><span class="token function">createEmbeddedStringObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>
robj <span class="token operator">*</span><span class="token function">createStringObjectFromLongLong</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
robj <span class="token operator">*</span><span class="token function">createStringObjectFromLongLongForValue</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
robj <span class="token operator">*</span><span class="token function">createStringObjectFromLongDouble</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">double</span> value<span class="token punctuation">,</span> <span class="token keyword">int</span> humanfriendly<span class="token punctuation">)</span><span class="token punctuation">;</span>
robj <span class="token operator">*</span><span class="token function">createQuicklistObject</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
robj <span class="token operator">*</span><span class="token function">createZiplistObject</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
robj <span class="token operator">*</span><span class="token function">createSetObject</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
robj <span class="token operator">*</span><span class="token function">createIntsetObject</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
robj <span class="token operator">*</span><span class="token function">createHashObject</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
robj <span class="token operator">*</span><span class="token function">createZsetObject</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
robj <span class="token operator">*</span><span class="token function">createZsetZiplistObject</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
robj <span class="token operator">*</span><span class="token function">createStreamObject</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
robj <span class="token operator">*</span><span class="token function">createModuleObject</span><span class="token punctuation">(</span>moduleType <span class="token operator">*</span>mt<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>在redis中，共定义了 5 + 2 种对象类型：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* A redis object, that is a type able to hold a string / list / set */</span>

<span class="token comment">/* The actual Redis Object */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_STRING 0    </span><span class="token comment">/* String object. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_LIST 1      </span><span class="token comment">/* List object. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_SET 2       </span><span class="token comment">/* Set object. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_ZSET 3      </span><span class="token comment">/* Sorted set object. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_HASH 4      </span><span class="token comment">/* Hash object. */</span>

<span class="token comment">/* The &quot;module&quot; object type is a special one that signals that the object
 * is one directly managed by a Redis module. In this case the value points
 * to a moduleValue struct, which contains the object value (which is only
 * handled by the module itself) and the RedisModuleType struct which lists
 * function pointers in order to serialize, deserialize, AOF-rewrite and
 * free the object.
 *
 * Inside the RDB file, module types are encoded as OBJ_MODULE followed
 * by a 64 bit module type ID, which has a 54 bits module-specific signature
 * in order to dispatch the loading to the right module, plus a 10 bits
 * encoding version. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_MODULE 5    </span><span class="token comment">/* Module object. */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OBJ_STREAM 6    </span><span class="token comment">/* Stream object. */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><code>OBJ_MODULE</code>是一种特殊的对象类型，由redis模块管理。<code>OBJ_STREAM</code>类型是redis 5.0的新特性Stream的数据实现，可以查看相关的文档介绍（<a href="https://redis.io/topics/streams-intro" target="_blank" rel="noopener noreferrer">Introduction to Redis Streams<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）。</p> <p>根据配置，redis可以选择多种内存策略，用户可以选择以下几种策略：</p> <ul><li><code>noeviction</code>: 当内存使用超过配置的时候会返回错误，不会回收任何键。默认配置。</li> <li><code>volatile-lru</code>: 加入键的时候，如果过限，首先从设置了过期时间的键集合中回收最久没有使用的键</li> <li><code>allkeys-lru</code>: 新增键的时候，如果内存过限，首先通过LRU算法回收最久没有使用的键</li> <li><code>volatile-random</code>: 加入键的时候如果内存过限，从过期键的集合中随机回收键</li> <li><code>allkeys-random</code>: 加入键的时候如果内存过限，从所有键中随机删除</li> <li><code>volatile-ttl</code>: 从配置了过期时间的键中回收马上就要过期的键</li> <li><code>volatile-lfu</code>: 从所有配置了过期时间的键中回收使用频率最少的键</li> <li><code>allkeys-lfu</code>: 从所有键中回收使用频率最少的键</li></ul> <h3 id="引用计数"><a href="#引用计数" aria-hidden="true" class="header-anchor">#</a> 引用计数</h3> <p>当对象的<code>refcount</code>等于1时，如果再次减少其引用次数，redis会回收该对象占用的内存。<code>freeStringObject()</code>，<code>freeListObject()</code>函数都是用来回收对象<code>o-&gt;ptr</code>指向的内存，最后通过<code>zfree(o)</code>释放对象结构体自身占用的内存。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">decrRefCount</span><span class="token punctuation">(</span>robj <span class="token operator">*</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>refcount <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> OBJ_STRING<span class="token punctuation">:</span> <span class="token function">freeStringObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> OBJ_LIST<span class="token punctuation">:</span> <span class="token function">freeListObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> OBJ_SET<span class="token punctuation">:</span> <span class="token function">freeSetObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> OBJ_ZSET<span class="token punctuation">:</span> <span class="token function">freeZsetObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> OBJ_HASH<span class="token punctuation">:</span> <span class="token function">freeHashObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> OBJ_MODULE<span class="token punctuation">:</span> <span class="token function">freeModuleObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> OBJ_STREAM<span class="token punctuation">:</span> <span class="token function">freeStreamObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown object type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">zfree</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>refcount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">&quot;decrRefCount against refcount &lt;= 0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>refcount <span class="token operator">!=</span> OBJ_SHARED_REFCOUNT<span class="token punctuation">)</span> o<span class="token operator">-&gt;</span>refcount<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>共享对象的引用计数次数为<code>OBJ_SHARED_REFCOUNT</code>，其<code>refcount</code>不会被减少，因此共享对象不会被回收。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// 引用计数减 1</span>
<span class="token keyword">void</span> <span class="token function">incrRefCount</span><span class="token punctuation">(</span>robj <span class="token operator">*</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>refcount <span class="token operator">!=</span> OBJ_SHARED_REFCOUNT<span class="token punctuation">)</span> o<span class="token operator">-&gt;</span>refcount<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 设置共享对象的引用计数</span>
robj <span class="token operator">*</span><span class="token function">makeObjectShared</span><span class="token punctuation">(</span>robj <span class="token operator">*</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">serverAssert</span><span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>refcount <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    o<span class="token operator">-&gt;</span>refcount <span class="token operator">=</span> OBJ_SHARED_REFCOUNT<span class="token punctuation">;</span>
    <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="内存回收"><a href="#内存回收" aria-hidden="true" class="header-anchor">#</a> 内存回收</h3> <p>上面提到了当对一个<code>refcount = 1</code>的对象进行<code>decrRefCount()</code>操作减少引用计数时，Redis会回收该对象占用的内存。根据对象的<code>type</code>属性，redis调用相应的内存回收函数(<code>freeStringObject()</code>， <code>freeListObject()</code>, <code>freeSetObject()</code>, <code>freeZsetObject()</code>, <code>freeHashObject()</code>)来回收Redis提供的五种对象所占用的内存。内存回收函数又通过对象的编码属性<code>o-&gt;encoding</code>来执行相应的数据结构的内存回收方法。如字典，它的底层有可能时压缩列表编码的，也有可能是哈希表编码的，不同的编码方式，内存回收时的方法也不同。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">freeStringObject</span><span class="token punctuation">(</span>robj <span class="token operator">*</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>encoding <span class="token operator">==</span> OBJ_ENCODING_RAW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sdsfree</span><span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">freeListObject</span><span class="token punctuation">(</span>robj <span class="token operator">*</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>encoding <span class="token operator">==</span> OBJ_ENCODING_QUICKLIST<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">quicklistRelease</span><span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown list encoding type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">freeSetObject</span><span class="token punctuation">(</span>robj <span class="token operator">*</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>encoding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> OBJ_ENCODING_HT<span class="token punctuation">:</span>
        <span class="token function">dictRelease</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dict<span class="token operator">*</span><span class="token punctuation">)</span> o<span class="token operator">-&gt;</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> OBJ_ENCODING_INTSET<span class="token punctuation">:</span>
        <span class="token function">zfree</span><span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown set encoding type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">freeZsetObject</span><span class="token punctuation">(</span>robj <span class="token operator">*</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    zset <span class="token operator">*</span>zs<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>encoding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> OBJ_ENCODING_SKIPLIST<span class="token punctuation">:</span>
        zs <span class="token operator">=</span> o<span class="token operator">-&gt;</span>ptr<span class="token punctuation">;</span>
        <span class="token function">dictRelease</span><span class="token punctuation">(</span>zs<span class="token operator">-&gt;</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">zslFree</span><span class="token punctuation">(</span>zs<span class="token operator">-&gt;</span>zsl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">zfree</span><span class="token punctuation">(</span>zs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> OBJ_ENCODING_ZIPLIST<span class="token punctuation">:</span>
        <span class="token function">zfree</span><span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown sorted set encoding&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">freeHashObject</span><span class="token punctuation">(</span>robj <span class="token operator">*</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>encoding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> OBJ_ENCODING_HT<span class="token punctuation">:</span>
        <span class="token function">dictRelease</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dict<span class="token operator">*</span><span class="token punctuation">)</span> o<span class="token operator">-&gt;</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> OBJ_ENCODING_ZIPLIST<span class="token punctuation">:</span>
        <span class="token function">zfree</span><span class="token punctuation">(</span>o<span class="token operator">-&gt;</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown hash encoding type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>最后通过<code>zfree()</code>回收对象结构体自身占用的内存。</p> <h2 id="数据库"><a href="#数据库" aria-hidden="true" class="header-anchor">#</a> 数据库</h2> <p>Redis是一个键值对数据库，其中的每个数据库都由<code>redisDb</code>结构体表示。多个数据库通过整型<code>id</code>成员区分。</p> <blockquote><p>相关源文件: <a href="https://github.com/antirez/redis/blob/5.0/src/server.h" target="_blank" rel="noopener noreferrer">server.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/antirez/redis/blob/5.0/src/server.c" target="_blank" rel="noopener noreferrer">server.c<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/antirez/redis/blob/5.0/src/db.c" target="_blank" rel="noopener noreferrer">db.c<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> redisDb <span class="token punctuation">{</span>
    dict <span class="token operator">*</span>dict<span class="token punctuation">;</span>                 <span class="token comment">/* 键空间 The keyspace for this DB */</span>
    dict <span class="token operator">*</span>expires<span class="token punctuation">;</span>              <span class="token comment">/* Timeout of keys with a timeout set */</span>
    dict <span class="token operator">*</span>blocking_keys<span class="token punctuation">;</span>        <span class="token comment">/* Keys with clients waiting for data (BLPOP)*/</span>
    dict <span class="token operator">*</span>ready_keys<span class="token punctuation">;</span>           <span class="token comment">/* Blocked keys that received a PUSH */</span>
    dict <span class="token operator">*</span>watched_keys<span class="token punctuation">;</span>         <span class="token comment">/* WATCHED keys for MULTI/EXEC CAS */</span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span>                     <span class="token comment">/* Database ID */</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> avg_ttl<span class="token punctuation">;</span>          <span class="token comment">/* Average TTL, just for stats */</span>
    list <span class="token operator">*</span>defrag_later<span class="token punctuation">;</span>         <span class="token comment">/* List of key names to attempt to defrag one by one, gradually. */</span>
<span class="token punctuation">}</span> redisDb<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>数据库中的键空间示意图如下：</p> <p><img src="/assets/img/redisdb.01d148af.png" alt="redis数据库"></p> <p>键空间和用户用到的数据库是直接对应的：</p> <ul><li>键空间就是数据库的键，每一个键都是一个字符串对象</li> <li>键空间的值是数据库的值，每个值可以是字符串对象、列表对象、哈希表对象、集合对象和有序集合对象在内的任意一种 Redis 对象。</li></ul> <p>与数据库操作相关的API大部分都在<code>db.c</code>中实现，主要也是对<code>dict</code>字典方法的封装。</p> <p>redis维护了数据库服务的全局状态结构体<code>redisServer</code>，其中的<code>db</code>成员指向的就是<code>redisDb</code>数组。</p> <div class="language-c line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-c"><code><span class="token keyword">struct</span> redisServer <span class="token punctuation">{</span>
    <span class="token comment">/* General */</span>
    pid_t pid<span class="token punctuation">;</span>                  <span class="token comment">/* Main process pid. */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>configfile<span class="token punctuation">;</span>           <span class="token comment">/* Absolute config file path, or NULL */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>executable<span class="token punctuation">;</span>           <span class="token comment">/* Absolute executable file path. */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>exec_argv<span class="token punctuation">;</span>           <span class="token comment">/* Executable argv vector (copy). */</span>
    <span class="token keyword">int</span> dynamic_hz<span class="token punctuation">;</span>             <span class="token comment">/* Change hz value depending on # of clients. */</span>
    <span class="token keyword">int</span> config_hz<span class="token punctuation">;</span>              <span class="token comment">/* Configured HZ value. May be different than
                                   the actual 'hz' field value if dynamic-hz
                                   is enabled. */</span>
    <span class="token keyword">int</span> hz<span class="token punctuation">;</span>                     <span class="token comment">/* serverCron() calls frequency in hertz */</span>
    redisDb <span class="token operator">*</span>db<span class="token punctuation">;</span>                <span class="token comment">/* 数组，保存这服务器所有的数据库 */</span>
    dict <span class="token operator">*</span>commands<span class="token punctuation">;</span>             <span class="token comment">/* Command table */</span>
    dict <span class="token operator">*</span>orig_commands<span class="token punctuation">;</span>        <span class="token comment">/* Command table before command renaming. */</span>
    aeEventLoop <span class="token operator">*</span>el<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>基于多路复用，redis为每个连接上的客户端都维护了一个状态的结构体<code>client</code>。其中的<code>db</code>成员指向的是当前客户端选择了的数据库。</p> <div class="language-c line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-c"><code><span class="token comment">/* With multiplexing we need to take per-client state.
 * Clients are taken in a linked list. */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> client <span class="token punctuation">{</span>
    uint64_t id<span class="token punctuation">;</span>            <span class="token comment">/* Client incremental unique ID. */</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>                 <span class="token comment">/* Client socket. */</span>
    redisDb <span class="token operator">*</span>db<span class="token punctuation">;</span>            <span class="token comment">/* Pointer to currently SELECTed DB. */</span>
    robj <span class="token operator">*</span>name<span class="token punctuation">;</span>             <span class="token comment">/* As set by CLIENT SETNAME. */</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span> client<span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="参考"><a href="#参考" aria-hidden="true" class="header-anchor">#</a> 参考</h2> <ol><li><a href="http://redisbook.com/" target="_blank" rel="noopener noreferrer">Redis 设计与实现<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.cnblogs.com/thrillerz/p/4505550.html" target="_blank" rel="noopener noreferrer">跳跃表原理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新: </span> <span class="time">2/24/2020, 2:54:06 PM</span></div></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/6.d52816f4.js" defer></script><script src="/assets/js/app.7176b739.js" defer></script>
  </body>
</html>
