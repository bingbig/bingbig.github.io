(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{231:function(t,s,n){t.exports=n.p+"assets/img/1_n0C9gVEi8XIoAuZELhy1ng.13caf145.jpeg"},247:function(t,s,n){"use strict";n.r(s);var a=[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"命名空间go实现-network"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#命名空间go实现-network","aria-hidden":"true"}},[this._v("#")]),this._v(" 命名空间Go实现 - Network")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("在前面的文章中我们看到了如何使用"),s("code",[this._v("chroot")]),this._v("和Mount命名空间为"),s("code",[this._v("container")]),this._v("切换root文件系统。虽然它现在还是只单个 "),s("code",[this._v("/bin/sh")]),this._v(" 进程，但是它却有一下这些非常好的特性：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ol",[s("li",[this._v("可以以非root身份运行 - User 命名空间")]),this._v(" "),s("li",[this._v("可以选择root文件系统 - Mount 命名空间")]),this._v(" "),s("li",[this._v("不能看到宿主机的进程 - PID 命名空间")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("但是还有一块很重要的功能缺失了 - 网络。现在 "),s("code",[this._v("container")]),this._v(" 没有连接任何网络。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{attrs:{class:"token comment"}},[t._v("# Git repo: https://github.com/bingbig/container")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("# Git tag: 2.0")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("# Filename: container.go")]),t._v("\n\n$ ./container run /bin/sh\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("# route")]),t._v("\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("# ping 8.8.8.8")]),t._v("\nPING 8.8.8.8 "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("8.8.8.8"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(": 56 data bytes\nping: sendto: Network unreachable\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("缺少连接的原因是"),s("code",[this._v("container")]),this._v(" 克隆了一个新的Network命名空间。在本文我们将会配置新的Network命名空间。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"关于网络"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#关于网络","aria-hidden":"true"}},[this._v("#")]),this._v(" 关于网络")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("最基本的思想就是在"),s("code",[this._v("container")]),this._v(" Network命名空间和宿主机的Network命名空间之间建立连接。可视化这个过程如下图：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:n(231),alt:"Network Namespaces"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("这实际上需要大量的工作！在两个不同的Network命名空间里初始化和配置网络是得过程更加复杂。而且更麻烦的是初始化网络需要root权限。这意味着 "),s("code",[this._v("container")]),this._v(" 将失去以非root身份运行的特性了。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[t._v("幸运的是通过使用"),n("code",[t._v("setuid")]),t._v("我们可以避免这些麻烦事。"),n("code",[t._v("setuid")]),t._v(" 允许一个进程以拥有它的用户身份去运行。据此，我们可以把网络初始化代码分离独立成一个可执行文件，并且确保这个可执行文件的所有者是root用户，同时对应用 "),n("code",[t._v("setuid")]),t._v(" 权限。接着我们可以在 "),n("code",[t._v("container")]),t._v("（以非root用户身份运行）内部去调用这个可执行文件。记住这些，我再来介绍"),n("code",[t._v("netsetgo")]),t._v("。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"netset-go"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#netset-go","aria-hidden":"true"}},[this._v("#")]),this._v(" netset, Go!")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("为了能在"),s("code",[this._v("container")]),this._v("中使用"),s("code",[this._v("netsetgo")]),this._v("， 我们需要把可执行文件下载下来并设置权限，如下：")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{attrs:{class:"token comment"}},[t._v("# Git repo: https://github.com/teddyking/container")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("# Git tag: 4.1")]),t._v("\n$ "),n("span",{attrs:{class:"token function"}},[t._v("wget")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"https://github.com/teddyking/netsetgo/releases/download/0.0.1/netsetgo"')]),t._v("\n$ "),n("span",{attrs:{class:"token function"}},[t._v("mv")]),t._v(" netsetgo /usr/local/bin/\n$ "),n("span",{attrs:{class:"token function"}},[t._v("chown")]),t._v(" root:root /usr/local/bin/netsetgo\n$ "),n("span",{attrs:{class:"token function"}},[t._v("chmod")]),t._v(" 4755 /usr/local/bin/netsetgo "),n("span",{attrs:{class:"token comment"}},[t._v("# 4 表示其他用户执行文件时，具有与所有者相当的权限")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("chmod 4755")]),this._v(" 中的 "),s("code",[this._v("4")]),this._v(" 表示 "),s("code",[this._v("setuid")]),this._v(" 位应该被设置。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"let-s-go"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#let-s-go","aria-hidden":"true"}},[this._v("#")]),this._v(" Let's Go")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[t._v("现在"),n("code",[t._v("netsetgo")]),t._v("已经就位，我们需要修改"),n("code",[t._v("container")]),t._v("，让它可以执行"),n("code",[t._v("netsetgo")]),t._v("来配置网络。简单的想法就是我们创建一个"),n("code",[t._v("*exec.Cmd")]),t._v("执行这个"),n("code",[t._v("netsetgo")]),t._v("然后在适当的时机运行它？")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("当然没有比这看起来更容易的事了，但是什么时候执行"),s("code",[this._v("netsetgo")]),this._v("还需要其他的考虑。我们先回顾一下当前命名空间是怎么创建的：")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("# Git repo"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("github"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("bingbig"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("container\n# Git tag"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("4.0")]),t._v("\n# Filename"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" container"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("go")]),t._v("\n# "),n("span",{attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("run")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tcmd "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" reexec"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Command")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("append")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token builtin"}},[t._v("string")]),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{attrs:{class:"token string"}},[t._v('"nsInitialisation"')]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tos"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("2")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token operator"}},[t._v("...")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token operator"}},[t._v("...")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t# "),n("span",{attrs:{class:"token operator"}},[t._v("...")]),t._v("\n\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" cmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Run")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Printf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"Error running the reexec.Command - %s\\n"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tos"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Exit")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br")])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[n("code",[t._v("reexec")]),t._v(" 配置了一系列的 "),n("code",[t._v("CLONE_NEW*")]),t._v(" flag位，并且通过"),n("code",[t._v("cmd.Run")]),t._v("执行。注意"),n("code",[t._v("cmd.Run")]),t._v("在进程结束前不会返回。到目前为止，通过"),n("code",[t._v("nsInitialisation")]),t._v("方法我们在新的命名空间创建之前就配置好所有的后续命名空间配置。但是，"),n("code",[t._v("netsetgo")]),t._v(" 需要配置新的命名空间的同时也配置宿主机的Network命名空间，这就意味着我们不能依赖阻塞调用"),n("code",[t._v("cmd.Run()")]),t._v("了。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[t._v("幸运的是，"),n("code",[t._v("cmd.Run()")]),t._v("可以被分成连个分离的调用： "),n("code",[t._v("cmd.Start()")]),t._v("（立即返回）和"),n("code",[t._v("cmd.Wait()")]),t._v("（阻塞知道执行的命令结束）。这正式我们需要的，我们可以在新的命名空间创建之后执行"),n("code",[t._v("netsetgo")]),t._v("，同时还得在宿主机命名空间运行。我们在实例中看看。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("# Git repo"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("github"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("bingbig"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("container\n# Git tag"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("5.0")]),t._v("\n# Filename"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" container"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("go")]),t._v("\n# "),n("span",{attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" cmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Start")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Printf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"Error starting the reexec.Command - %s\\n"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tos"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Exit")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\npid "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" fmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Sprintf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"%d"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Process"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Pid"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nnetsetgoCmd "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" exec"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Command")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/usr/local/bin/netsetgo"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"-pid"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pid"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" netsetgoCmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Run")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tfmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Printf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"Error running netsetgo - %s\\n"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tos"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Exit")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" cmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Wait")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tfmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Printf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"Error running the reexec.Command - %s\\n"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tos"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Exit")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("这个改动可以让"),s("code",[this._v("netsetgo")]),this._v("跨越两个Network命名空间配置网络。剩下就是确保在这个命名空间网络准备就绪前"),s("code",[this._v("/bin/sh")]),this._v("不会被启动。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("# Git repo"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("github"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("bingbig"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("container\n# Git tag"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("5.0")]),t._v("\n# Filename"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" container"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("go")]),t._v("\n# "),n("span",{attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("waitForNetwork")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token builtin"}},[t._v("error")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tmaxWait "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" time"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Second "),n("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("3")]),t._v("\n\tcheckInterval "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" time"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Second\n\ttimeStarted "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" time"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Now")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tinterfaces"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" net"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Interfaces")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t\t"),n("span",{attrs:{class:"token comment"}},[t._v("// pretty basic check ...")]),t._v("\n\t\t"),n("span",{attrs:{class:"token comment"}},[t._v("// > 1 as a lo device will already exist")]),t._v("\n\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("len")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("interfaces"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v("\n\t\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" time"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Since")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("timeStarted"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" maxWait "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" fmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Errorf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"Timeout after %s waiting for network"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" maxWait"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t\ttime"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Sleep")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("checkInterval"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br"),n("span",{staticClass:"line-number"},[t._v("28")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("这样我们就可以通过简单的循环来判断网络接口是否就绪了。最后，我们更新"),s("code",[this._v("nsInitialisation")]),this._v("方法来调用上面的方法。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("div",{staticClass:"highlight-lines"},[n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("br"),n("br"),n("br"),n("br")]),n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("# Git repo"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("github"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("bingbig"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("container\n# Git tag"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("5.0")]),t._v("\n# Filename"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" container"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("go")]),t._v("\n# "),n("span",{attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("nsInitialisation")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tfmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Printf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"\\n>> namespace setup code goes here <<\\n\\n"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),n("span",{attrs:{class:"token function"}},[t._v("setMount")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/root/containerFS"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("waitForNetwork")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Printf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"Error waiting for network - %s\\n"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tos"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Exit")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token function"}},[t._v("nsRun")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br")])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{attrs:{class:"token comment"}},[t._v("# Git repo: https://github.com/bingbig/container")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("# Git tag: 5.0")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("# Filename: container.go")]),t._v("\n$ go build\n$ ./container run /bin/sh\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("# ifconfig")]),t._v("\nveth1     Link encap:Ethernet  HWaddr 06:A1:78:C3:FC:1B\n          inet addr:10.10.10.2  Bcast:0.0.0.0  Mask:255.255.255.0\n          inet6 addr: fe80::4a1:78ff:fec3:fc1b/64 Scope:Link\n          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1\n          RX packets:6 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:22 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:1000\n          RX bytes:420 "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("420.0 B"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  TX bytes:1698 "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("1.6 KiB"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("# route")]),t._v("\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\ndefault         10.10.10.1      0.0.0.0         UG    0      0        0 veth1\n10.10.10.0      *               255.255.255.0   U     0      0        0 veth1\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("# ping 10.10.10.1 -c 2")]),t._v("\nPING 10.10.10.1 "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("10.10.10.1"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(": 56 data bytes\n64 bytes from 10.10.10.1: seq"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("0 ttl"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("64 time"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("0.121 ms\n64 bytes from 10.10.10.1: seq"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("1 ttl"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("64 time"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("0.089 ms\n\n--- 10.10.10.1 "),n("span",{attrs:{class:"token function"}},[t._v("ping")]),t._v(" statistics ---\n2 packets transmitted, 2 packets received, 0% packet loss\nround-trip min/avg/max "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" 0.089/0.105/0.121 ms\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br"),n("span",{staticClass:"line-number"},[t._v("28")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("很好，我们有一个"),s("code",[this._v("veth1")]),this._v("网络接口，IP地址是10.10.10.2。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"连接互联网"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#连接互联网","aria-hidden":"true"}},[this._v("#")]),this._v(" 连接互联网")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("为"),s("code",[this._v("container")]),this._v("开启互联网连接有一点点超出本文的范围。网络连接的失败有很多原因，尝试覆盖所有的环境变量的初始化非常困难。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{attrs:{class:"token comment"}},[t._v("# Git repo: https://github.com/teddyking/ns-process")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("# Git tag: 5.0")]),t._v("\n$ "),n("span",{attrs:{class:"token function"}},[t._v("sudo")]),t._v(" iptables -tnat -N netsetgo\n$ "),n("span",{attrs:{class:"token function"}},[t._v("sudo")]),t._v(" iptables -tnat -A PREROUTING -m addrtype --dst-type LOCAL -j netsetgo\n$ "),n("span",{attrs:{class:"token function"}},[t._v("sudo")]),t._v(" iptables -tnat -A OUTPUT "),n("span",{attrs:{class:"token operator"}},[t._v("!")]),t._v(" -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j netsetgo\n$ "),n("span",{attrs:{class:"token function"}},[t._v("sudo")]),t._v(" iptables -tnat -A POSTROUTING -s 10.10.10.0/24 "),n("span",{attrs:{class:"token operator"}},[t._v("!")]),t._v(" -o brg0 -j MASQUERADE\n$ "),n("span",{attrs:{class:"token function"}},[t._v("sudo")]),t._v(" iptables -tnat -A netsetgo -i brg0 -j RETURN\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br")])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{attrs:{class:"token comment"}},[t._v("# Git repo: https://github.com/bingbig/container")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("# Git tag: 5.0")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("# Filename: container.go")]),t._v("\n$ go build\n$ ./container\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v('# echo "nameserver 8.8.8.8" >> /etc/resolv.conf')]),t._v("\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("# ping google.com")]),t._v("\nPING google.com "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("172.217.23.14"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(": 56 data bytes\n64 bytes from 172.217.23.14: seq"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("0 ttl"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("51 time"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("4.766 ms\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("然后成功了！"),s("code",[this._v("container")]),this._v("可以连接互联网了。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"下一步"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#下一步","aria-hidden":"true"}},[this._v("#")]),this._v(" 下一步")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("到此为止，"),s("code",[this._v("container")]),this._v("已经配置好User，Mount，Pid和Network命名空间了，但是剩下的命名空间我们还需要做什么呢？")])}],e=n(0),r=Object(e.a)({},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),t._m(3),t._v(" "),t._m(4),t._m(5),t._v(" "),t._m(6),t._v(" "),n("p",[t._v("如果我们想要给"),n("code",[t._v("container")]),t._v(" 配置网络连接，对网络命名空间的了解至关重要。我建议你去读一读 "),n("a",{attrs:{href:"http://blog.scottlowe.org/2013/09/04/introducing-linux-network-namespaces/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Introducing Linux Network Namespaces"),n("OutboundLink")],1),t._v("。这篇文章中的知识和是想会帮助你理解Network命名空间配置的基础。简而言之，我们需要做以下的内容：")]),t._v(" "),n("ol",[n("li",[t._v("在宿主机Network命名空间创建一个桥接设备")]),t._v(" "),n("li",[t._v("创建一个"),n("a",{attrs:{href:"https://www.cnblogs.com/bakari/p/10613710.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("veth pair"),n("OutboundLink")],1)]),t._v(" "),n("li",[t._v("将veth pair的一端连接到桥")]),t._v(" "),n("li",[t._v("将veth pair的另一端放到Network命名空间里")]),t._v(" "),n("li",[t._v("确保命名空间里进程的所有的外出流量都通过veth流出")])]),t._v(" "),t._m(7),t._v(" "),t._m(8),t._v(" "),t._m(9),t._v(" "),t._m(10),t._v(" "),t._m(11),t._v(" "),n("p",[n("a",{attrs:{href:"https://github.com/teddyking/netsetgo",target:"_blank",rel:"noopener noreferrer"}},[n("code",[t._v("netsetgo")]),n("OutboundLink")],1),t._v(" 可以为容器初始化Network命名空间的程序。它实现了上面所说的内容。为了简洁我不会把它所有的代码复制到这里，但是我们简要的指出其中最重要的部分，你可以自己去看看细节。")]),t._v(" "),n("ol",[n("li",[t._v("桥的通过调用"),n("code",[t._v("netlink.Linkadd")]),t._v(" 创建, 在"),n("a",{attrs:{href:"https://github.com/teddyking/netsetgo/blob/0.0.1/device/bridge.go#L15-L37",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),n("OutboundLink")],1)]),t._v(" "),n("li",[t._v("Veth的创建是通过另外一次"),n("code",[t._v("netlink.Linkadd")]),t._v("调用创建，在"),n("a",{attrs:{href:"https://github.com/teddyking/netsetgo/blob/0.0.1/device/veth.go#L16-L41",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),n("OutboundLink")],1)]),t._v(" "),n("li",[t._v("通过调用"),n("code",[t._v("netlink.LinkSetMaster")]),t._v(" 将veth连接到桥，在"),n("a",{attrs:{href:"https://github.com/teddyking/netsetgo/blob/0.0.1/device/bridge.go#L39-L51",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),n("OutboundLink")],1)]),t._v(" "),n("li",[t._v("通过调用 "),n("code",[t._v("netlink.LinkSetNsPid")]),t._v(" 将veth移动到新的网络空间，在"),n("a",{attrs:{href:"https://github.com/teddyking/netsetgo/blob/0.0.1/device/veth.go#L43-L50",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),n("OutboundLink")],1)]),t._v(" "),n("li",[t._v("通过调用 "),n("code",[t._v("netlink.RouteAdd")]),t._v(" 将默认的路由加到新的网络空间里，在"),n("a",{attrs:{href:"https://github.com/teddyking/netsetgo/blob/0.0.1/configurer/container.go#L47-L53",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),n("OutboundLink")],1)])]),t._v(" "),t._m(12),t._v(" "),t._m(13),t._m(14),t._v(" "),t._m(15),t._v(" "),t._m(16),t._v(" "),t._m(17),t._v(" "),t._m(18),t._m(19),t._v(" "),t._m(20),t._v(" "),t._m(21),t._m(22),t._v(" "),n("p",[t._v("我们可以认为新Network命名空间里的veth接口的出现是网络准备就绪的证据。我们可以简单的设置一个循环来判断。")]),t._v(" "),t._m(23),t._m(24),t._v(" "),t._m(25),n("p",[t._v("我们来执行一下！")]),t._v(" "),t._m(26),t._m(27),t._v(" "),t._m(28),t._v(" "),t._m(29),t._v(" "),n("p",[t._v("下面的步骤可以在我的Ubuntu16.04 Xenial机器上开启互联网连接。我不能保证对你的环境有效，如果感兴趣可以自己去研究。")]),t._v(" "),n("p",[t._v("首先我们需要在宿主机上配置以下iptales规则：")]),t._v(" "),t._m(30),n("p",[t._v("然后在新的命名空间添加一个DNS服务器。")]),t._v(" "),t._m(31),t._m(32),t._v(" "),t._m(33),t._v(" "),t._m(34)])},a,!1,null,null,null);r.options.__file="namespaces_in_go_network.md";s.default=r.exports}}]);