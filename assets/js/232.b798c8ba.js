(window.webpackJsonp=window.webpackJsonp||[]).push([[232],{246:function(t,s,n){"use strict";n.r(s);var a=n(0),e=Object(a.a)({},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),t._m(3),t._v(" "),t._m(4),t._m(5),t._v(" "),t._m(6),t._v(" "),n("p",[t._v("打开"),n("a",{attrs:{href:"https://github.com/moby/moby/tree/master/pkg/reexec",target:"_blank",rel:"noopener noreferrer"}},[n("code",[t._v("reexec")]),t._v("包"),n("OutboundLink")],1),t._v("，看看源码。")]),t._v(" "),t._m(7),t._m(8),t._v(" "),t._m(9),t._m(10),t._v(" "),t._m(11),t._m(12),t._v(" "),t._m(13),t._v(" "),t._m(14),t._v(" "),t._m(15),t._v(" "),t._m(16),t._m(17),t._v(" "),t._m(18),t._m(19),t._v(" "),t._m(20),t._v(" "),t._m(21),t._m(22),t._v(" "),t._m(23),t._m(24),t._v(" "),t._m(25),t._v(" "),n("p",[t._v("现在我们可以配置我们的命名空间了，还有什么需要配置的呢？")])])},[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"命名空间go实现-reexec"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#命名空间go实现-reexec","aria-hidden":"true"}},[this._v("#")]),this._v(" 命名空间Go实现 - reexec")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("本文的目的是理解"),s("code",[this._v("reexec")]),this._v("包。"),s("code",[this._v("reexec")]),this._v(" 是Docker代码的一部分，提供了一个很方便的方法是的可执行文件“自我执行”。在了解详细内容之前，我们先看看"),s("code",[this._v("reexec")]),this._v("帮我们解决了什么问题。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("举个例子来说明这个问题。考虑这样一个问题。我们想修改"),s("code",[this._v("container")]),this._v("，使得它在新的UTS命名空间里有一个随机生成的主机名。为了安全的原因，在"),s("code",[this._v("/bin/sh")]),this._v("进程开始前，我们就得把主机名修改了。毕竟，我们不希望在"),s("code",[this._v("container")]),this._v("的shell里可以获取到宿主机的主机名。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("就我所知，Go原生不支持这些。"),s("code",[this._v("exec.Command")]),this._v("不但可以通过设置属性来创建命名空间，也可以指定我们想要执行的进程。举个例子：")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("cmd "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" exec"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Command")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/bin/echo"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"Process already running"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ncmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SysProcAttr "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SysProcAttr"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tCloneflags"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWUTS"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\ncmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Run")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("cmd.Run()")]),this._v("一旦被调用，那么命名空间就会被创建，进程也就直接开始运行了。其中没有钩子函数，也没有别方法可以帮助我们在命名空间被创建后和进程开始前执行代码。这就是"),s("code",[this._v("reexce")]),this._v("出现的原因。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"自我毁灭前让自己重生"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#自我毁灭前让自己重生","aria-hidden":"true"}},[this._v("#")]),this._v(" 自我毁灭前让自己重生")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("var")]),t._v(" registeredInitializers "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("make")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token keyword"}},[t._v("map")]),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token builtin"}},[t._v("string")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{attrs:{class:"token comment"}},[t._v("// Register adds an initialization func under the specified name")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("Register")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name "),n("span",{attrs:{class:"token builtin"}},[t._v("string")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" initializer "),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("_")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" exists "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" registeredInitializers"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("name"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" exists "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{attrs:{class:"token function"}},[t._v("panic")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Sprintf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"reexec func already registered under name %q"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" name"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\tregisteredInitializers"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("name"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" initializer\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("Register")]),this._v(" 函数支持通过名字注册任意方法到内存中。我们将会在"),s("code",[this._v("container")]),this._v("开始后的以后注册一些用于初始化命名空间的方法。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{attrs:{class:"token comment"}},[t._v("// Init is called as the first part of the exec process and returns true if an")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// initialization function was called.")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("Init")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token builtin"}},[t._v("bool")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tinitializer"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" exists "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" registeredInitializers"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" exists "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{attrs:{class:"token function"}},[t._v("initializer")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("接着是"),s("code",[this._v("Init()")]),this._v("函数，该函数可以判断这个进程有没有被执行过（"),s("code",[this._v("reexec")]),this._v("ed），并且执行一个我们注册过的方法。它的实现机制是通过判断"),s("code",[this._v("os.Args[0]")]),this._v(" 是不是之前注册的方法名之一，如果是则说明被执行过，便执行注册的方法。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{attrs:{class:"token comment"}},[t._v("// Self returns the path to the current process's binary.")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v('// Returns "/proc/self/exe".')]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("Self")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token builtin"}},[t._v("string")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"/proc/self/exe"')]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{attrs:{class:"token comment"}},[t._v("// Command returns *exec.Cmd which has Path as current binary. Also it setting")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// SysProcAttr.Pdeathsig to SIGTERM.")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// This will use the in-memory version (/proc/self/exe) of the current binary,")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// it is thus safe to delete or replace the on-disk binary (os.Args[0]).")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("Command")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("args "),n("span",{attrs:{class:"token operator"}},[t._v("...")]),n("span",{attrs:{class:"token builtin"}},[t._v("string")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("exec"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Cmd "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("exec"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Cmd"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tPath"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("Self")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tArgs"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" args"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tSysProcAttr"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SysProcAttr"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tPdeathsig"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SIGTERM"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br")])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[n("code",[t._v("reexec.Command")]),t._v(" 方法把所有的都联系了在一起，通过创建一个"),n("code",[t._v("*exex.Cmd")]),t._v("结构体，设置其"),n("code",[t._v("Path")]),t._v("为"),n("code",[t._v("Self()")]),t._v("（在Linux系统中，其值为"),n("code",[t._v("/proc/self/exe")]),t._v("，表示的正在执行的可执行程序）。我们可以通过传入的"),n("code",[t._v("args[0]")]),t._v("来选择被某个注册函数被"),n("code",[t._v("reexec")]),t._v("调用。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("现在我们理解了"),s("code",[this._v("reexec")]),this._v("的原理了，我们来动手实践一下。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"let-s-go"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#let-s-go","aria-hidden":"true"}},[this._v("#")]),this._v(" Let's Go")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("首先创建一个方法并且使用"),s("code",[this._v("reexec")]),this._v("来注册它。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("# Git repo"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("github"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("teddyking"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("container\n# Git tag"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("3.0")]),t._v("\n# Filename"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ns_process"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("go")]),t._v("\n# "),n("span",{attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("init")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\treexec"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Register")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"nsInitialisation"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nsInitialisation"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" reexec"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Init")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tos"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Exit")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n# "),n("span",{attrs:{class:"token operator"}},[t._v("...")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br")])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[t._v("这里有两个重要的点。一是我们用“nsInitialisation”注册了"),n("code",[t._v("nsInitialisation")]),t._v("方法。二是我们调用了"),n("code",[t._v("reexce.Init()")]),t._v("方法并且在返回"),n("code",[t._v("true")]),t._v("的时候结束进程("),n("code",[t._v("os.Exit(0)")]),t._v("，这一步是非常重要的，如果不退出将陷入无限循环，程序会不停的"),n("code",[t._v("reexec")]),t._v("它自己。接着我们增加"),n("code",[t._v("nsInitialisation")]),t._v("方法。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("# Git repo"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("github"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("bingbig"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("container\n# Git tag"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("3.0")]),t._v("\n# Filename"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" container"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("go")]),t._v("\n# "),n("span",{attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("nsInitialisation")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tfmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Printf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"\\n>> namespace setup code goes here <<\\n\\n"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token function"}},[t._v("nsRun")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("nsRun")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tcmd "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" exec"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Command")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("2")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token operator"}},[t._v("...")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\tcmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stdin "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stdin\n\tcmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stdout "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stdout\n\tcmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stderr "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stderr\n\n\tcmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Env "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token builtin"}},[t._v("string")]),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{attrs:{class:"token string"}},[t._v('"PS1=-[container]- # "')]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" cmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Run")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Printf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"Error running the %s command - %s\\n"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tos"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Exit")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("调用"),s("code",[this._v("nsInitialisation")]),this._v(" 后会调用"),s("code",[this._v("nsRun()")]),this._v(", 而后者会执行"),s("code",[this._v("/bin/sh")]),this._v("进程。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[t._v("最后我们需要做的就是修改"),n("code",[t._v("run()")]),t._v("方法，用"),n("code",[t._v("reexec")]),t._v(" 和 "),n("code",[t._v("nsInitialisation")]),t._v(" 来运行"),n("code",[t._v("/bin/sh")]),t._v("，而不是之前那样直接调用。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("div",{staticClass:"highlight-lines"},[n("br"),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br")]),n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("main")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("len")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("2")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{attrs:{class:"token function"}},[t._v("panic")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"pass me an argument please"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"run"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("len")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("3")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{attrs:{class:"token function"}},[t._v("panic")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"pass me a cmd to run in container please"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t"),n("span",{attrs:{class:"token function"}},[t._v("run")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("default")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\t"),n("span",{attrs:{class:"token function"}},[t._v("panic")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"pass me an argument please"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("run")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tcmd "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" reexec"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Command")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("append")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token builtin"}},[t._v("string")]),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{attrs:{class:"token string"}},[t._v('"nsInitialisation"')]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tos"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("2")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token operator"}},[t._v("...")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token operator"}},[t._v("...")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\tcmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stdin "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stdin\n\tcmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stdout "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stdout\n\tcmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stderr "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stderr\n\n\tcmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SysProcAttr "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SysProcAttr"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tCloneflags"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWNS "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("\n\t\t\tsyscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWUTS "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("\n\t\t\tsyscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWIPC "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("\n\t\t\tsyscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWPID "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("\n\t\t\tsyscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWNET "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("\n\t\t\tsyscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWUSER"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tUidMappings"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SysProcIDMap"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t\tContainerID"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t\tHostID"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("      os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Getuid")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t\tSize"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("        "),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tGidMappings"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SysProcIDMap"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t\tContainerID"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t\tHostID"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("      os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Getgid")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t\tSize"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("        "),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" cmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Run")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Printf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"Error running the reexec.Command - %s\\n"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tos"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Exit")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br"),n("span",{staticClass:"line-number"},[t._v("28")]),n("br"),n("span",{staticClass:"line-number"},[t._v("29")]),n("br"),n("span",{staticClass:"line-number"},[t._v("30")]),n("br"),n("span",{staticClass:"line-number"},[t._v("31")]),n("br"),n("span",{staticClass:"line-number"},[t._v("32")]),n("br"),n("span",{staticClass:"line-number"},[t._v("33")]),n("br"),n("span",{staticClass:"line-number"},[t._v("34")]),n("br"),n("span",{staticClass:"line-number"},[t._v("35")]),n("br"),n("span",{staticClass:"line-number"},[t._v("36")]),n("br"),n("span",{staticClass:"line-number"},[t._v("37")]),n("br"),n("span",{staticClass:"line-number"},[t._v("38")]),n("br"),n("span",{staticClass:"line-number"},[t._v("39")]),n("br"),n("span",{staticClass:"line-number"},[t._v("40")]),n("br"),n("span",{staticClass:"line-number"},[t._v("41")]),n("br"),n("span",{staticClass:"line-number"},[t._v("42")]),n("br"),n("span",{staticClass:"line-number"},[t._v("43")]),n("br"),n("span",{staticClass:"line-number"},[t._v("44")]),n("br"),n("span",{staticClass:"line-number"},[t._v("45")]),n("br"),n("span",{staticClass:"line-number"},[t._v("46")]),n("br"),n("span",{staticClass:"line-number"},[t._v("47")]),n("br"),n("span",{staticClass:"line-number"},[t._v("48")]),n("br"),n("span",{staticClass:"line-number"},[t._v("49")]),n("br"),n("span",{staticClass:"line-number"},[t._v("50")]),n("br"),n("span",{staticClass:"line-number"},[t._v("51")]),n("br"),n("span",{staticClass:"line-number"},[t._v("52")]),n("br")])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[t._v("将"),n("code",[t._v("nsInitialisation")]),t._v(" 作为第一个参数传递给"),n("code",[t._v("Command")]),t._v("，本质上是告诉"),n("code",[t._v("reexec")]),t._v("去执行 "),n("code",[t._v("/proc/self/exe")]),t._v("，并且将"),n("code",[t._v("os.Args[0]")]),t._v("参数的值设置为"),n("code",[t._v("nsInitialisation")]),t._v("。最终，一旦程序被重新执行，"),n("code",[t._v("Init")]),t._v("会检测到注册的函数并执行它。我们来实践一下，")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ go build\n$ ./container run /bin/sh\n\n"),n("span",{attrs:{class:"token operator"}},[t._v(">>")]),t._v(" namespace setup code goes here "),n("span",{attrs:{class:"token operator"}},[t._v("<<")]),t._v("\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("#")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("成功了！我们现在有"),s("code",[this._v("nsInitialisation")]),this._v(" 方法帮助我们初始化任意的命名空间了。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"接下来"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#接下来","aria-hidden":"true"}},[this._v("#")]),this._v(" 接下来")])}],!1,null,null,null);e.options.__file="namespaces_in_go_reexec.md";s.default=e.exports}}]);