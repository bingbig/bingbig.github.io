(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{235:function(t,s,a){t.exports=a.p+"assets/img/redis_init.c32d751a.png"},316:function(t,s,a){"use strict";a.r(s);var n=[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"redis启动流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#redis启动流程","aria-hidden":"true"}},[this._v("#")]),this._v(" Redis启动流程")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("阅读一个C项目，直接从"),s("code",[this._v("main")]),this._v("函数入手是一个很不错的选择。通过梳理"),s("code",[this._v("redis.c")]),this._v("中的"),s("code",[this._v("main")]),this._v("函数逻辑，我们可以很清晰的了解到redis启动过程中主要流程。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(235),alt:"启动流程图"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("上图只简略的列出了主要的函数，下面我们跟着"),s("code",[this._v("main")]),this._v("函数一步步学习redis启动的过程。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"spt-init"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#spt-init","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("spt_init")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("处理了参数和环境变量后，redis陆续执行了一些系列的修改和定义："),a("code",[t._v("setlocale")]),t._v("（设置地域），"),a("code",[t._v("zmalloc_set_oom_handler")]),t._v("(设置内存不足时的操作),"),a("code",[t._v("srand")]),t._v("(初始化随机种子), "),a("code",[t._v("gettimeofday")]),t._v(", "),a("code",[t._v("getRandomHexChars")]),t._v(","),a("code",[t._v("dictSetHashFunctionSeed")]),t._v("等等。之后redis检查执行的可执行文件名是否是"),a("code",[t._v("redis-sentinel")]),t._v("或者参数中包含"),a("code",[t._v("--sentinel")]),t._v("，如果是的话redis将进入"),a("code",[t._v("哨兵模式")]),t._v("，进而转入哨兵模式的执行流程中。本文我们只讨论redis普通节点的启动过程。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"initserverconfig"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#initserverconfig","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("initServerConfig( )")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"argc-argv"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#argc-argv","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("argc")]),this._v(" & "),s("code",[this._v("argv")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("在这一步中，redis检查传入的各项参数，读取并解析配置文件（"),s("code",[this._v("loadServerConfig")]),this._v("）。如果没有配置redis为"),s("code",[this._v("supervised")]),this._v("模式，并且指定了后台运行redis时，redis执行进入后台的方法：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("background"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("daemonize")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("redis是如何将自己转变成为守护进程的呢？下面我们展开看看"),s("code",[this._v("daemonize()")]),this._v("：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("daemonize")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" fd"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token function"}},[t._v("fork")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("exit")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* parent exits */")]),t._v("\n    "),a("span",{attrs:{class:"token function"}},[t._v("setsid")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* create a new session */")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* Every output goes to /dev/null. If Redis is daemonized but\n     * the 'logfile' is set to 'stdout' in the configuration file\n     * it will not log at all. */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fd "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("open")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v('"/dev/null"')]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" O_RDWR"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("dup2")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fd"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" STDIN_FILENO"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("dup2")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fd"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" STDOUT_FILENO"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("dup2")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fd"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" STDERR_FILENO"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fd "),a("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" STDERR_FILENO"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("close")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fd"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"initserver"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#initserver","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("initServer( )")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token function"}},[t._v("signal")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SIGHUP"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SIG_IGN"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token function"}},[t._v("signal")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SIGPIPE"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SIG_IGN"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token function"}},[t._v("setupSignalHandlers")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ul",[a("li",[a("code",[t._v("signal(SIGHUP, SIG_IGN)")]),t._v("  redis多作为守护进程运行，这时其不会有控制终端，首先忽略掉SIGHUP信号。")]),t._v(" "),a("li",[a("code",[t._v("signal(SIGPIPE, SIG_IGN)")]),t._v(" TCP是全双工的信道，可以看作两条单工信道， TCP连接两端的两个端点各负责一条。 当对端调用close时， 虽然本意是关闭整个两条信道， 但本端只是收到FIN包。按照TCP协议的语义，表示对端只是关闭了其所负责的那一条单工信道，仍然可以继续接收数据。也就是说，因为TCP协议的限制，一个端点无法获知对端的"),a("code",[t._v("socket")]),t._v("是调用了"),a("code",[t._v("close")]),t._v("还是"),a("code",[t._v("shutdown")]),t._v("。对一个已经收到FIN包的socket调用read方法，如果接收缓冲已空，则返回0，这就是常说的表示连接关闭。但第一次对其调用write方法时，如果发送缓冲没问题，会返回正确写入(发送)。但发送的报文会导致对端发送RST报文，因为对端的socket已经调用了close，完全关闭，既不发送，也不接收数据。所以第二次调用write方法(假设在收到RST之后)，会生成SIGPIPE信号，导致进程退出。"),a("strong",[t._v("为了避免进程退出, 可以捕获SIGPIPE信号, 或者忽略它, 给它设置SIG_IGN信号处理函数")]),t._v("。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"createsharedobjects"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#createsharedobjects","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("createSharedObjects")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"adjustopenfileslimit"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#adjustopenfileslimit","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("adjustOpenFilesLimit")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("该函数主要检查下系统的可允许打开文件句柄数，对于redis来说至少要32("),s("code",[this._v("CONFIG_MIN_RESERVED_FDS")]),this._v(")个文件句柄，如果检测到环境不合适，会去修改环境变量，以适合redis的运行。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"aecreateeventloop"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aecreateeventloop","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("aeCreateEventLoop")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("server"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("el "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("aeCreateEventLoop")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("server"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("maxclients"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v("CONFIG_FDSET_INCR"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("宏"),a("code",[t._v("CONFIG_FDSET_INCR")]),t._v("展开是"),a("code",[t._v("CONFIG_MIN_RESERVED_FDS+96")]),t._v("，初始化event loop时，redis作者antirez设置"),a("code",[t._v("总的描述符数")]),t._v(" = server.maxclients + "),a("code",[t._v("RESERVED_FDS")]),t._v(" + "),a("code",[t._v("富余的数目")]),t._v("（保证安全），"),a("code",[t._v("RESERVED_FDS")]),t._v(" 默认为32。\n这个函数很重要，redis的事件对象就是在这个函数里面创建的，包括一些高并发异步机制对象也是在这里面初始化的。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("aeEventLoop "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("aeCreateEventLoop")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" setsize"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    aeEventLoop "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("eventLoop"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" i"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eventLoop "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("zmalloc")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("eventLoop"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("goto")]),t._v(" err"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("events "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("zmalloc")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("aeFileEvent"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("setsize"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("fired "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("zmalloc")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("aeFiredEvent"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("setsize"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("events "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("||")]),t._v(" eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("fired "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("goto")]),t._v(" err"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("setsize "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" setsize"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("lastTime "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("time")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("timeEventHead "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("timeEventNextId "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("stop "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("maxfd "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("beforesleep "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("aftersleep "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token function"}},[t._v("aeApiCreate")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eventLoop"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("goto")]),t._v(" err"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* Events with mask == AE_NONE are not set. So let's initialize the\n     * vector with it. */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),a("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v(" setsize"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),a("span",{attrs:{class:"token operator"}},[t._v("++")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("events"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mask "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" AE_NONE"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" eventLoop"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nerr"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eventLoop"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("zfree")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("events"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("zfree")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("fired"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("zfree")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eventLoop"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("aeApiCreate")]),this._v("是作者封装的I/O多路复用函数中的一个。对于异步机制的选择，按性能的高到低的顺序排列可以看到redis是这样一个顺序\n"),s("code",[this._v("evport -> epoll -> kqueue -> select")]),this._v("。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* 选择系统最佳的I/O多路复用函数库。按性能的高到低的顺序排列 */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("ifdef")]),t._v(" HAVE_EVPORT")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v('"ae_evport.c"')]),t._v(" ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Solaris系统内核提供支持的 */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("else")])]),t._v("\n    "),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("ifdef")]),t._v(" HAVE_EPOLL")]),t._v("\n    "),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v('"ae_epoll.c"')]),t._v(" ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* LINUX系统内核提供支持的 */")]),t._v("\n    "),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("else")])]),t._v("\n        "),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("ifdef")]),t._v(" HAVE_KQUEUE")]),t._v("\n        "),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v('"ae_kqueue.c"')]),t._v(" ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Mac 系统提供支持的 */")]),t._v("\n        "),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("else")])]),t._v("\n        "),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v('"ae_select.c"')]),t._v(" ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* 是POSIX提供的， 一般的操作系统都有支撑 */")]),t._v("\n        "),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("endif")])]),t._v("\n    "),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("endif")])]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("endif")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"listentoport"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#listentoport","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("listenToPort")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token function"}},[t._v("listenToPort")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("server"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("port"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("server"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ipfd"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("server"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ipfd_count"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("全局结构体对象"),a("code",[t._v("server")]),t._v("的成员"),a("code",[t._v("bindaddr")]),t._v("中保存了要绑定和监听的IP（可以是多个），"),a("code",[t._v("listenToPort")]),t._v("依次绑定这些IP和"),a("code",[t._v("server.port")]),t._v("端口。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"anetunixserver"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#anetunixserver","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("anetUnixServer")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"evictionpoolalloc"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#evictionpoolalloc","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("evictionPoolAlloc")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("初始化"),s("code",[this._v("LRU")]),this._v("键池。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"aecreatetimeevent"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aecreatetimeevent","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("aeCreateTimeEvent")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("这个函数主要作为定时任务的注册，在这里redis注册了"),s("code",[this._v("serverCron()")]),this._v("的定时任务，时间间隔是1毫秒，再执行一次之后就会对时间间隔进行重新设定。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"aecreatefileevent"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aecreatefileevent","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("aeCreateFileEvent")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("创建文件事件。将之前监听的"),a("code",[t._v("TCP socket")]),t._v("和"),a("code",[t._v("unix socket")]),t._v("描述符加入到文件事件链表中，而且是只读事件，并分别绑定事件的读操作为"),a("code",[t._v("acceptTcpHandler")]),t._v("和"),a("code",[t._v("acceptUnixHandler")]),t._v("。当有新的连接到来时，监听描述符的可读，redis会执行"),a("code",[t._v("acceptTcpHandler")]),t._v("或"),a("code",[t._v("acceptUnixHandler")]),t._v("来接受新的TCP或unix域连接请求。对于TCP连接来说，接受连接并处理请求的流程如下：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token function"}},[t._v("acceptTcpHandler")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("anetTcpAccept")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("acceptCommonHandler")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("createClient")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("linkClient")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[a("code",[t._v("acceptTcpHandler")]),t._v("调用"),a("code",[t._v("anetTcpAccept")]),t._v("（封装了"),a("code",[t._v("accept")]),t._v("函数）从已经完成连接的队列头返回一个已完成连接，如果成功继续调用"),a("code",[t._v("acceptCommonHandler")]),t._v("方法。"),a("code",[t._v("acceptCommonHandler")]),t._v("方法会调用"),a("code",[t._v("createClient")]),t._v("方法在server端创建并初始化客户端对象，最后加入到"),a("code",[t._v("server.clients")]),t._v("链表表尾后。下面列出了客户端对象初始化的部分代码。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c {8,9,13-20,23, 32} line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("client "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("createClient")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" fd"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    client "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("c "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("zmalloc")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("client"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* \n     * 在其他上下文环境下执行命令时（比如通过Lua脚本），我们需要一个非连接的客户端，可以通过传入-1作为描述符来创建。\n     */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fd "),a("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("anetNonBlock")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("fd"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 设置描述符为非阻塞 */")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("anetEnableTcpNoDelay")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("fd"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{attrs:{class:"token comment"}},[t._v("/* 设置描述符为非延迟TCP */")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("server"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tcpkeepalive"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),a("span",{attrs:{class:"token function"}},[t._v("anetKeepAlive")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("fd"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("server"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tcpkeepalive"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{attrs:{class:"token comment"}},[t._v("/* 为客户端创建可读文件事件，并传入可读时的操作readQueryFromClient */")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token function"}},[t._v("aeCreateFileEvent")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("server"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("el"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("fd"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("AE_READABLE"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            readQueryFromClient"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" c"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" AE_ERR"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token function"}},[t._v("close")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fd"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token function"}},[t._v("zfree")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{attrs:{class:"token function"}},[t._v("selectDb")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 默认选择第0个数据库 */")]),t._v("\n    uint64_t client_id"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token function"}},[t._v("atomicGetIncr")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("server"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("next_client_id"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("client_id"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    c"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("id "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" client_id"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    c"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("fd "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" fd"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    c"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("name "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fd "),a("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("linkClient")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token function"}},[t._v("initClientMultiState")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 为客户端执行MULTI/EXEC命令做初始化 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" c"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("在初始化客户端对象时，redis为这个客户端创建了相应的可读文件事件，并指定了描述符可读时的操作"),s("code",[this._v("readQueryFromClient")]),this._v("。当服务端接收到来自客户端的数据时，继而该已连接描述符可读，redis调用"),s("code",[this._v("readQueryFromClient")]),this._v("读取客户端发来的命令并执行相应的操作。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"replicationscriptcacheinit"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#replicationscriptcacheinit","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("replicationScriptCacheInit")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"scriptinginit"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#scriptinginit","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("scriptingInit")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"slowloginit"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#slowloginit","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("slowlogInit")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"latencymonitorinit"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#latencymonitorinit","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("latencyMonitorInit")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"bioinit"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#bioinit","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("bioInit")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"aemain"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aemain","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("aeMain")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("在执行完"),s("code",[this._v("initServer()")]),this._v("之后，redis时初始化进入尾声，但仍需要完成一些其他的工作：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token function"}},[t._v("createPidFile")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("redisSetProcTitle")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("argv"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("redisAsciiArt")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("checkTcpBacklogSettings")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),a("span",{attrs:{class:"token function"}},[t._v("aeSetBeforeSleepProc")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("aeSetAfterSleepProc")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("aeMain")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("最终到达redis的核心"),s("code",[this._v("aeMain()")]),this._v("函数，进入时间循环主函数，永不退出，除非服务被终止。函数代码如下：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("aeMain")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("aeEventLoop "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("eventLoop"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("stop "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("!")]),t._v("eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("stop"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("beforesleep "),a("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            eventLoop"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),a("span",{attrs:{class:"token function"}},[t._v("beforesleep")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eventLoop"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("aeProcessEvents")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eventLoop"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" AE_ALL_EVENTS"),a("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("AE_CALL_AFTER_SLEEP"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"参考资料"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考资料","aria-hidden":"true"}},[this._v("#")]),this._v(" 参考资料")])}],e=a(0),r=Object(e.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),t._m(3),t._v(" "),t._m(4),t._v(" "),a("p",[t._v("处理进程启动时的参数和环境变量，以便于后期修改进程名。为什么改个程序名要如此大费周折呢，那是因为"),a("code",[t._v("agrv")]),t._v("和"),a("code",[t._v("environ")]),t._v("是连续存储的。我找了些相关的资料可以查阅："),a("a",{attrs:{href:"https://www.jianshu.com/p/36c301ac87df",target:"_blank",rel:"noopener noreferrer"}},[t._v("redis里的小秘密:设置进程名"),a("OutboundLink")],1),t._v("，"),a("a",{attrs:{href:"https://blog.csdn.net/hengshan/article/details/7835981",target:"_blank",rel:"noopener noreferrer"}},[t._v("Linux修改进程名称(setproctitle())"),a("OutboundLink")],1),t._v("。")]),t._v(" "),t._m(5),t._v(" "),t._m(6),t._v(" "),a("p",[t._v("这一步主要是在初始化全局的"),a("code",[t._v("server")]),t._v("("),a("router-link",{attrs:{to:"./server.html"}},[t._v("上一篇")]),t._v(")对象中的各个数据成员。为下一步解析参数和配置文件做好准备。")],1),t._v(" "),t._m(7),t._v(" "),t._m(8),t._v(" "),t._m(9),t._m(10),t._v(" "),t._m(11),a("p",[t._v("redis先"),a("code",[t._v("fork")]),t._v("出一个子进程，并退出父进程，以此断开和终端的交互。"),a("code",[t._v("STDIN_FILENO")]),t._v("(STDIN_FILENO = 0)，"),a("code",[t._v("STDOUT_FILENO")]),t._v("(STDOUT_FILENO = 1)和"),a("code",[t._v("STDERR_FILENO")]),t._v("(STDERR_FILENO = 2)文件句柄分别与标准输入，标准输出，标准错误输出相关联，所以用户应用程序调用"),a("code",[t._v("open")]),t._v("函数打开文件时，默认都是以"),a("code",[t._v("3")]),t._v("索引为开始句柄。将标准输入，标准输出，标准错误输出都定向（"),a("a",{attrs:{href:"https://linux.die.net/man/2/dup2",target:"_blank",rel:"noopener noreferrer"}},[t._v("dup2()"),a("OutboundLink")],1),t._v("）到"),a("code",[t._v("fd")]),t._v("对应的"),a("code",[t._v("/dev/null")]),t._v("中，然后关闭"),a("code",[t._v("fd")]),t._v("。执行完此操作后，后台模式运行的redis继续执行后面的流程。")]),t._v(" "),t._m(12),t._v(" "),a("p",[t._v("在这一步中，redis首先对信号做了一些处理：")]),t._v(" "),t._m(13),t._m(14),t._v(" "),t._m(15),t._v(" "),a("p",[t._v("然后redis继续初始化全局的"),a("code",[t._v("server")]),t._v("("),a("router-link",{attrs:{to:"./server.html"}},[t._v("上一篇")]),t._v(")对象，并在里面初始化了全局的"),a("code",[t._v("shared")]),t._v("对象（"),a("code",[t._v("createSharedObjects(void)")]),t._v("）。"),a("code",[t._v("createSharedObjects")]),t._v(" 这个函数主要是创建一些共享的全局对象。我们平时在跟redis服务交互的时候，如果有遇到错误，会收到一些固定的错误信息或者字符串比如："),a("code",[t._v("-ERR syntax error，-ERR no such key")]),t._v("，这些字符串对象都是在这个函数里面进行初始化的，此外，redis还初始化了"),a("code",[t._v("OBJ_SHARED_INTEGERS")]),t._v("（默认为10,000）个整数对象用于共享。")],1),t._v(" "),t._m(16),t._v(" "),t._m(17),t._v(" "),t._m(18),t._v(" "),t._m(19),t._m(20),t._v(" "),t._m(21),t._m(22),t._v(" "),t._m(23),t._m(24),t._v(" "),t._m(25),t._m(26),t._v(" "),t._m(27),t._v(" "),a("p",[t._v("这个函数则是启动uinx socket的监听。")]),t._v(" "),t._m(28),t._v(" "),t._m(29),t._v(" "),t._m(30),t._v(" "),t._m(31),t._v(" "),t._m(32),t._v(" "),t._m(33),t._v(" "),t._m(34),t._m(35),t._v(" "),t._m(36),t._m(37),t._v(" "),a("p",[t._v("在创建初始的文件和时间事件后，redis继续后面的初始化：")]),t._v(" "),t._m(38),t._v(" "),t._m(39),t._v(" "),t._m(40),t._v(" "),t._m(41),t._v(" "),t._m(42),t._v(" "),a("p",[t._v("后台I/O服务初始化。创建3个功能互不影响的线程，每个线程都有一个工作队列。主线程生产任务放到任务队里，这三个线程消费这些任务。任务队列和取出消费的时候都得加锁，防止竞争，使用条件变量来等待任务以及通知。")]),t._v(" "),t._m(43),t._v(" "),t._m(44),t._v(" "),t._m(45),t._m(46),t._v(" "),t._m(47),a("p",[a("code",[t._v("aeMain()")]),t._v("循环调用"),a("code",[t._v("aeProcessEvents()")]),t._v("来不停的处理事件（时间事件和文件事件）。那么，redis是如何高效快速处理这两种事件的呢？这就要好好读一读"),a("code",[t._v("Redis事件驱动")]),t._v("（"),a("router-link",{attrs:{to:"./event_driven_library.html"}},[t._v("下一篇")]),t._v("）的实现了。")],1),t._v(" "),t._m(48),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"http://www.ituring.com.cn/article/265187",target:"_blank",rel:"noopener noreferrer"}},[t._v("redis启动流程（一）"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"http://www.ituring.com.cn/article/196415",target:"_blank",rel:"noopener noreferrer"}},[t._v("redis启动流程（二）"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.jianshu.com/p/36c301ac87df",target:"_blank",rel:"noopener noreferrer"}},[t._v("redis里的小秘密:设置进程名"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://blog.csdn.net/hengshan/article/details/7835981",target:"_blank",rel:"noopener noreferrer"}},[t._v("Linux修改进程名称(setproctitle())"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://linux.die.net/man/2/dup2",target:"_blank",rel:"noopener noreferrer"}},[t._v("dup2()"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/ztteng/p/9773444.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("redis的多线程"),a("OutboundLink")],1)])])])},n,!1,null,null,null);r.options.__file="redisinit.md";s.default=r.exports}}]);