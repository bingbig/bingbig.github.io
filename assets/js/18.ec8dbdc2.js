(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{230:function(t,s,n){t.exports=n.p+"assets/img/1__C9oQxRBlIMuIoX8FOQ6XQ.d2ea5f64.jpeg"},248:function(t,s,n){"use strict";n.r(s);var a=[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"命名空间go实现-mount"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#命名空间go实现-mount","aria-hidden":"true"}},[this._v("#")]),this._v(" 命名空间Go实现 - Mount")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("本文我们将了解是什么使之成为可能 - 即 Mount命名空间和"),s("code",[this._v("pivot_root")]),this._v("系统调用的合作。我们先回顾之前的"),s("code",[this._v("container")]),this._v("的实现，并且运行它看看挂载的文件系统。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{attrs:{class:"token comment"}},[t._v("# Git repo: https://github.com/bingbig/container")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("# Git tag: 3.0")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("# Filename: container.go")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("# ...")]),t._v("\n$ go build\n$ ./container\n"),n("span",{attrs:{class:"token operator"}},[t._v(">>")]),t._v(" namespace setup code goes here "),n("span",{attrs:{class:"token operator"}},[t._v("<<")]),t._v("\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("# cat /proc/mounts")]),t._v("\n/dev/sda1 / ext4 rw,relatime,data"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("ordered 0 0\ntmpfs /dev/shm tmpfs rw,nosuid,nodev 0 0\nproc /proc proc rw,nosuid,nodev,noexec,relatime 0 0\n"),n("span",{attrs:{class:"token comment"}},[t._v("# ...")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("在 "),s("code",[this._v("/proc/mounts")]),this._v(" 文件下可以看到有几个挂载。这看起来有些奇怪，因为我们请求了新的Mount命名空间并且我们没有做任何Mount命名空间的初始化工作。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("blockquote",[s("p",[this._v("“When a process creates a new mount namespace using clone(2) or unshare(2) with the CLONE_NEWNS flag, the mount point list for the new namespace is a copy of the caller’s mount point list.”")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("看来这是一个特性，挂载点列表即使调用者的列表的拷贝。我们怎么解决这个问题呢？我们需要一些方法来清除新的命名空间里的宿主机的挂载清单来保证这些信息的安全，我们需要"),s("code",[this._v("pivot_root")]),this._v("。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:n(230),alt:"pivot_root"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"pivot-root"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pivot-root","aria-hidden":"true"}},[this._v("#")]),this._v(" pivot_root")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("pivot_root")]),this._v(" 运训你为调用的进程设置新的root文件系统，比如说它可以让你修改 "),s("code",[this._v("/")]),this._v("目录。它是通过把当前的root文件系统挂载到别的地方，同时把新的root文件系统挂载到"),s("code",[this._v("/")]),this._v("上。一旦之前的root被替换了，那么它就可以被卸载了。因此我们需要一个机制来从新的Mount命名空间清理主机的挂载——避开和卸载它们。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("这就是为什么我们可以在Ubuntu的主机上面运行一个CentOS的容器了。只要Ubuntu主机有CentOS的文件系统备份，我们就可以创建一个新的Mount命名空间，调用"),s("code",[this._v("pivot_root")]),this._v("执行这个CentOS文件系统然后在这个新的命名空间里面执行任何进程。这些进程会相信它们一直在CentOS上运行。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("正好我们前面讨论过的 "),s("code",[this._v("reexec")]),this._v(" 起到了作用。 "),s("code",[this._v("pivot_root")]),this._v(" 必须在新的Mount命名空间里面被调用。我们想要的就是在新命名空间中的shell开始前，需要的root文件系统就能够使用。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"pivot-root-实现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pivot-root-实现","aria-hidden":"true"}},[this._v("#")]),this._v(" pivot_root 实现")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("这个方法比较复杂，可以直接跳到下面的chroot实现")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("在Go语言中， "),s("code",[this._v("pivot_root")]),this._v(" 是通过 "),s("code",[this._v("syscall.PivotRoot")]),this._v(" 方法实现的。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("PivotRoot")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newroot "),n("span",{attrs:{class:"token builtin"}},[t._v("string")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" putold "),n("span",{attrs:{class:"token builtin"}},[t._v("string")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err "),n("span",{attrs:{class:"token builtin"}},[t._v("error")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[n("code",[t._v("newroot")]),t._v(" 是我们期望的新文件系统的路径， "),n("code",[t._v("putold")]),t._v(" 是我们想要把当前的root移动到的路径。在底层 "),n("code",[t._v("pivot_root")]),t._v(" 系统调用的时候一些对于"),n("code",[t._v("newroot")]),t._v(" 和 "),n("code",[t._v("putold")]),t._v(" 的强制性限制我们必须知道：")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ol",[n("li",[t._v("它们两个必须都是目录")]),t._v(" "),n("li",[t._v("它们不能和当前root在同一个文件系统")]),t._v(" "),n("li",[n("code",[t._v("putold")]),t._v("必须在"),n("code",[t._v("newroot")]),t._v("下面")]),t._v(" "),n("li",[t._v("没有其他的文件系统挂载在"),n("code",[t._v("putold")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("准备 "),s("code",[this._v("newroot")]),this._v(" 文件系统的过程可以说比较细节和复杂。比如说Docker的分层文件系统，许多的文件系统层连在一起组成一个完整的root。我们这里会简单的假设一个合适的root文件系统已经准备好了。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("# Git repo"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("github"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("teddyking"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("ns"),n("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("process\n# Git tag"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("4.0")]),t._v("\n$ mkdir "),n("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("p "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("tmp"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("ns"),n("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("process"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("rootfs\n$ tar "),n("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("C "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("tmp"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("ns"),n("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("process"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("rootfs "),n("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("xf assets"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("busybox"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tar\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("现在，"),s("code",[this._v("ns-process")]),this._v(" 会期望在这个目录下会有一个root文件系统并且在没有找到的时候报错。注意，尽管这里我们使用的是BusyBox作为这次的特例，你可以简答的使用其他的发行版本。我们有了我们的"),s("code",[this._v("newroot")]),this._v("，接下来看看如何使用。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("# Git repo"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("github"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("teddyking"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("ns"),n("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("process\n# Git tag"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("4.0")]),t._v("\n# Filename"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rootfs"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("go")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("pivotRoot")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newroot "),n("span",{attrs:{class:"token builtin"}},[t._v("string")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token builtin"}},[t._v("error")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tputold "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" filepath"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Join")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newroot"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"/.pivot_root"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),n("span",{attrs:{class:"token comment"}},[t._v("// bind mount newroot to itself - this is a slight hack")]),t._v("\n\t"),n("span",{attrs:{class:"token comment"}},[t._v("// needed to work around a pivot_root requirement")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Mount")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t\tnewroot"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tnewroot"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{attrs:{class:"token string"}},[t._v('""')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tsyscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MS_BIND"),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MS_REC"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{attrs:{class:"token string"}},[t._v('""')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token comment"}},[t._v("// create putold directory")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("MkdirAll")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("putold"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0700")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token comment"}},[t._v("// call pivot_root")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("PivotRoot")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newroot"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" putold"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token comment"}},[t._v("// ensure current working directory is set to new root")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Chdir")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token comment"}},[t._v("// umount putold, which now lives at /.pivot_root")]),t._v("\n\tputold "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"/.pivot_root"')]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Unmount")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t\tputold"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tsyscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MNT_DETACH"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token comment"}},[t._v("// remove putold")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("RemoveAll")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("putold"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br"),n("span",{staticClass:"line-number"},[t._v("28")]),n("br"),n("span",{staticClass:"line-number"},[t._v("29")]),n("br"),n("span",{staticClass:"line-number"},[t._v("30")]),n("br"),n("span",{staticClass:"line-number"},[t._v("31")]),n("br"),n("span",{staticClass:"line-number"},[t._v("32")]),n("br"),n("span",{staticClass:"line-number"},[t._v("33")]),n("br"),n("span",{staticClass:"line-number"},[t._v("34")]),n("br"),n("span",{staticClass:"line-number"},[t._v("35")]),n("br"),n("span",{staticClass:"line-number"},[t._v("36")]),n("br"),n("span",{staticClass:"line-number"},[t._v("37")]),n("br"),n("span",{staticClass:"line-number"},[t._v("38")]),n("br"),n("span",{staticClass:"line-number"},[t._v("39")]),n("br"),n("span",{staticClass:"line-number"},[t._v("40")]),n("br"),n("span",{staticClass:"line-number"},[t._v("41")]),n("br"),n("span",{staticClass:"line-number"},[t._v("42")]),n("br"),n("span",{staticClass:"line-number"},[t._v("43")]),n("br"),n("span",{staticClass:"line-number"},[t._v("44")]),n("br"),n("span",{staticClass:"line-number"},[t._v("45")]),n("br"),n("span",{staticClass:"line-number"},[t._v("46")]),n("br"),n("span",{staticClass:"line-number"},[t._v("47")]),n("br"),n("span",{staticClass:"line-number"},[t._v("48")]),n("br"),n("span",{staticClass:"line-number"},[t._v("49")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("pivotRoot")]),this._v("写好后我们在 "),s("code",[this._v("nsInitialisation")]),this._v(" 使用它。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("# Git repo"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("github"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("teddyking"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("ns"),n("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("process\n# Git tag"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("4.0")]),t._v("\n# Filename"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ns_process"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("go")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("nsInitialisation")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tnewrootPath "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("pivotRoot")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newrootPath"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Printf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"Error running pivot_root - %s\\n"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tos"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Exit")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token function"}},[t._v("nsRun")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("main")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("var")]),t._v(" rootfsPath "),n("span",{attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n\t"),n("span",{attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n\tcmd "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" reexec"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Command")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"nsInitialisation"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rootfsPath"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br")])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[t._v("我们可以看到，"),n("code",[t._v("rootfsPath")]),t._v("是传递给了"),n("code",[t._v("nsInitialisation")]),t._v("。 一旦 "),n("code",[t._v("reexec")]),t._v("执行了，这个参数可以从 "),n("code",[t._v("os.Args[1]")]),t._v(" 获取到。同时"),n("code",[t._v("pivotRoot")]),t._v("也是在"),n("code",[t._v("nsRun")]),t._v("之前被调用。通过这些我嗯可以确保新的root文件系统在"),n("code",[t._v("/bin/sh")]),t._v("进程启动前已经被"),n("code",[t._v("pivoted")]),t._v("了。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{attrs:{class:"token comment"}},[t._v("# Git repo: https://github.com/teddyking/ns-process")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("# Git tag: 4.0")]),t._v("\n$ go build\n$ ./ns-process\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("ns-process"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("# cat /proc/mounts")]),t._v("\ncat: can"),n("span",{attrs:{class:"token string"}},[t._v("'t open '")]),t._v("/proc/mounts': No such "),n("span",{attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("现在我们有个新的 "),s("code",[this._v("/")]),this._v("， 所以我们不再需要 "),s("code",[this._v("/proc/")]),this._v("！这实际上是一个好的事情，因为我们绝对看不到主机的挂载了，这也是我们一开始做这些工作的主要理由。我们再添加一个 "),s("code",[this._v("/proc")]),this._v(" 到我们的新的root中。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("# Git repo"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("github"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("teddyking"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("ns"),n("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("process\n# Git tag"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("4.1")]),t._v("\n# Filename"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rootfs"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("go")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("mountProc")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newroot "),n("span",{attrs:{class:"token builtin"}},[t._v("string")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token builtin"}},[t._v("error")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tsource "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"proc"')]),t._v("\n\ttarget "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" filepath"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Join")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newroot"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"/proc"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tfstype "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"proc"')]),t._v("\n\tflags "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),t._v("\n\tdata "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('""')]),t._v("\n\n\tos"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("MkdirAll")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("target"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0755")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Mount")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t\tsource"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\ttarget"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tfstype"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{attrs:{class:"token function"}},[t._v("uintptr")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("flags"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tdata"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("和 "),s("code",[this._v("pivotRoot")]),this._v("一样， "),s("code",[this._v("mountProc")]),this._v(" 也需要从 "),s("code",[this._v("nsInitialisation")]),this._v(" 中调用。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("# Git repo"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("github"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("teddyking"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("ns"),n("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("process\n# Git tag"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("4.1")]),t._v("\n# Filename"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ns_process"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("go")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("nsInitialisation")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tnewrootPath "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("mountProc")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newrootPath"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Printf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"Error mounting /proc - %s\\n"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tos"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Exit")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("pivotRoot")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newrootPath"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Printf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"Error running pivot_root - %s\\n"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tos"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Exit")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token function"}},[t._v("nsRun")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br")])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{attrs:{class:"token comment"}},[t._v("# Git repo: https://github.com/teddyking/ns-process")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("# Git tag: 4.1")]),t._v("\n$ go build\n$ ./ns-process\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("ns-process"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("# cat /proc/mounts")]),t._v("\n/dev/sda1 / ext4 rw,relatime,data"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("ordered 0 0\nproc /proc proc rw,nodev,relatime 0 0\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("看起来好多，宿主机的挂载点现在已经看不到了，我们有一个新的 "),s("code",[this._v("/proc")]),this._v("挂着上了可供使用。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"chroot"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#chroot","aria-hidden":"true"}},[this._v("#")]),this._v(" chroot")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[t._v("因为"),n("code",[t._v("/pro")]),t._v("目录下面包含了宿主机所有的进程运行信息，我们当然不希望容器可以看到这些。 "),n("code",[t._v("ps")]),t._v("命令会查看"),n("code",[t._v("/proc")]),t._v("目录所以我们的容器需要有自己"),n("code",[t._v("/proc")]),t._v("目录。Linux还有一个"),n("code",[t._v("chroot")]),t._v("命令，这个命令可以为进程修改root。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"chroot-实现版本"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#chroot-实现版本","aria-hidden":"true"}},[this._v("#")]),this._v(" chroot 实现版本")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("liub@HiBing➜container git:"),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("master"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" ✗ docker pull alpine:latest\nlatest: Pulling from library/alpine\nc9b1b535fdd9: Pull complete\nDigest: sha256:ab00606a42621fb68f2ed6ad3c88be54397f981a7b70a79db3d1172b11c4367d\nStatus: Downloaded newer image "),n("span",{attrs:{class:"token keyword"}},[t._v("for")]),t._v(" alpine:latest\ndocker.io/library/alpine:latest\nliub@HiBing➜container git:"),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("master"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" ✗ docker image inspect alpine:latest -f ‘"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v(".GraphDriver.Data.UpperDir"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("’\n‘/var/lib/docker/overlay2/9d94cca2b565e428870aa3225be2f1e42f4ee65a834805f93dde1a44176e709b/diff’\nliub@HiBing➜container git:"),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("master"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" ✗ "),n("span",{attrs:{class:"token function"}},[t._v("cp")]),t._v(" -r /var/lib/docker/overlay2/9d94cca2b565e428870aa3225be2f1e42f4ee65a834805f93dde1a44176e709b/diff /root/containerFS\nliub@HiBing➜container git:"),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("master"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" ✗ "),n("span",{attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /root/containerFS/helloContainer "),n("span",{attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("ls")]),t._v(" /root/containerFS/\nbin  dev  etc  helloContainer  home  lib  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br")])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("# Git repo"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("github"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("bingbig"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("container\n# Git tag"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("4.0")]),t._v("\n# Filename"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" container"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("go")]),t._v("\n# "),n("span",{attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("nsInitialisation")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tfmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Printf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"\\n>> namespace setup code goes here <<\\n\\n"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),n("span",{attrs:{class:"token function"}},[t._v("setMount")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/root/containerFS"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),n("span",{attrs:{class:"token function"}},[t._v("nsRun")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("setMount")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root "),n("span",{attrs:{class:"token builtin"}},[t._v("string")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token builtin"}},[t._v("error")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Chroot")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{attrs:{class:"token comment"}},[t._v("// 设置容器里面的当前工作目录")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Chdir")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br")])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("liub@HiBing➜container git:"),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("master"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" ✗ go run container.go run /bin/bash\n\n"),n("span",{attrs:{class:"token operator"}},[t._v(">>")]),t._v(" namespace setup code goes here "),n("span",{attrs:{class:"token operator"}},[t._v("<<")]),t._v("\n\nError running the /bin/bash "),n("span",{attrs:{class:"token function"}},[t._v("command")]),t._v(" - fork/exec /bin/bash: no such "),n("span",{attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory\nError running the reexec.Command - "),n("span",{attrs:{class:"token keyword"}},[t._v("exit")]),t._v(" status 1\n"),n("span",{attrs:{class:"token keyword"}},[t._v("exit")]),t._v(" status 1\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("失败了！！！为什么呢？这是因为我们把root切到了alphine，这个镜像里面没有"),s("code",[this._v("bash")]),this._v("，我们试试"),s("code",[this._v("sh")]),this._v("。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("liub@HiBing➜container git:"),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("master"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" ✗ go run container.go run /bin/sh\n\n"),n("span",{attrs:{class:"token operator"}},[t._v(">>")]),t._v(" namespace setup code goes here "),n("span",{attrs:{class:"token operator"}},[t._v("<<")]),t._v("\n\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("# ls")]),t._v("\nbin             etc             home            media           opt             root            sbin            sys             usr\ndev             helloContainer  lib             mnt             proc            run             srv             tmp             var\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("我们已经成功的替换了我们的容器的文件系统了，我们再里面试试"),s("code",[this._v("ps")]),this._v("。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("# ps")]),t._v("\nPID   USER     TIME  COMMAND\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("# ls /proc")]),t._v("\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("#")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("都是空的。因为"),s("code",[this._v("/proc")]),this._v("是一个假的文件系统，用来在用户空间和内核空间交换数据。我们应该把主机的"),s("code",[this._v("/proc")]),this._v("挂载上。容器退出时再卸载"),s("code",[this._v("/proc")]),this._v("。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("div",{staticClass:"highlight-lines"},[n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("br"),n("br")]),n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("# Git repo"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("github"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("bingbig"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("container\n# Git tag"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("4.0")]),t._v("\n# Filename"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" container"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("go")]),t._v("\n# "),n("span",{attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("setMount")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root "),n("span",{attrs:{class:"token builtin"}},[t._v("string")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token builtin"}},[t._v("error")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Chroot")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{attrs:{class:"token comment"}},[t._v("// 设置容器里面的当前工作目录")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Chdir")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Mount")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"proc"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"proc"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"proc"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('""')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("nsRun")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tcmd "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" exec"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Command")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("2")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token operator"}},[t._v("...")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\tcmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stdin "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stdin\n\tcmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stdout "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stdout\n\tcmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stderr "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stderr\n\n\tcmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Env "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token builtin"}},[t._v("string")]),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{attrs:{class:"token string"}},[t._v('"PS1=-[container]- # "')]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" cmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Run")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Printf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"Error running the %s command - %s\\n"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tos"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Exit")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\tsyscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Unmount")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/proc"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br"),n("span",{staticClass:"line-number"},[t._v("28")]),n("br"),n("span",{staticClass:"line-number"},[t._v("29")]),n("br"),n("span",{staticClass:"line-number"},[t._v("30")]),n("br"),n("span",{staticClass:"line-number"},[t._v("31")]),n("br"),n("span",{staticClass:"line-number"},[t._v("32")]),n("br"),n("span",{staticClass:"line-number"},[t._v("33")]),n("br"),n("span",{staticClass:"line-number"},[t._v("34")]),n("br"),n("span",{staticClass:"line-number"},[t._v("35")]),n("br"),n("span",{staticClass:"line-number"},[t._v("36")]),n("br")])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("# ps -a")]),t._v("\nPID   USER     TIME  COMMAND\n    1 root      0:00 "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("exe"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" nsInitialisation /bin/sh\n    4 root      0:00 /bin/sh\n    5 root      0:00 "),n("span",{attrs:{class:"token function"}},[t._v("ps")]),t._v(" -a\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br")])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("# mount | grep /proc")]),t._v("\nproc on /proc "),n("span",{attrs:{class:"token function"}},[t._v("type")]),t._v(" proc "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rw,nosuid,nodev,noexec,relatime"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nsystemd-1 on /proc/sys/fs/binfmt_misc "),n("span",{attrs:{class:"token function"}},[t._v("type")]),t._v(" autofs "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rw,relatime,fd"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("22,pgrp"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("0,timeout"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("0,minproto"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("5,maxproto"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("5,direct,pipe_ino"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("10516"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nproc on /proc "),n("span",{attrs:{class:"token function"}},[t._v("type")]),t._v(" proc "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rw,relatime"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("# df -h")]),t._v("\nFilesystem                Size      Used Available Use% Mounted on\n/dev/vda1                39.2G      7.0G     30.4G  19% /\ndevtmpfs                 39.2G      7.0G     30.4G  19% /dev\ndf: /dev/shm: No such "),n("span",{attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory\ndf: /dev/pts: No such "),n("span",{attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory\ndf: /dev/hugepages: No such "),n("span",{attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory\ndf: /dev/mqueue: No such "),n("span",{attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory\nsysfs                    39.2G      7.0G     30.4G  19% /sys\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\ntmpfs                    39.2G      7.0G     30.4G  19% /run\ndf: /run/user/0: No such "),n("span",{attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory\ndf: /run/user/1003: No such "),n("span",{attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory\ndf: /run/user/1005: No such "),n("span",{attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("我们还可以看到主机的挂载，我们还应该"),s("code",[this._v("unshare")]),this._v("。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("div",{staticClass:"highlight-lines"},[n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br")]),n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("# Git repo"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("github"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("bingbig"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("container\n# Git tag"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("4.0")]),t._v("\n# Filename"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" container"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("go")]),t._v("\n# "),n("span",{attrs:{class:"token operator"}},[t._v("...")]),t._v("\ncmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SysProcAttr "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SysProcAttr"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tCloneflags"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWNS "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("\n\t\t\tsyscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWUTS "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("\n\t\t\tsyscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWIPC "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("\n\t\t\tsyscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWPID "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("\n\t\t\tsyscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWNET "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("\n\t\t\tsyscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWUSER"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tUnshareflags"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWNS"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tUidMappings"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SysProcIDMap"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t\tContainerID"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t\tHostID"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("      os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Getuid")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t\tSize"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("        "),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tGidMappings"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SysProcIDMap"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t\tContainerID"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t\tHostID"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("      os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Getgid")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t\tSize"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("        "),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"pid-命名空间"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pid-命名空间","aria-hidden":"true"}},[this._v("#")]),this._v(" PID 命名空间")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[t._v("上面的实现对PID命名空间的初始化也有无意的影响。在挂载新的"),n("code",[t._v("/proc")]),t._v("之前，在新的命名空间执行"),n("code",[t._v("ps")]),t._v("命令会把主机的所有进程列出来，这是因为 "),n("code",[t._v("ps")]),t._v(" 命令依赖于 "),n("code",[t._v("/proc")]),t._v(" 来检测正在运行的进程。但是现在我们有自己的"),n("code",[t._v("/proc")]),t._v("（并且我们传入了"),n("code",[t._v("CLONE_NEWPID")]),t._v(" flag 请求新的PID 命名空间）， 执行 "),n("code",[t._v("ps")]),t._v(" 只会展示和我们相关的进程。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{attrs:{class:"token comment"}},[t._v("# Git repo: https://github.com/bingbig/container")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("# Git tag: 4.0")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("# Filename: container.go")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("# ...")]),t._v("\n$ go build\n$ ./container\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("# ps")]),t._v("\nPID   USER     TIME   COMMAND\n    1 root       0:00 "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("exe"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" nsInitialisation /tmp/container/rootfs\n    5 root       0:00 /bin/sh\n    8 root       0:00 "),n("span",{attrs:{class:"token function"}},[t._v("ps")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"接下来"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#接下来","aria-hidden":"true"}},[this._v("#")]),this._v(" 接下来")])}],r=n(0),e=Object(r.a)({},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[t._m(0),t._v(" "),n("p",[t._v("现今容器的实现其重要的特性之一就是可以在同一个宿主机上运行不同linux发行版本。")]),t._v(" "),t._m(1),t._v(" "),t._m(2),t._m(3),t._v(" "),n("p",[t._v("这看起来非常不容器。我们的命名空间程序应该对宿主机的信息知道的越少越好，并且肯定不能看到宿主机的所有的挂载列表。然而为什么可以呢？在"),n("a",{attrs:{href:"http://man7.org/linux/man-pages/man7/mount_namespaces.7.html",target:"_blank",rel:"noopener noreferrer"}},[n("code",[t._v("mount_namespaces(7)")]),t._v("页"),n("OutboundLink")],1),t._v("我们可以看到解释。")]),t._v(" "),t._m(4),t._v(" "),t._m(5),t._v(" "),t._m(6),t._v(" "),t._m(7),t._v(" "),t._m(8),t._v(" "),t._m(9),t._v(" "),t._m(10),t._v(" "),t._m(11),t._v(" "),t._m(12),t._v(" "),t._m(13),t._v(" "),t._m(14),t._m(15),t._v(" "),t._m(16),t._v(" "),t._m(17),t._v(" "),t._m(18),t._m(19),t._v(" "),t._m(20),t._m(21),t._v(" "),t._m(22),t._m(23),t._v(" "),n("p",[t._v("完成了这些我们再更新我们的Go程序，然后看看当前有哪些挂载可见。")]),t._v(" "),t._m(24),t._m(25),t._v(" "),t._m(26),t._m(27),t._v(" "),t._m(28),n("p",[t._v("现在应该都好了，我们再试试。")]),t._v(" "),t._m(29),t._m(30),t._v(" "),t._m(31),t._v(" "),t._m(32),t._v(" "),t._m(33),t._v(" "),n("p",[t._v("首先我们献给我们的容器准备系统镜像，我们选择的是alphine。")]),t._v(" "),t._m(34),n("p",[t._v("然后我们把我们的container的root切换到/root/containerFS/。")]),t._v(" "),t._m(35),n("p",[t._v("接着执行代码看看效果！")]),t._v(" "),t._m(36),t._m(37),t._v(" "),t._m(38),t._m(39),t._v(" "),t._m(40),t._m(41),t._v(" "),t._m(42),n("p",[t._v("再试试！")]),t._v(" "),t._m(43),n("p",[t._v("成功了！再看看挂载情况:")]),t._v(" "),t._m(44),t._m(45),t._v(" "),t._m(46),t._m(47),t._v(" "),t._m(48),t._v(" "),t._m(49),t._m(50),t._v(" "),n("p",[t._v("如何让我们的新命名空间里的shell和网络交互呢？")])])},a,!1,null,null,null);e.options.__file="namespaces_in_go_mount.md";s.default=e.exports}}]);