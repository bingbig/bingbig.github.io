(window.webpackJsonp=window.webpackJsonp||[]).push([[230],{250:function(t,s,n){"use strict";n.r(s);var a=n(0),e=Object(a.a)({},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),n("p",[t._v("GO成为容器实现的编程语言很大程度上是因为Docker（仍然由Go开发）。Docker是非常成功的开源Go项目之一，它向世界展示了Go的强大。")]),t._v(" "),n("p",[t._v("Docker的开发者之前列举过选择Go来开发Docker的"),n("a",{attrs:{href:"https://www.slideshare.net/jpetazzo/docker-and-go-why-did-we-decide-to-write-docker-in-go",target:"_blank",rel:"noopener noreferrer"}},[t._v("几个理由"),n("OutboundLink")],1),t._v("，包括静态编译，原生的异步支持，底层接口，完整的开发环境和很强的跨交叉编译能力。")]),t._v(" "),n("p",[t._v("对于我个人来说，GO主要是因为简单，容器很复杂！通过使用‘简单’的语言可以更简单的解释容器的复杂原理。Rob Pike在他讨论简洁是Go语言设计的一部分工作时说过一句很有名的话"),n("a",{attrs:{href:"https://www.youtube.com/watch?v=rFejpH_tAHM",target:"_blank",rel:"noopener noreferrer"}},[t._v("“Simplicity is Complicated”"),n("OutboundLink")],1),t._v("。 如果你感兴趣的话，这个视频很值得一看。")]),t._v(" "),t._m(2),t._v(" "),t._m(3),t._v(" "),t._m(4),t._v(" "),n("p",[n("code",[t._v("container")]),t._v("的代码可以在"),n("a",{attrs:{href:"https://github.com/bingbig/container",target:"_blank",rel:"noopener noreferrer"}},[t._v("GitHub"),n("OutboundLink")],1),t._v("上找到。")]),t._v(" "),t._m(5),t._m(6),t._v(" "),t._m(7),t._v(" "),t._m(8),t._v(" "),n("p",[n("a",{attrs:{href:"http://man7.org/linux/man-pages/man7/namespaces.7.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("namespaces(7)"),n("OutboundLink")],1),t._v("的使用文档中写到一共有3个系统调用组成命名空间API：")]),t._v(" "),n("ol",[n("li",[n("a",{attrs:{href:"http://man7.org/linux/man-pages/man2/clone.2.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("clone(2)"),n("OutboundLink")],1),t._v(" - 创建新的进程")]),t._v(" "),n("li",[n("a",{attrs:{href:"http://man7.org/linux/man-pages/man2/setns.2.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("setns(2)"),n("OutboundLink")],1),t._v(" - 允许调用进程加入一个新的存在的命名空间")]),t._v(" "),n("li",[n("a",{attrs:{href:"http://man7.org/linux/man-pages/man2/unshare.2.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("unshare(2)"),n("OutboundLink")],1),t._v(" - 将调用进程移到新的命名空间")])]),t._v(" "),t._m(9),t._v(" "),t._m(10),t._v(" "),t._m(11),t._v(" "),t._m(12),t._v(" "),t._m(13),t._v(" "),t._m(14),n("p",[t._v("进入这个在新的UTS命名空间运行的的shell之后我们来确认一件事情。")]),t._v(" "),t._m(15),t._m(16),t._v(" "),n("p",[t._v("然而这还不够，这一步我们仅仅是为这个进程创建了一个命名空间。我们在加点其他的flags，如下:")]),t._v(" "),t._m(17),t._m(18),t._v(" "),t._m(19),t._v(" "),t._m(20),t._m(21),t._v(" "),t._m(22),n("p",[t._v("再看看系统是不是打开了User命名空间支持"),n("a",{attrs:{href:"https://superuser.com/questions/1294215/is-it-safe-to-enable-user-namespaces-in-centos-7-4-and-how-to-do-it/1294246#1294246",target:"_blank",rel:"noopener noreferrer"}},[t._v("is it safe to enable user namespaces "),n("OutboundLink")],1)]),t._v(" "),t._m(23),n("p",[t._v("成功！"),n("a",{attrs:{href:"https://rhelblog.redhat.com/2015/07/07/whats-next-for-containers-user-namespaces/",target:"_blank",rel:"noopener noreferrer"}},[t._v("更多阅读"),n("OutboundLink")],1),t._v("。")]),t._v(" "),t._m(24),t._v(" "),n("p",[t._v("但是我们的程序还有问题，因为我们缺少了很多初始化和命名空间配置的工作，比如说：")]),t._v(" "),t._m(25),t._v(" "),n("p",[t._v("这意味着我们还有很多要做的改进。")]),t._v(" "),t._m(26),t._v(" "),n("p",[t._v("现在我们知道了如何用GO写一个能在一系列新的命名空间运行的进程了。接下来我么将一步步配置和初始化命名空间。")])])},[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"命名空间go实现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#命名空间go实现","aria-hidden":"true"}},[this._v("#")]),this._v(" 命名空间Go实现")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("在前面，我们通过"),s("code",[this._v("unshare")]),this._v("命名简单的了解了命名空间。用 "),s("code",[this._v("unshare")]),this._v("写一些命名空间的小脚本很好，但是不太适合更加全面和精确的空间，比如说多个容器。在这种情况下使用一个完全支持的编程语言会更加合适。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"let-s-go"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#let-s-go","aria-hidden":"true"}},[this._v("#")]),this._v(" Let's Go")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("这一系列的文章主要是为了帮助理解如何用Go来使用Linux命名空间。为了达成这个目的，我们将编写一个简单的应用"),s("code",[this._v("container")]),this._v("。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[n("code",[t._v("container")]),t._v("一开始会很简单，在一系列命名空间中创建"),n("code",[t._v("/bin/sh")]),t._v("进程，最终我们会创建一个 "),n("code",[t._v("unprivileged")]),t._v(" 的容器。先不要担心 "),n("code",[t._v("unprivileged")]),t._v(" 的含义，我们之后将会慢慢解释。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("# Git repo"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("github"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("bingbig"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("container\n# Git tag"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("1.0")]),t._v("\n# Filename"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" container"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("go")]),t._v("\n# Run"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("go")]),t._v(" build "),n("span",{attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("container run "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("bin"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("sh\n"),n("span",{attrs:{class:"token keyword"}},[t._v("package")]),t._v(" main\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t"),n("span",{attrs:{class:"token string"}},[t._v('"fmt"')]),t._v("\n\t"),n("span",{attrs:{class:"token string"}},[t._v('"os"')]),t._v("\n\t"),n("span",{attrs:{class:"token string"}},[t._v('"os/exec"')]),t._v("\n\t"),n("span",{attrs:{class:"token string"}},[t._v('"syscall"')]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("main")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"run"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\t"),n("span",{attrs:{class:"token function"}},[t._v("run")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("default")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\t"),n("span",{attrs:{class:"token function"}},[t._v("panic")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"pass me an argument please"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("run")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tfmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Printf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"Running %v\\n"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("2")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tcmd "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" exec"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Command")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("2")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("3")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token operator"}},[t._v("...")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\tcmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stdin "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stdin\n\tcmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stdout "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stdout\n\tcmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stderr "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stderr\n\n\tcmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Env "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token builtin"}},[t._v("string")]),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{attrs:{class:"token string"}},[t._v('"PS1=-[container]- # "')]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\tcmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SysProcAttr "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SysProcAttr"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tCloneflags"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWUTS"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v(":=")]),t._v(" cmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Run")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Printf")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"Error running the %s command - %s\\n"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" os"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Args"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tos"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("Exit")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br"),n("span",{staticClass:"line-number"},[t._v("28")]),n("br"),n("span",{staticClass:"line-number"},[t._v("29")]),n("br"),n("span",{staticClass:"line-number"},[t._v("30")]),n("br"),n("span",{staticClass:"line-number"},[t._v("31")]),n("br"),n("span",{staticClass:"line-number"},[t._v("32")]),n("br"),n("span",{staticClass:"line-number"},[t._v("33")]),n("br"),n("span",{staticClass:"line-number"},[t._v("34")]),n("br"),n("span",{staticClass:"line-number"},[t._v("35")]),n("br"),n("span",{staticClass:"line-number"},[t._v("36")]),n("br"),n("span",{staticClass:"line-number"},[t._v("37")]),n("br"),n("span",{staticClass:"line-number"},[t._v("38")]),n("br"),n("span",{staticClass:"line-number"},[t._v("39")]),n("br"),n("span",{staticClass:"line-number"},[t._v("40")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("我们可以看到，这个程序没有什么特别复杂的地方。就是简单的创建一个"),s("code",[this._v("exec.Command")]),this._v("，通过管道联通被调用的进程的stdin/out/err，并且给新的进程设置"),s("code",[this._v("PS1")]),this._v("环境变量（主要是为了在执行程序时区分命名空间）。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("关键的部分是"),s("code",[this._v("cmd.SysProcAttr")]),this._v("，在理解这个之前我们先进一步看看实现命名空间API的系统调用。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"the-namespaces-api"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#the-namespaces-api","aria-hidden":"true"}},[this._v("#")]),this._v(" The namespaces API")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[n("code",[t._v("unshare")]),t._v(" 看起来很前面的文章里写的很相似。在执行"),n("code",[t._v("unshare")]),t._v("命令时会触发这个系统调用。我们这次关注的系统调用是"),n("code",[t._v("clone()")]),t._v("， Go语言中的"),n("code",[t._v("exec.Run()")]),t._v(" 会执行"),n("code",[t._v("clone()")]),t._v("这个系统调用。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[t._v("调用"),n("code",[t._v("clone()")]),t._v("的时候可以传入一个或者多个"),n("code",[t._v("CLONE_*")]),t._v(" flag。每个命名空间都有一个相应的 CLONE flag： "),n("code",[t._v("CLONE_NEWNS")]),t._v(", "),n("code",[t._v("CLONE_NEWUTS")]),t._v(", "),n("code",[t._v("CLONE_NEWIPC")]),t._v(", "),n("code",[t._v("CLONE_NEWPID")]),t._v(", "),n("code",[t._v("CLONE_NEWNET")]),t._v(", "),n("code",[t._v("CLONE_NEWUSER")]),t._v(" and "),n("code",[t._v("CLONE_NEWCGROUP")]),t._v("。新的进程的执行上下文环境就是由这些传入的flag定义的。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("blockquote",[s("p",[this._v("Mount Namespace是第一个实现的Namespace，当初实现时并不是为了实现linux容器，因为也就没有预料到会有新的Namespace出现，所以用了"),s("code",[this._v("CLONE_NEWNS")]),this._v("而不是"),s("code",[this._v("CLONE_NEWMNT")]),this._v("之类的名字。")])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[t._v("在Go语言中，"),n("code",[t._v("SysProcAttr")]),t._v("可以设置"),n("code",[t._v("exec.Command")]),t._v("的属性。通过执行"),n("code",[t._v("Cloneflags")]),t._v("属性，Go会传入相应的"),n("code",[t._v("CLONE_*")]),t._v(" flag给系统调用"),n("code",[t._v("clone()")]),t._v("。这样，我们就可以控制我们的进程在什么样的命名空间里执行了。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("编译和执行这个程序，你会进入一个在新的UTS命名空间运行的 "),s("code",[this._v("/bin/sh")]),this._v(" 。"),s("strong",[this._v("执行这个程序必须有管理员权限！")])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("root@HiBing➜container git:"),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("v1.0"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" go build\nroot@HiBing➜container git:"),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("v1.0"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" ./container run /bin/sh\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("#")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("Running "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("/bin/bash"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("# readlink /proc/self/ns/uts")]),t._v("\nuts:"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("4026532156"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n-"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("- "),n("span",{attrs:{class:"token comment"}},[t._v("# exit")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("exit")]),t._v("\nroot@HiBing➜container readlink /proc/self/ns/uts\nuts:"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("4026531838"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("/proc/self/ns/uts")]),this._v("的内容包括了命名空间的类型（UTS）和命名空间的inode号。事实上我们可以看到"),s("code",[this._v("container")]),this._v("shell里面的命名空间inode号和外面的是不一样的。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("# Git repo"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("github"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("bingbig"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("container\n# Git tag"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("1.1")]),t._v("\n# Filename"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" container"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("go")]),t._v("\n"),n("span",{attrs:{class:"token operator"}},[t._v("...")]),t._v("\ncmd"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SysProcAttr "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SysProcAttr"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tCloneflags"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" syscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWNS "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("\n\t\t\tsyscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWUTS "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("\n\t\t\tsyscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWIPC "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("\n\t\t\tsyscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWPID "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("\n\t\t\tsyscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWNET "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("\n\t\t\tsyscall"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CLONE_NEWUSER"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token operator"}},[t._v("...")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("再次编译和执行这个进程，这次，我们的"),s("code",[this._v("/bin/sh")]),this._v("进程会在一个新的Mount、UTS、IPC、PID、Network和User命名空间运行。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("运行出现问题？")]),this._v("\n我是在CentOS 7.7上运行的这个程序，会出现无效参数的报错。一个个参数尝试发现是"),s("code",[this._v("CLONE_NEWUSER")]),this._v("不支持。通过 "),s("code",[this._v("strace")]),this._v("追踪原因：")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{attrs:{class:"token function"}},[t._v("strace")]),t._v(" -o logf -f unshare -U sh\nunshare: unshare failed: Invalid argument\n$ "),n("span",{attrs:{class:"token function"}},[t._v("grep")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'Invalid argument'")]),t._v(" logf\n31728 unshare"),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CLONE_NEWUSER"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("            "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" -1 EINVAL "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Invalid argument"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n31728 write"),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("2, "),n("span",{attrs:{class:"token string"}},[t._v('"Invalid argument\\n"')]),t._v(", 17"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" 17\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("报错的原因是"),s("code",[this._v("unshare(2)")]),this._v("失败了，查阅文档：")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("liub@HiBing container"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("$ "),n("span",{attrs:{class:"token function"}},[t._v("man")]),t._v(" 2 unshare "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v(" col -b "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("grep")]),t._v(" CLONE_NEWUSER\n在第 2 节中没有关于 unshare 的手册页条目。\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{attrs:{class:"token comment"}},[t._v("# cat /proc/sys/user/max_user_namespaces")]),t._v("\n0\n"),n("span",{attrs:{class:"token comment"}},[t._v("# echo 640 > /proc/sys/user/max_user_namespaces")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("# unshare -U sh")]),t._v("\nsh-4.2$ \n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("blockquote",[s("p",[this._v("当我们创建各种命名空间的时候如果包含了User命名空间，那么User命名空间会被最先创建。User命名空间可以不需要root权限来创建，这就意味着我们可以作为普通用户来执行我们的程序。")])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ul",[n("li",[t._v("新的Mount命名空间（"),n("code",[t._v("CLONE_NEWNS")]),t._v("）还是挂载这宿主机的挂载点和rootfs")]),t._v(" "),n("li",[t._v("新的PID命名空间("),n("code",[t._v("CLONE_NEWPID")]),t._v(")没有挂载新的"),n("code",[t._v("/proc")]),t._v("文件系统")]),t._v(" "),n("li",[t._v("新的Netwrok命名空间（"),n("code",[t._v("CLONE_NEWNET")]),t._v("）没有设置命名空间内部的网络接口")]),t._v(" "),n("li",[t._v("新的User命名无法提供UID/GID映射")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"接下来"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#接下来","aria-hidden":"true"}},[this._v("#")]),this._v(" 接下来")])}],!1,null,null,null);e.options.__file="namespaces_in_go.md";s.default=e.exports}}]);