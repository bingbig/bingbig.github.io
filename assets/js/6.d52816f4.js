(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{236:function(t,s,a){t.exports=a.p+"assets/img/redis_dict.88d0581d.png"},237:function(t,s,a){t.exports=a.p+"assets/img/redis_skiplist.67948baf.png"},238:function(t,s,a){t.exports=a.p+"assets/img/redis_inset.12613d06.png"},239:function(t,s){t.exports="data:image/png;base64,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IAESIAESIIFIAjQUItHwBAmQAAmQAAmQAA0F6gAJkAAJkAAJkEAkARoKkWh4ggRIgARIgARIgIYCdYAESIAESIAESCCSQKaGwr///isvvviinH766fL000/bTP7+++/y2GOPif4v9chM17cTYZzqwuDzzz+XY445Rr7++mubTNrp1yVvYXkJC6vLPXjtfwTwrP3999//BdTjX2+88YZcdNFFMnLkSHn77bfrMYnSKvrzzz8vDzzwgP28//77NTL3yy+/eOddvEWLFtWIV4yAYrdV6C+feOIJGTZsWEGLl6mhMH36dBk/frxcd9118u2339qCTpw4UQYNGmQrvqAlL6PEwzjVJfvvvfee3HnnnYJ0IWmnX5e8heUlLKwu9+C1Ik899ZRsscUWst9++8lff/1V75Gceuqpstdee9nn4vzzz5cePXrIFVdcUe+5lAKAbbfdVmbNmiWHHXaY7LjjjjJnzpxq2VpllVWkU6dOcvnll8ull14qbdq0kRYtWlSLU6yDYrdVzz77rAwZMkQefPDBghYxU0Nh8803l5NOOqlaAY866ijbgFULrOPB3XffXccUsr08jJPL0cKFCwXKkkQOOuggwXV77rmnvSxX+knSTSNuWF7CwtK4V7mkkbb+fvXVV7LxxhtLx44dywVBjXymyeSRRx6Rhg0byk8//SRffPGFTJ48WVZddVU577zzBN43SnICadbPiiuuaD3MTZo0kcWLF1vj9rfffvMy1aBBA0EbcfDBB9tP7969BWFZSLHbKrTlW221lTRu3Ligxc3UUEDJXAH9FduoUaPUKvrll1+Wc889t6AQi5F4GKeqqiprZaNxSyqrrbZatUvC0q8WoYgHYXkJCytiljK7VSH0d9111xV82rZtm1m56nLjtJlMnTpVrrrqKnHtzs4772w7nKVLl8q0adPqktV6eW3a9eMgtm/fXnbbbTeZOXOmDBgwQIwx7pT9btmypTXwqgVmcFDstgpGLj6FlMKaIZrze+65R9ChBQUjmu7duweDaxxj3vC5556TTTbZRA488EB7HpY/5mUgMDBwbrPNNpM//vhDJk2aJJgngosKo4F9993Xxrn11ltlzTXXlH322cdeh6kOjMQxTw/XFhoHvyxYsMC6Z/G9wQYbWIt1/fXX90dJ9XdSTv/8848cfvjhdvTTqlUrW8a+fftatxtcya+88opgigGN35FHHilrrbWWl99ly5bJq6++KiuttJJsueWWXngxfsA19+6779a4FerxiCOOsPmtcbKWAIwA33rrLdtIYFSBBgOChh6NFh6ibbbZxurM7Nmz5ZBDDinKaDqXjsXJG/Iepr+Yf8Vc7IknnijPPPOMfPTRR1b/3fRd06ZN5YADDhB8Y679k08+sWyQVtZSTCbwToIPJFc7MXTo0Bp6t/fee8stt9xSEh1Psess6nlCPubPny/wwJxyyilWr7DGBUYn2iI8Z1E6i2vRli9ZskQ6d+4sd911l9XZb775Bqdy1s96661n46ADhosdbRbaeUwzXHDBBfYc/hSjw8R9krbVuAZSV93//1REfv75Z8EUPQaImD6EweQfaLt4aX4X1gzRnF577bV2vgguGXTmmPdDA7fyyivnLAc6QnTql112mUyYMEHgYkGHB0FHAKU4+uij7WJIpAuBi8p1glBeuA9hRKDBxBzWOuusY+NBmbFoCddBadGA+qdAsDgG85X9+vWTM8880z4Y6HQLKUk5YQHaHnvsYbMEIwDla9asmWBxS4cOHezvs88+23aWMITcPDQ6DXSmO+20U2iHXcgyIm00LJ999pnlDp349ddfbT2+9tprNRrr2vKCRufYY4+VH3/8UdCwo1433HBD24ChM4W+YASC9RiIh5HjzTffLL1797YPW23p1+V8Lh2Lm7cw/UUDu/baawvm1G+88UY555xzBPWMeVqMivFMbL311lbnkX+4JUeNGmV516U8aVxbbCY//PBDrHZi9dVXr1E8dIjgj7UK9UVyPU9ggMEZBnennXaaXH/99XLNNdfIm2++aUf30DFImM5++eWX0qdPHzsge/TRR+W4446zUwkwxOK04zbh//1B+jAS0NZfeOGF8uSTT/pPF+V30rYamUpD95EOBjpo9zHQvuSSS2zbBx6FNhRgjcQWXXgIX0/s+IioDZsXf8yYMfZ6bdC8sI8//tiG3X777V6YKpXR+SijC1hsmHb+RjtzG093R3jxtKMxam0a9SB4YSeccIL58MMPvWNdrGXUQPCOdW7LqGfAaIfqhQ0cONCmrR2JDbvhhhvMDjvs4J1Xz4S5//77vePafsybN8+mp27L2qJ65/Ph9MEHH9j7jBs3zkvn3nvvNfrwme+//96GuTg6svTi6AjUXqcPqhcWVg/eyRw/dIW4UcMkR4zq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"},240:function(t,s){t.exports="data:image/png;base64,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N+rLhM8//7x7/PHHqyhyZWRKt7EyhcI3Pfjgg2WydF3huEFk6qmnLhWYKjLjwTviiCPGuGjBAYytj7zm6c2HVI3yEQgfPQ5bak000URuggkmyL/ASrVT68SzxYfXt956a/fRRx+VivKoLrlFtkzH7r77brfHHnu4J5980vFtOUZEfC0+NJQffvjB3XDDDW7PPfd0DzzwgHvjjTfcQQcd5IJDeOSRRxwjgimmmMJtscUWbqqppnK//vqru/TSS/UL3DRARtN87Zhv1l111VXu999/d5tuuqmbe+65HV+Q5t4TTzyxW2qppRJNfvnlF43LEvObeeaZ3dprr61bKnz55Zfu9ttv1y9Pr7XWWm7BBRdU473++ut6PbxnmWUW3ef7b/B/7bXXHA5jvvnmc1zTLOXpCY9//vlH742eyy23nLvnnnvce++957bccks3zzzz6G1wXhtttJF+IZup8AwzzOA22GADl4ft4MGDFWcuxNkussgibvHFF3e//fabu/POO1Xn1VZbzc0666zKu9V/hE4YSdAGVlhhBbfGGmskrGJ0CpWx9TXXXOM++eQTtefSSy/t5p9/fsW6nt7hWrbff/+9YoYcm2++eYJZuk7Z+2Xp/tJLL7mnnnrK/fnnn2699dZziy22WI2oRW04XREeTzzxhH6Il1kSlO5oR4wYod/VZC0o0KeffqrPwD777OPefvttd9ddd2mb32abbWq+eF9kn8CrU1vuTZvleVh44YXdOuus4yabbLLkdo3wiWmHRW2syM6N8Pvrr78cWPLc9+vXT+2x4YYbuumnnz6Rv+UdPhYcSGKZXhiFw4bba6+91ouz9eKg/e677+6lUXhpfMpDHj4/cuRIf+WVV3r5GKsXJ+3PPfdcv+iii+p5cZBeFPM777yzF6fuxSl6CXl4GTn7t956S+8tX5z34ii9GKtGlosuusjL9F3LqMt1yH3hhRcm9eAnhva33Xabl0brZbHGy6jDi9NP6gR9L7vssqTs+OOPV17SASVl0hN76UT0+MUXX/To1gwV6SlOx4uD1nuKkb30zn6//fbz0047rRcD+++++05v9eqrr3pxjn6aaabx0tA8x0XYoieYbLfddjWiynTQi2P30tnVlBcdgDG80jjJoqDfZZddvKwveHAEW+mYlU2sTlSmrnROXhyPl4fUb7LJJnov6YC9fBFc9czqzXUy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"},241:function(t,s,a){t.exports=a.p+"assets/img/redisdb.01d148af.png"},314:function(t,s,a){"use strict";a.r(s);var n=[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"数据结构和对象"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据结构和对象","aria-hidden":"true"}},[this._v("#")]),this._v(" 数据结构和对象")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"简单动态字符串"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#简单动态字符串","aria-hidden":"true"}},[this._v("#")]),this._v(" 简单动态字符串")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"数据结构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据结构","aria-hidden":"true"}},[this._v("#")]),this._v(" 数据结构")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v('"zmalloc.h"')])]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" s_malloc zmalloc")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" s_realloc zrealloc")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" s_free zfree")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("简单动态字符串具体是在"),a("code",[t._v("sds.c")]),t._v("和"),a("code",[t._v("sds.h")]),t._v("中实现的。在头文件中定义了两种主要的类型，"),a("code",[t._v("sds")]),t._v("和"),a("code",[t._v("sdshdr##T")]),t._v("。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("sds"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v("/* Note: sdshdr5 is never used, we just access the flags byte directly.\n * However is here to document the layout of type 5 SDS strings. */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" __attribute__ "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__packed__"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" sdshdr5 "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* __attribute__ ((__packed__)) 取消字节对齐*/")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" flags"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 3 lsb of type, and 5 msb of string length */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" buf"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" __attribute__ "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__packed__"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" sdshdr8 "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    uint8_t len"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* used */")]),t._v("\n    uint8_t alloc"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* excluding the header and null terminator */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" flags"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 3 lsb of type, 5 unused bits */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" buf"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" __attribute__ "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__packed__"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" sdshdr16 "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    uint16_t len"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* used */")]),t._v("\n    uint16_t alloc"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* excluding the header and null terminator */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" flags"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 3 lsb of type, 5 unused bits */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" buf"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" __attribute__ "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__packed__"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" sdshdr32 "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    uint32_t len"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* used */")]),t._v("\n    uint32_t alloc"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* excluding the header and null terminator */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" flags"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 3 lsb of type, 5 unused bits */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" buf"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" __attribute__ "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__packed__"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" sdshdr64 "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    uint64_t len"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* used */")]),t._v("\n    uint64_t alloc"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* excluding the header and null terminator */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" flags"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 3 lsb of type, 5 unused bits */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" buf"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("作者共定义了五种类型的"),s("code",[this._v("sdshdr")]),this._v("，主要是为了内存的优化，节省内存，毕竟sds是redis中最常用到的数据类型。"),s("code",[this._v("__attribute__ ((__packed__))")]),this._v(" 也是为了告诉编译器取消字节对齐优化。其中"),s("code",[this._v("sdshdr5")]),this._v("还没有使用过。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("整个SDS的内存是一块连续的，统一开辟的。"),a("code",[t._v("sdshdr")]),t._v("结构体后面紧跟着字符串"),a("code",[t._v("sds")]),t._v("。结构体的最后一个成员"),a("code",[t._v("char buf[];")]),t._v("是一个元素个数为0的字符数组，并不占用内存空间，为了指示在结构体后面才是字符串的实体所在。所以在"),a("code",[t._v("sds.h")]),t._v("中就有这么些骚操作：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"sds数据操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sds数据操作","aria-hidden":"true"}},[this._v("#")]),this._v(" SDS数据操作")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ol",[s("li",[this._v("sds和sdshdr")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("// 根据字符串sds拿到sdshdr结构体的指针。")]),t._v("\n"),a("span",{attrs:{class:"token comment"}},[t._v("//    字符串sds减去相应结构体的大小得到结构体")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" SDS_HDR_VAR(T,s) struct sdshdr##T *sh = (void*)((s)-(sizeof(struct sdshdr##T)));")]),t._v("\n"),a("span",{attrs:{class:"token comment"}},[t._v("// 根据字符串sds拿到sdshdr结构体的地址")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" SDS_HDR(T,s) ((struct sdshdr##T *)((s)-(sizeof(struct sdshdr##T))))")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("ol",{attrs:{start:"2"}},[s("li",[this._v("sds和flags")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("inline")]),t._v(" size_t "),a("span",{attrs:{class:"token function"}},[t._v("sdslen")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" sds s"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/*\n     * inline关键字仅仅是建议编译器做内联展开处理，而不是强制。在gcc编译器中，如果编译优化设置为-O0，即使是inline函数也不会被内联展开，\n     * 除非设置了强制内联（__attribute__((always_inline))）属性。\n     * */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" flags "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" s"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("switch")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("flags"),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("SDS_TYPE_MASK"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" SDS_TYPE_5"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("SDS_TYPE_5_LEN")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("flags"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" SDS_TYPE_8"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("SDS_HDR")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("8")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("s"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("len"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" SDS_TYPE_16"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("SDS_HDR")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("16")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("s"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("len"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" SDS_TYPE_32"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("SDS_HDR")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("32")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("s"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("len"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" SDS_TYPE_64"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("SDS_HDR")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("64")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("s"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("len"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("看代码第6行，这就很厉害了，字符串前一个字节就是"),s("code",[this._v("flags")]),this._v("，-1 就拿到了类型的值，进而就知道s(sds)前面的sdshdr的地址。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"创建sds"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建sds","aria-hidden":"true"}},[this._v("#")]),this._v(" 创建SDS")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("sds "),a("span",{attrs:{class:"token function"}},[t._v("sdsnew")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("init"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    size_t initlen "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("strlen")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("sdsnewlen")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" initlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("sds "),a("span",{attrs:{class:"token function"}},[t._v("sdsnewlen")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("init"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" size_t initlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("sh"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    sds s"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" type "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("sdsReqType")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("initlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 根据字符串的长度选择合适的sdshdr类型 */")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* Empty strings are usually created in order to append. Use type 8\n     * since type 5 is not good at this. */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" SDS_TYPE_5 "),a("span",{attrs:{class:"token operator"}},[t._v("&&")]),t._v(" initlen "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" type "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" SDS_TYPE_8"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" hdrlen "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("sdsHdrSize")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("fp"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    sh "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("s_malloc")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hdrlen"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v("initlen"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{attrs:{class:"token comment"}},[t._v("/* sds结构长度+起始字符串长度+末尾空字符（1）*/")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("init"),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v("SDS_NOINIT"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        init "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("!")]),t._v("init"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("memset")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sh"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hdrlen"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v("initlen"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sh "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    s "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("sh"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v("hdrlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 跳到结构体的最后，拿到sds的指针 */")]),t._v("\n    fp "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("s"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 回过头来拿到结构体中flags成员的指针 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("switch")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 初始化结构体成员 */")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" SDS_TYPE_5"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("fp "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" type "),a("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("initlen "),a("span",{attrs:{class:"token operator"}},[t._v("<<")]),t._v(" SDS_TYPE_BITS"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" SDS_TYPE_8"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token function"}},[t._v("SDS_HDR_VAR")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("8")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("s"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            sh"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("len "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" initlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            sh"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("alloc "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" initlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("fp "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" type"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" SDS_TYPE_16"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token function"}},[t._v("SDS_HDR_VAR")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("16")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("s"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            sh"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("len "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" initlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            sh"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("alloc "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" initlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("fp "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" type"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" SDS_TYPE_32"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token function"}},[t._v("SDS_HDR_VAR")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("32")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("s"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            sh"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("len "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" initlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            sh"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("alloc "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" initlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("fp "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" type"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" SDS_TYPE_64"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token function"}},[t._v("SDS_HDR_VAR")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("64")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("s"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            sh"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("len "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" initlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            sh"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("alloc "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" initlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("fp "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" type"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("initlen "),a("span",{attrs:{class:"token operator"}},[t._v("&&")]),t._v(" init"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("memcpy")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" init"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" initlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 把字符串保存到sds中 */")]),t._v("\n    s"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("initlen"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'\\0'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{attrs:{class:"token comment"}},[t._v("/* 加上\\0作为字符串结束符 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" s"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br"),a("span",{staticClass:"line-number"},[t._v("46")]),a("br"),a("span",{staticClass:"line-number"},[t._v("47")]),a("br"),a("span",{staticClass:"line-number"},[t._v("48")]),a("br"),a("span",{staticClass:"line-number"},[t._v("49")]),a("br"),a("span",{staticClass:"line-number"},[t._v("50")]),a("br"),a("span",{staticClass:"line-number"},[t._v("51")]),a("br"),a("span",{staticClass:"line-number"},[t._v("52")]),a("br"),a("span",{staticClass:"line-number"},[t._v("53")]),a("br"),a("span",{staticClass:"line-number"},[t._v("54")]),a("br"),a("span",{staticClass:"line-number"},[t._v("55")]),a("br"),a("span",{staticClass:"line-number"},[t._v("56")]),a("br"),a("span",{staticClass:"line-number"},[t._v("57")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"sds-字符拼接"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sds-字符拼接","aria-hidden":"true"}},[this._v("#")]),this._v(" SDS 字符拼接")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("对字符串进行拼接是常有的操作。"),s("code",[this._v("sdscat")]),this._v("和"),s("code",[this._v("strcat")]),this._v("有很大的区别。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("sdscat")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("sds "),a("span",{attrs:{class:"token function"}},[t._v("sdscat")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sds s"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("t"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("sdscatlen")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" t"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("strlen")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("sdscatlen")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("sds "),a("span",{attrs:{class:"token function"}},[t._v("sdscatlen")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sds s"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("t"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" size_t len"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// 获取当前SDS的长度，sdshdr->len")]),t._v("\n    size_t curlen "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("sdslen")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    s "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("sdsMakeRoomFor")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("len"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// 将目标字符串的内容复制到原SDS后面")]),t._v("\n    "),a("span",{attrs:{class:"token function"}},[t._v("memcpy")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v("curlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" t"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" len"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// 重新设置sds的长度，即更新sdshdr->len")]),t._v("\n    "),a("span",{attrs:{class:"token function"}},[t._v("sdssetlen")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" curlen"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v("len"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// sds后面加上'\\0'")]),t._v("\n    s"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("curlen"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v("len"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'\\0'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" s"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("sdscatlen")]),this._v("函数的核心是"),s("code",[this._v("sdsMakeRoomFor")]),this._v("，它是如何杜绝SDS缓冲区溢出的呢？")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("sds "),a("span",{attrs:{class:"token function"}},[t._v("sdsMakeRoomFor")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sds s"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" size_t addlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("sh"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("newsh"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// 计算SDS剩余缓存大小： sdshdr->alloc - sdshdr->len")]),t._v("\n    size_t avail "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("sdsavail")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    size_t len"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" type"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" oldtype "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" s"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v(" SDS_TYPE_MASK"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" hdrlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* 剩余空间足够addlen长度字符的加入，立即返回 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("avail "),a("span",{attrs:{class:"token operator"}},[t._v(">=")]),t._v(" addlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" s"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// 当前SDS使用了的长度 sdshdr->len")]),t._v("\n    len "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("sdslen")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// 获取SDS的sdshdr结构体的指针")]),t._v("\n    sh "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("s"),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token function"}},[t._v("sdsHdrSize")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldtype"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    newlen "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("len"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v("addlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// SDS_MAX_PREALLOC： 字符串最大的预分配长度是1M")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newlen "),a("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v(" SDS_MAX_PREALLOC"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        newlen "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("2")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n        newlen "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" SDS_MAX_PREALLOC"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// 根据新的sds字符串的长度重新计算sdshdr的类型")]),t._v("\n    type "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("sdsReqType")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* Don't use type 5: the user is appending to the string and type 5 is\n     * not able to remember empty space, so sdsMakeRoomFor() must be called\n     * at every appending operation. */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" SDS_TYPE_5"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" type "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" SDS_TYPE_8"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// sdshdr结构体的长度")]),t._v("\n    hdrlen "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("sdsHdrSize")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// sdshdr类型没有变，对sdshdr realloc扩容即可")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldtype"),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v("type"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        newsh "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("s_realloc")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sh"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hdrlen"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v("newlen"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newsh "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        s "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("newsh"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v("hdrlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token comment"}},[t._v("/* Since the header size changes, need to move the string forward,\n         * and can't use realloc */")]),t._v("\n        "),a("span",{attrs:{class:"token comment"}},[t._v("// sdshdr的类型和大小都变了需要创建一个新的sdshdr")]),t._v("\n        newsh "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("s_malloc")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hdrlen"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v("newlen"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newsh "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token comment"}},[t._v("// 将s复制到新的sdshdr后面的sds中")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("memcpy")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("newsh"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v("hdrlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" len"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token comment"}},[t._v("// 回收旧的sdshdr")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("s_free")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sh"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token comment"}},[t._v("// 新的sds指针")]),t._v("\n        s "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("newsh"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v("hdrlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token comment"}},[t._v("// 设置sdshdr的类别")]),t._v("\n        s"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" type"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token comment"}},[t._v("// 设置新的sdshdr的长度成员, sdshdr->len")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("sdssetlen")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" len"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token function"}},[t._v("sdssetalloc")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newlen"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" s"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br"),a("span",{staticClass:"line-number"},[t._v("46")]),a("br"),a("span",{staticClass:"line-number"},[t._v("47")]),a("br"),a("span",{staticClass:"line-number"},[t._v("48")]),a("br"),a("span",{staticClass:"line-number"},[t._v("49")]),a("br"),a("span",{staticClass:"line-number"},[t._v("50")]),a("br"),a("span",{staticClass:"line-number"},[t._v("51")]),a("br"),a("span",{staticClass:"line-number"},[t._v("52")]),a("br"),a("span",{staticClass:"line-number"},[t._v("53")]),a("br"),a("span",{staticClass:"line-number"},[t._v("54")]),a("br"),a("span",{staticClass:"line-number"},[t._v("55")]),a("br"),a("span",{staticClass:"line-number"},[t._v("56")]),a("br"),a("span",{staticClass:"line-number"},[t._v("57")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("描述"),s("code",[this._v("sdsMakeRoomFor()")]),this._v("，可以简而言之：原SDS剩余空间够用，直接返回；空间不够时，若类型不变直接扩容，若类型变了，则扩容后重新创建一个新的sdshdr，并将原SDS复制到新的sdshdr后的SDS中。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ol",[a("li",[t._v("原SDS剩余空间够用，则不扩容。")]),t._v(" "),a("li",[t._v("当修改后SDS字符串长度小于 "),a("code",[t._v("SDS_MAX_PREALLOC")]),t._v("（1M）时，扩容长度为修改后字符串长度的两倍。")]),t._v(" "),a("li",[t._v("当修改后的SDS字符串长度大于"),a("code",[t._v("SDS_MAX_PREALLOC")]),t._v("时，扩容的长度为修改后字符串长度加上"),a("code",[t._v("SDS_MAX_PREALLOC")]),t._v(",即新的字符长度+1m大小。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("和"),s("code",[this._v("sdsMakeRoomFor()")]),this._v("函数相反，SDS时通过"),s("code",[this._v("sdsRemoveFreeSpace()")]),this._v("函数实现惰性空间释放。其原理于前者类似，sdshdr类型不变时，直接"),s("code",[this._v("realloc")]),this._v("，类型发生了变化时，创建一个新的sdshdr，将sds复制到新的sdshdr后面，回收旧的sdshdr占用的内存。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"sds和c字符串的区别"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sds和c字符串的区别","aria-hidden":"true"}},[this._v("#")]),this._v(" SDS和C字符串的区别")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ol",[a("li",[t._v("常数复杂度获取字符串长度")]),t._v(" "),a("li",[t._v("杜绝缓冲区溢出")]),t._v(" "),a("li",[t._v("减少修改字符串时带来的内存重分配次数")]),t._v(" "),a("li",[t._v("二进制安全")]),t._v(" "),a("li",[t._v("兼容部分C字符串函数，如 "),a("code",[t._v('printf("%s", s->buf);')]),t._v("。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"编译测试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编译测试","aria-hidden":"true"}},[this._v("#")]),this._v(" 编译测试")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("gcc -DSDS_TEST_MAIN -o sds sds.c zmalloc.c\n")])]),this._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[this._v("1")]),s("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"链表"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#链表","aria-hidden":"true"}},[this._v("#")]),this._v(" 链表")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" listNode "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" listNode "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("prev"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" listNode "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("next"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("value"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" listNode"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" listIter "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    listNode "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("next"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" direction"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" listIter"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v("/* 使用list持有链表 */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" list "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// 表头节点")]),t._v("\n    listNode "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("head"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// 表尾节点")]),t._v("\n    listNode "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("tail"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// 链表所包含的节点数量")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" len"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// 节点值复制函数")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("dup"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("ptr"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// 节点值释放函数")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("free"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("ptr"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// 节点值对比函数")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("match"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("ptr"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" list"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("Redis链表的实现和常规的类似，不同的是，"),a("code",[t._v("list")]),t._v("结构体中有定义的三个指针函数成员"),a("code",[t._v("dup")]),t._v(" 、"),a("code",[t._v("free")]),t._v(" 和 "),a("code",[t._v("match")]),t._v("，用于指定实现多态链表所需的类型特定函数。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"redis链表的特点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#redis链表的特点","aria-hidden":"true"}},[this._v("#")]),this._v(" Redis链表的特点")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ol",[a("li",[t._v("双端无环，带表头指针和表尾指针")]),t._v(" "),a("li",[t._v("链表长度获取时间复杂度O(1)")]),t._v(" "),a("li",[t._v("多态，链表节点使用 "),a("code",[t._v("void*")]),t._v(" 指针来保存节点值， 并且可以通过 "),a("code",[t._v("list")]),t._v(" 结构的 "),a("code",[t._v("dup")]),t._v(" 、 "),a("code",[t._v("free")]),t._v(" 、 "),a("code",[t._v("match")]),t._v(" 三个属性为节点值设置类型特定函数， 所以链表可以用于保存各种不同类型的值。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"编译测试-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编译测试-2","aria-hidden":"true"}},[this._v("#")]),this._v(" 编译测试")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"字典"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#字典","aria-hidden":"true"}},[this._v("#")]),this._v(" 字典")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(236),alt:"普通状态下Redis的字典"}})])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" dict "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("           "),a("span",{attrs:{class:"token comment"}},[t._v("/* 字典的结构 */")]),t._v("\n    dictType "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("type"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("             "),a("span",{attrs:{class:"token comment"}},[t._v("/* 类型特定函数 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("privdata"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("             "),a("span",{attrs:{class:"token comment"}},[t._v("/* 私有数据 */")]),t._v("\n    dictht ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("2")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("               "),a("span",{attrs:{class:"token comment"}},[t._v("/* 二元哈希表 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" rehashidx"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("             "),a("span",{attrs:{class:"token comment"}},[t._v("/* rehash索引进度，值为-1时表示没有在进行rehash */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" iterators"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),a("span",{attrs:{class:"token comment"}},[t._v("/* 当前运行的迭代器个数 */")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" dict"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[a("code",[t._v("ht")]),t._v("成员是一个两个元素的数组，数组中的每个项都是一个"),a("code",[t._v("dictht")]),t._v("哈希表，一般情况下，字典使用的是 "),a("code",[t._v("ht[0]")]),t._v(" 哈希表， "),a("code",[t._v("ht[1]")]),t._v(" 哈希表只会在对 "),a("code",[t._v("ht[0]")]),t._v("哈希表进行 "),a("code",[t._v("rehash")]),t._v(" 时使用。"),a("code",[t._v("rehashidx")]),t._v(" 记录着当前字典"),a("code",[t._v("rehash")]),t._v("索引进度，值为-1时表示没有在进行"),a("code",[t._v("rehash")]),t._v("。判断字典是否在"),a("code",[t._v("rehash")]),t._v("的宏定义如下：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{attrs:{class:"token macro property"}},[this._v("#"),s("span",{attrs:{class:"token directive keyword"}},[this._v("define")]),this._v(" dictIsRehashing(d) ((d)->rehashidx != -1)")]),this._v("\n")])]),this._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[this._v("1")]),s("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("Redis的哈希表结构体"),s("code",[this._v("dicht")]),this._v("，其结构如下：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" dictht "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("         "),a("span",{attrs:{class:"token comment"}},[t._v("/* 哈希表的结构 */")]),t._v("\n    dictEntry "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("          "),a("span",{attrs:{class:"token comment"}},[t._v("/* 哈希表键值对指针数组 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" size"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("         "),a("span",{attrs:{class:"token comment"}},[t._v("/* 哈希表的大小 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" sizemask"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("     "),a("span",{attrs:{class:"token comment"}},[t._v("/* 哈希表大小掩码，用于计算索引值，总是等于size-1*/")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" used"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("         "),a("span",{attrs:{class:"token comment"}},[t._v("/* 该哈希表已有的节点（键值对）数目 */")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" dictht"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("起始哈希表大小为"),a("code",[t._v("DICT_HT_INITIAL_SIZE")]),t._v("（4），"),a("code",[t._v("table")]),t._v("成员是"),a("code",[t._v("dictEntry")]),t._v("键值对指针的数组，每个元素都是指向"),a("code",[t._v("dictEntry")]),t._v("的指针。"),a("code",[t._v("sizemask")]),t._v(" 用于计算索引值，总是等于size-1，方便通过hash值与sizemask得到索引。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("h "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictHashKey")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" de"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sizemask"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" dictEntry "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("          "),a("span",{attrs:{class:"token comment"}},[t._v("/* 保存hash表中的键值对 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("                      "),a("span",{attrs:{class:"token comment"}},[t._v("/* 键 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("union")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("                         "),a("span",{attrs:{class:"token comment"}},[t._v("/* 值 */")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("val"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        uint64_t u64"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        int64_t s64"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("double")]),t._v(" d"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" v"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" dictEntry "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("next"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("         "),a("span",{attrs:{class:"token comment"}},[t._v("/* 指向哈希表中哈希值相同的下一个节点，用于解决键冲突问题 */")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" dictEntry"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("看到"),s("code",[this._v("next")]),this._v("成员可以证实上图中Redis使用链地址法解决键冲突的问题。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"rehash"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#rehash","aria-hidden":"true"}},[this._v("#")]),this._v(" Rehash")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"_1-哈希方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-哈希方法","aria-hidden":"true"}},[this._v("#")]),this._v(" 1. 哈希方法")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("uint64_t "),a("span",{attrs:{class:"token function"}},[t._v("dictGenHashFunction")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" len"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nuint64_t "),a("span",{attrs:{class:"token function"}},[t._v("dictGenCaseHashFunction")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("buf"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" len"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"_2-扩容和rehash初始化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-扩容和rehash初始化","aria-hidden":"true"}},[this._v("#")]),this._v(" 2. 扩容和rehash初始化")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("当调用"),a("code",[t._v("dictReplace()")]),t._v(", "),a("code",[t._v("dictAdd()")]),t._v(", "),a("code",[t._v("dictAddOrFind()")]),t._v("为字典添加/更新一个新的"),a("code",[t._v("dictEntry")]),t._v("时，Redis会调用"),a("code",[t._v("dictAddRaw()")]),t._v("。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("dictAddRaw()")]),this._v("方法会调用"),s("code",[this._v("_dictKeyIndex()")]),this._v("找到键值对的存放索引，查找索引位置前会先调用"),s("code",[this._v("_dictExpandIfNeeded()")]),this._v("判断是否需要对哈希表扩容。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("如果字典正在进行rehash，那么就不需要再扩容；如果哈希表是空的，将其扩充到起始大小"),a("code",[t._v("DICT_HT_INITIAL_SIZE")]),t._v("（值为4）；如果"),a("code",[t._v("键值对的数目/哈希表的大小")]),t._v("大于 "),a("code",[t._v("dict_force_resize_ratio")]),t._v("（值为5）时或者键值对的数目大于哈希表的大小并且"),a("code",[t._v("dict_can_resize")]),t._v("值为1时就对哈希表扩容。满足这些要求后调用"),a("code",[t._v("dictExpand()")]),t._v("为rehash做初始化工作。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* Expand the hash table if needed */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("_dictExpandIfNeeded")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* 正在hash中，返回 0 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token function"}},[t._v("dictIsRehashing")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" DICT_OK"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* 如果哈希表是空的，将其扩充到起始大小 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictExpand")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" DICT_HT_INITIAL_SIZE"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v('/* If we reached the 1:1 ratio, and we are allowed to resize the hash\n     * table (global setting) or we should avoid it but the ratio between\n     * elements/buckets is over the "safe" threshold, we resize doubling\n     * the number of buckets.\n     *\n     * 如果比例达到了1:1，并且我们允许调整哈希表的大小或者 键值对的数目/哈希表的大小 超过了\n     * 安全阈值，我们将哈希表的大小调整到键值对数目的两倍\n     * */')]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("used "),a("span",{attrs:{class:"token operator"}},[t._v(">=")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size "),a("span",{attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict_can_resize "),a("span",{attrs:{class:"token operator"}},[t._v("||")]),t._v("\n         d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("used"),a("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size "),a("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" dict_force_resize_ratio"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictExpand")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("used"),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token number"}},[t._v("2")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" DICT_OK"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("dictExpand()")]),this._v("函数做了以下工作：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ol",[a("li",[t._v("计算扩容大小"),a("code",[t._v("realsize")]),t._v("（大于扩容size的最小2"),a("sup",[t._v("n")]),t._v("）;")]),t._v(" "),a("li",[t._v("初始化"),a("code",[t._v("dict")]),t._v("第二个哈希表"),a("code",[t._v("ht[1]")]),t._v("，大小为扩容大小"),a("code",[t._v("realsize")]),t._v("，"),a("code",[t._v("sizemark")]),t._v("为"),a("code",[t._v("realsize-1")]),t._v("，"),a("code",[t._v("used")]),t._v(" 为 0；")]),t._v(" "),a("li",[t._v("将"),a("code",[t._v("dict")]),t._v("的"),a("code",[t._v("rehashidx")]),t._v("设置为"),a("code",[t._v("0")]),t._v("。")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* Expand or create the hash table\n * 对已有hash表扩容或者创建一个新的hash表ht[1] */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictExpand")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" size"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* the size is invalid if it is smaller than the number of\n     * elements already inside the hash table \n     * 如果正在reharsh，或者size小于元素（键值对）的个数，那么是无效的\n     */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token function"}},[t._v("dictIsRehashing")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("||")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("used "),a("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" size"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" DICT_ERR"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 返回的是1 */")]),t._v("\n\n    dictht n"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* the new hash table */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" realsize "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("_dictNextPower")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("size"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* Rehashing to the same table size is not useful. */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("realsize "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" DICT_ERR"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* Allocate the new hash table and initialize all pointers to NULL */")]),t._v("\n    n"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" realsize"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    n"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sizemask "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" realsize"),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    n"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("table "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("zcalloc")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("realsize"),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dictEntry"),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    n"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("used "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* Is this the first initialization? If so it's not really a rehashing\n     * we just set the first hash table so that it can accept keys. */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("table "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" n"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" DICT_OK"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* Prepare a second hash table for incremental rehashing */")]),t._v("\n    d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" n"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("rehashidx "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" DICT_OK"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"_3-rehash-方式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-rehash-方式","aria-hidden":"true"}},[this._v("#")]),this._v(" 3. rehash 方式")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("当字典完成初始化工作后才有可能开始rehash，rehash的条件是"),s("code",[this._v("rehashidx")]),this._v("是否为-1。为了防止rehash过程持续太久而导致进程处于block的状态，redis采用的是"),s("strong",[this._v("渐进式的rehash策略")]),this._v("。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ul",[a("li",[t._v("定时执行：调用"),a("code",[t._v("dictRehashMilliseconds()")]),t._v("执行一毫秒的rehash。在redis的"),a("code",[t._v("serverCron")]),t._v("里调用，每次执行1ms的"),a("code",[t._v("dictRehash()")]),t._v("，一般redis运行时用的字典结构会采用这种方法rehash，如"),a("code",[t._v("redisDb")]),t._v("结构体中的"),a("code",[t._v("dict")]),t._v("类型的成员。")]),t._v(" "),a("li",[t._v("被动执行：字典调用"),a("code",[t._v("dictAddRaw()")]),t._v(","),a("code",[t._v("dictGenericDelete()")]),t._v("，"),a("code",[t._v("dicFind()")]),t._v(", "),a("code",[t._v("dictGetSomeKeys()")]),t._v("，"),a("code",[t._v("dictGetRandomKey()")]),t._v("等函数时，会调用"),a("code",[t._v("_dictRehashStep")]),t._v("，迁移buckets中的一个非空bucket（或者跳过100个空的bucket）。")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* Rehash for an amount of time between ms milliseconds and ms+1 milliseconds */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictRehashMilliseconds")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" ms"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" start "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("timeInMilliseconds")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" rehashes "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("while")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token function"}},[t._v("dictRehash")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{attrs:{class:"token number"}},[t._v("100")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        rehashes "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("100")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token function"}},[t._v("timeInMilliseconds")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("start "),a("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" ms"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" rehashes"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v("/* This function performs just a step of rehashing, and only if there are\n * no safe iterators bound to our hash table. When we have iterators in the\n * middle of a rehashing we can't mess with the two hash tables otherwise\n * some element can be missed or duplicated.\n *\n * This function is called by common lookup or update operations in the\n * dictionary so that the hash table automatically migrates from H1 to H2\n * while it is actively used. */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("_dictRehashStep")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("iterators "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictRehash")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"_4-rehash-原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-rehash-原理","aria-hidden":"true"}},[this._v("#")]),this._v(" 4.rehash 原理")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("上面两种rehash方式都会调用"),s("code",[this._v("dictRehash()")]),this._v("执行rehash，先上代码！")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* Performs N steps of incremental rehashing. Returns 1 if there are still\n * keys to move from the old to the new hash table, otherwise 0 is returned.\n *\n * Note that a rehashing step consists in moving a bucket (that may have more\n * than one key as we use chaining) from the old to the new hash table, however\n * since part of the hash table may be composed of empty spaces, it is not\n * guaranteed that this function will rehash even a single bucket, since it\n * will visit at max N*10 empty buckets in total, otherwise the amount of\n * work it does would be unbound and the function may block for a long time.\n * */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictRehash")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" n"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* 哈希表中会存在大量的空的 buckets，设置最大的数目。否则不可预期结束时间 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" empty_visits "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" n"),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token number"}},[t._v("10")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* Max number of empty buckets to visit. */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("!")]),a("span",{attrs:{class:"token function"}},[t._v("dictIsRehashing")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("while")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("n"),a("span",{attrs:{class:"token operator"}},[t._v("--")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("&&")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("used "),a("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        dictEntry "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("de"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("nextde"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{attrs:{class:"token comment"}},[t._v("/* Note that rehashidx can't overflow as we are sure there are more\n         * elements because ht[0].used != 0 */")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("assert")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size "),a("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("rehashidx"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("while")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("rehashidx"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 跳过空buckets：如果该table数组该索引是空值，rehashidx加1 */")]),t._v("\n            d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("rehashidx"),a("span",{attrs:{class:"token operator"}},[t._v("++")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("--")]),t._v("empty_visits "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        \n        de "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("rehashidx"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token comment"}},[t._v("/* Move all the keys in this bucket from the old to the new hash HT */")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("while")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("de"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            uint64_t h"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n            nextde "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" de"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("next"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 之前在同一hash index下的其他键值对重新计算index */")]),t._v("\n            "),a("span",{attrs:{class:"token comment"}},[t._v("/* Get the index in the new hash table */")]),t._v("\n            h "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictHashKey")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" de"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sizemask"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            de"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("next "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("h"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("h"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" de"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("used"),a("span",{attrs:{class:"token operator"}},[t._v("--")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("used"),a("span",{attrs:{class:"token operator"}},[t._v("++")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            de "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" nextde"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("rehashidx"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* ht[1]的table中该位置清空值 */")]),t._v("\n        d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("rehashidx"),a("span",{attrs:{class:"token operator"}},[t._v("++")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* Check if we already rehashed the whole table...\n     * 判断是否整个表以前rehash完成，完成后rehashidx设为-1，原始的ht[0]被ht[1]替代，重新初始化ht[1] */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("used "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("zfree")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("_dictReset")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("rehashidx "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* More to rehash... */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br"),a("span",{staticClass:"line-number"},[t._v("46")]),a("br"),a("span",{staticClass:"line-number"},[t._v("47")]),a("br"),a("span",{staticClass:"line-number"},[t._v("48")]),a("br"),a("span",{staticClass:"line-number"},[t._v("49")]),a("br"),a("span",{staticClass:"line-number"},[t._v("50")]),a("br"),a("span",{staticClass:"line-number"},[t._v("51")]),a("br"),a("span",{staticClass:"line-number"},[t._v("52")]),a("br"),a("span",{staticClass:"line-number"},[t._v("53")]),a("br"),a("span",{staticClass:"line-number"},[t._v("54")]),a("br"),a("span",{staticClass:"line-number"},[t._v("55")]),a("br"),a("span",{staticClass:"line-number"},[t._v("56")]),a("br"),a("span",{staticClass:"line-number"},[t._v("57")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("rehash过程包括将一个bucket（有可能包含多个key，这些key以链表的形式存储）从旧的哈希表（ht[0]）移动到新的哈希表(ht[1])中。哈希表中会存在大量的空的 buckets，redis设置了跳过空的bucket的最大的数目，否则不可预期结束时间（参数"),s("code",[this._v("n")]),this._v("表示rehash的非空bucket)。重新hash后，之后hash的键值对会插入到键值对链表的表头。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("当 "),s("code",[this._v("d->ht[0].used == 0")]),this._v(" 时rehash结束，"),s("code",[this._v("rehashidx")]),this._v("重新设置为 -1。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"字典的基本操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#字典的基本操作","aria-hidden":"true"}},[this._v("#")]),this._v(" 字典的基本操作")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"创建字典"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建字典","aria-hidden":"true"}},[this._v("#")]),this._v(" 创建字典")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* Reset a hash table already initialized with ht_init().\n * NOTE: This function should only be called by ht_destroy(). */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("_dictReset")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dictht "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 初始化dictht表结构 */")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    ht"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("table "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ht"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("size "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ht"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("sizemask "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ht"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("used "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v("/* Create a new hash table */")]),t._v("\ndict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("dictCreate")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dictType "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("type"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("privDataPtr"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("d "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("zmalloc")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token function"}},[t._v("_dictInit")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("type"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("privDataPtr"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" d"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v("/* 初始化字典结构体 */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("_dictInit")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dictType "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("type"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("privDataPtr"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token function"}},[t._v("_dictReset")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token function"}},[t._v("_dictReset")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("type "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" type"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("privdata "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" privDataPtr"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("rehashidx "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("iterators "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" DICT_OK"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("dictCreate()")]),this._v("函数创建一个新的字典，并对所有的成员设置了初始值，其中"),s("code",[this._v("ht")]),this._v("的两个元素都设置为"),s("code",[this._v("NULL")]),this._v("。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"插入一个键值对"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#插入一个键值对","aria-hidden":"true"}},[this._v("#")]),this._v(" 插入一个键值对")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("dictAdd()")]),this._v("方法用于插入一个键值对。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* Add an element to the target hash table */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictAdd")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("val"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    dictEntry "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("entry "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictAddRaw")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("!")]),t._v("entry"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" DICT_ERR"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token function"}},[t._v("dictSetVal")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" entry"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" val"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" DICT_OK"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v('/* Low level add or find:\n * This function adds the entry but instead of setting a value returns the\n * dictEntry structure to the user, that will make sure to fill the value\n * field as he wishes.\n *\n * This function is also directly exposed to the user API to be called\n * mainly in order to store non-pointers inside the hash value, example:\n *\n * entry = dictAddRaw(dict,mykey,NULL);\n * if (entry != NULL) dictSetSignedIntegerVal(entry,1000);\n *\n * Return values:\n *\n * If key already exists NULL is returned, and "*existing" is populated\n * with the existing entry if existing is not NULL.\n *\n * If key was added, the hash entry is returned to be manipulated by the caller.\n */')]),t._v("\ndictEntry "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("dictAddRaw")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dictEntry "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("existing"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" index"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    dictEntry "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("entry"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    dictht "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token function"}},[t._v("dictIsRehashing")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("_dictRehashStep")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* Get the index of the new element, or -1 if\n     * the element already exists. */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("index "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("_dictKeyIndex")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictHashKey")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" existing"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* Allocate the memory and store the new entry.\n     * Insert the element in top, with the assumption that in a database\n     * system it is more likely that recently added entries are accessed\n     * more frequently. */")]),t._v("\n    ht "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictIsRehashing")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    entry "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("zmalloc")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("entry"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* 新的键值对插入链表的头部 */")]),t._v("\n    entry"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("next "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" ht"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("index"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ht"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("index"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" entry"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ht"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("used"),a("span",{attrs:{class:"token operator"}},[t._v("++")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* Set the hash entry fields. */")]),t._v("\n    "),a("span",{attrs:{class:"token function"}},[t._v("dictSetKey")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" entry"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" entry"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br"),a("span",{staticClass:"line-number"},[t._v("46")]),a("br"),a("span",{staticClass:"line-number"},[t._v("47")]),a("br"),a("span",{staticClass:"line-number"},[t._v("48")]),a("br"),a("span",{staticClass:"line-number"},[t._v("49")]),a("br"),a("span",{staticClass:"line-number"},[t._v("50")]),a("br"),a("span",{staticClass:"line-number"},[t._v("51")]),a("br"),a("span",{staticClass:"line-number"},[t._v("52")]),a("br"),a("span",{staticClass:"line-number"},[t._v("53")]),a("br"),a("span",{staticClass:"line-number"},[t._v("54")]),a("br"),a("span",{staticClass:"line-number"},[t._v("55")]),a("br"),a("span",{staticClass:"line-number"},[t._v("56")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ol",[a("li",[t._v("如果要插入的字典正在rehash，执行一步rehash（调用"),a("code",[t._v("_dictRehashStep()")]),t._v("）")]),t._v(" "),a("li",[t._v("如果这个key在字典中存在，插入函数"),a("code",[t._v("dictAdd()")]),t._v("直接返回错误"),a("code",[t._v("DICT_ERR")]),t._v("；如果不存在，"),a("code",[t._v("dictAddRaw()")]),t._v("新建一个"),a("code",[t._v("dictEntry")]),t._v("结构体并插入到对应bucket链表的头部，并调用"),a("code",[t._v("dictSetKey()")]),t._v("设置"),a("code",[t._v("dictEntry")]),t._v("的key的值。其中有一个细节，当字典在rehash时，新的键值对插入到"),a("code",[t._v("ht[1].table")]),t._v("中。")]),t._v(" "),a("li",[t._v("如果成功插入了一个新的"),a("code",[t._v("dictEntry")]),t._v("，"),a("code",[t._v("dictAdd()")]),t._v("调用"),a("code",[t._v("dictSetVal()")]),t._v("设置这个键值对的值。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("判断key是否在字典中存在并找到索引是通过"),s("code",[this._v("_dictKeyIndex()")]),this._v("函数实现的：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* Returns the index of a free slot that can be populated with\n * a hash entry for the given 'key'.\n * If the key already exists, -1 is returned\n * and the optional output parameter may be filled.\n *\n * Note that if we are in the process of rehashing the hash table, the\n * index is always returned in the context of the second (new) hash table. */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("_dictKeyIndex")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" uint64_t hash"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dictEntry "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("existing"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" idx"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    dictEntry "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("he"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("existing"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("existing "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 判断existing是否为空指针，如果是则将其指向的值设为NULL */")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* Expand the hash table if needed */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token function"}},[t._v("_dictExpandIfNeeded")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" DICT_ERR"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("table "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" table "),a("span",{attrs:{class:"token operator"}},[t._v("<=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" table"),a("span",{attrs:{class:"token operator"}},[t._v("++")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        idx "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" hash "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sizemask"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 用hash值与掩码进行与操作得出索引值 */")]),t._v("\n        "),a("span",{attrs:{class:"token comment"}},[t._v("/* Search if this slot does not already contain the given key */")]),t._v("\n        he "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("idx"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("   "),a("span",{attrs:{class:"token comment"}},[t._v("/* 当前索引下的dictEntry */")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("while")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("he"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 遍历查找相同key的dictEntry */")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v("he"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("key "),a("span",{attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictCompareKeys")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" he"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("existing"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("existing "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" he"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 如果existing不是空指针，将其指向找到的dictEntry */")]),t._v("\n                "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            he "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" he"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("next"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("!")]),a("span",{attrs:{class:"token function"}},[t._v("dictIsRehashing")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 如果没有在rehashing，则遍历ht[1] */")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" idx"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("existing")]),this._v(" 是一个可选的输出参数，如果key存在，该指针指向找到的键值对"),s("code",[this._v("dictEntry")]),this._v("。查找的逻辑如下：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ol",[a("li",[t._v("在"),a("code",[t._v("ht[0].table")]),t._v("中查找存在该key对应的索引")]),t._v(" "),a("li",[t._v("如果相应的bucket不为空时，遍历的bucket中的"),a("code",[t._v("DictEntry")]),t._v("链表以查找相同key值的"),a("code",[t._v("DictEntry")])]),t._v(" "),a("li",[t._v("如果该字典在rehash中，如果没有找到还需遍历"),a("code",[t._v("ht[1].table")])]),t._v(" "),a("li",[t._v("如果找到了，"),a("code",[t._v("existing")]),t._v("不为"),a("code",[t._v("NULL")]),t._v("时将"),a("code",[t._v("existing")]),t._v("指向找到的"),a("code",[t._v("DictEntry")]),t._v("，并返回索引；没有找到则返回-1")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("设置键值对的key和value的值的方法"),s("code",[this._v("dictSetKey()")]),this._v("和"),s("code",[this._v("dictSetVal()")]),this._v("是宏函数：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" dictSetKey(d, entry, _key_) do { \\\n    if ((d)->type->keyDup) \\\n        (entry)->key = (d)->type->keyDup((d)->privdata, _key_); \\\n    else \\\n        (entry)->key = (_key_); \\\n} while(0)")]),t._v("\n\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" dictSetVal(d, entry, _val_) do { \\\n    if ((d)->type->valDup) \\\n        (entry)->v.val = (d)->type->valDup((d)->privdata, _val_); \\\n    else \\\n        (entry)->v.val = (_val_); \\\n} while(0)")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"删除一个键值对"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#删除一个键值对","aria-hidden":"true"}},[this._v("#")]),this._v(" 删除一个键值对")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* Search and remove an element. This is an helper function for\n * dictDelete() and dictUnlink(), please check the top comment\n * of those functions. */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("static")]),t._v(" dictEntry "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("dictGenericDelete")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" nofree"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    uint64_t h"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" idx"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    dictEntry "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("he"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("prevHe"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" table"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("used "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("&&")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("used "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token function"}},[t._v("dictIsRehashing")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("_dictRehashStep")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    h "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictHashKey")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("table "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" table "),a("span",{attrs:{class:"token operator"}},[t._v("<=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" table"),a("span",{attrs:{class:"token operator"}},[t._v("++")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        idx "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" h "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sizemask"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        he "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("idx"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        prevHe "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("while")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("he"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v("he"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("key "),a("span",{attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictCompareKeys")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" he"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),a("span",{attrs:{class:"token comment"}},[t._v("/* Unlink the element from the list */")]),t._v("\n                "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("prevHe"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                    prevHe"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("next "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" he"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("next"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n                    d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("idx"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" he"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("next"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("!")]),t._v("nofree"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),a("span",{attrs:{class:"token function"}},[t._v("dictFreeKey")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" he"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    "),a("span",{attrs:{class:"token function"}},[t._v("dictFreeVal")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" he"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    "),a("span",{attrs:{class:"token function"}},[t._v("zfree")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("he"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n                d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("used"),a("span",{attrs:{class:"token operator"}},[t._v("--")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" he"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            prevHe "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" he"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            he "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" he"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("next"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("!")]),a("span",{attrs:{class:"token function"}},[t._v("dictIsRehashing")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* not found */")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v("/* Remove an element, returning DICT_OK on success or DICT_ERR if the\n * element was not found. */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictDelete")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictGenericDelete")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("?")]),t._v(" DICT_OK "),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" DICT_ERR"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("删除一个键值对的过程比较简单，就是找到相应的key，将从链表中删除这个"),a("code",[t._v("DictEntry")]),t._v("并调用"),a("code",[t._v("dictFreeKey()")]),t._v("，"),a("code",[t._v("dictFreeVal()")]),t._v("和"),a("code",[t._v("zfree()")]),t._v("回收内存。同时还要对哈希表的"),a("code",[t._v("used")]),t._v("成员执行自减操作。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"修改一个键值对的值"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#修改一个键值对的值","aria-hidden":"true"}},[this._v("#")]),this._v(" 修改一个键值对的值")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("实现了上述操作后，修改一个键值对变得简单的多。调用"),s("code",[this._v("dictAddRaw()")]),this._v("找到相应的"),s("code",[this._v("dictEntry")]),this._v("，设置新的值并回收旧值占用的内存。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* Add or Overwrite:\n * Add an element, discarding the old value if the key already exists.\n * Return 1 if the key was added from scratch, 0 if there was already an\n * element with such key and dictReplace() just performed a value update\n * operation. */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictReplace")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("val"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    dictEntry "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("entry"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("existing"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" auxentry"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* Try to add the element. If the key\n     * does not exists dictAdd will succeed. */")]),t._v("\n    entry "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictAddRaw")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("existing"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("entry"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("dictSetVal")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" entry"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" val"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* Set the new value and free the old one. Note that it is important\n     * to do that in this order, as the value may just be exactly the same\n     * as the previous one. In this context, think to reference counting,\n     * you want to increment (set), and then decrement (free), and not the\n     * reverse. */")]),t._v("\n    auxentry "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("existing"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token function"}},[t._v("dictSetVal")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" existing"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" val"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token function"}},[t._v("dictFreeVal")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("auxentry"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"根据key查找"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#根据key查找","aria-hidden":"true"}},[this._v("#")]),this._v(" 根据key查找")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("根据key查找"),s("code",[this._v("dictEnty")]),this._v("的方法"),s("code",[this._v("dictFind()")]),this._v("类似于前面提到的"),s("code",[this._v("_dictKeyIndex()")]),this._v("。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("dictEntry "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("dictFind")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    dictEntry "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("he"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    uint64_t h"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" idx"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" table"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("used "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("used "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* dict is empty */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token function"}},[t._v("dictIsRehashing")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("_dictRehashStep")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    h "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictHashKey")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("table "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" table "),a("span",{attrs:{class:"token operator"}},[t._v("<=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" table"),a("span",{attrs:{class:"token operator"}},[t._v("++")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        idx "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" h "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sizemask"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        he "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("idx"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("while")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("he"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v("he"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("key "),a("span",{attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictCompareKeys")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" he"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("key"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" he"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            he "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" he"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("next"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("!")]),a("span",{attrs:{class:"token function"}},[t._v("dictIsRehashing")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"迭代器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#迭代器","aria-hidden":"true"}},[this._v("#")]),this._v(" 迭代器")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("当字典中的键值对数量很大时，可能会使用迭代器分配遍历值（"),s("code",[this._v("hscan")]),this._v("或者"),s("code",[this._v("scan")]),this._v("遍历redis中的所有键）。redis字典的迭代器分为两种，一种是safe迭代器另一种是unsafe迭代器，safe迭代器在迭代的过程中用户可以对该dict进行CURD操作，unsafe迭代器在迭代过程中用户只能对该dict执行迭代操作。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("_dictRehashStep")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("iterators "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictRehash")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* A fingerprint is a 64 bit number that represents the state of the dictionary\n * at a given time, it's just a few dict properties xored together.\n * When an unsafe iterator is initialized, we get the dict fingerprint, and check\n * the fingerprint again when the iterator is released.\n * If the two fingerprints are different it means that the user of the iterator\n * performed forbidden operations against the dictionary while iterating. */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictFingerprint")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" integers"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("6")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hash "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" j"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    integers"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    integers"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    integers"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("2")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("used"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    integers"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("3")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    integers"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("4")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    integers"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("5")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("used"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* We hash N integers by summing every successive integer with the integer\n     * hashing of the previous sum. Basically:\n     *\n     * Result = hash(hash(hash(int1)+int2)+int3) ...\n     *\n     * This way the same set of integers in a different order will (likely) hash\n     * to a different number. */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("j "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" j "),a("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("6")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" j"),a("span",{attrs:{class:"token operator"}},[t._v("++")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        hash "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" integers"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("j"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token comment"}},[t._v("/* For the hashing step we use Tomas Wang's 64 bit integer hash. */")]),t._v("\n        hash "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("~")]),t._v("hash"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash "),a("span",{attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("21")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("// hash = (hash << 21) - hash - 1;")]),t._v("\n        hash "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" hash "),a("span",{attrs:{class:"token operator"}},[t._v("^")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash "),a("span",{attrs:{class:"token operator"}},[t._v(">>")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("24")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        hash "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash "),a("span",{attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("3")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash "),a("span",{attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("8")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("// hash * 265")]),t._v("\n        hash "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" hash "),a("span",{attrs:{class:"token operator"}},[t._v("^")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash "),a("span",{attrs:{class:"token operator"}},[t._v(">>")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("14")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        hash "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash "),a("span",{attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("2")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash "),a("span",{attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("4")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("// hash * 21")]),t._v("\n        hash "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" hash "),a("span",{attrs:{class:"token operator"}},[t._v("^")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash "),a("span",{attrs:{class:"token operator"}},[t._v(">>")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("28")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        hash "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" hash "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash "),a("span",{attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("31")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" hash"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h5",{attrs:{id:"dictscan迭代"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#dictscan迭代","aria-hidden":"true"}},[this._v("#")]),this._v(" dictScan迭代")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("safe迭代器和unsafe迭代器的前提都是不能rehash，要通过这两种迭代的方式遍历所有节点会停止该dict的被动rehash，阻止了rehash的正常进行。"),s("code",[this._v("dictScan()")]),this._v("可以在不停止rehash的前提下遍历到所有dictEntry节点，尽管会有非常小的可能性出现重复的键值对。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* dictScan() is used to iterate over the elements of a dictionary.\n *\n * Iterating works the following way:\n *\n * 1) Initially you call the function using a cursor (v) value of 0.\n * 2) The function performs one step of the iteration, and returns the\n *    new cursor value you must use in the next call.\n * 3) When the returned cursor is 0, the iteration is complete.\n *\n * The function guarantees all elements present in the\n * dictionary get returned between the start and end of the iteration.\n * However it is possible some elements get returned multiple times.\n *\n * For every element returned, the callback argument 'fn' is\n * called with 'privdata' as first argument and the dictionary entry\n * 'de' as second argument.\n *\n * HOW IT WORKS.\n *\n * The iteration algorithm was designed by Pieter Noordhuis.\n * The main idea is to increment a cursor starting from the higher order\n * bits. That is, instead of incrementing the cursor normally, the bits\n * of the cursor are reversed, then the cursor is incremented, and finally\n * the bits are reversed again.\n *\n * This strategy is needed because the hash table may be resized between\n * iteration calls.\n *\n * dict.c hash tables are always power of two in size, and they\n * use chaining, so the position of an element in a given table is given\n * by computing the bitwise AND between Hash(key) and SIZE-1\n * (where SIZE-1 is always the mask that is equivalent to taking the rest\n *  of the division between the Hash of the key and SIZE).\n *\n * For example if the current hash table size is 16, the mask is\n * (in binary) 1111. The position of a key in the hash table will always be\n * the last four bits of the hash output, and so forth.\n *\n * WHAT HAPPENS IF THE TABLE CHANGES IN SIZE?\n *\n * If the hash table grows, elements can go anywhere in one multiple of\n * the old bucket: for example let's say we already iterated with\n * a 4 bit cursor 1100 (the mask is 1111 because hash table size = 16).\n *\n * If the hash table will be resized to 64 elements, then the new mask will\n * be 111111. The new buckets you obtain by substituting in ??1100\n * with either 0 or 1 can be targeted only by keys we already visited\n * when scanning the bucket 1100 in the smaller hash table.\n *\n * By iterating the higher bits first, because of the inverted counter, the\n * cursor does not need to restart if the table size gets bigger. It will\n * continue iterating using cursors without '1100' at the end, and also\n * without any other combination of the final 4 bits already explored.\n *\n * Similarly when the table size shrinks over time, for example going from\n * 16 to 8, if a combination of the lower three bits (the mask for size 8\n * is 111) were already completely explored, it would not be visited again\n * because we are sure we tried, for example, both 0111 and 1111 (all the\n * variations of the higher bit) so we don't need to test it again.\n *\n * WAIT... YOU HAVE *TWO* TABLES DURING REHASHING!\n *\n * Yes, this is true, but we always iterate the smaller table first, then\n * we test all the expansions of the current cursor into the larger\n * table. For example if the current cursor is 101 and we also have a\n * larger table of size 16, we also test (0)101 and (1)101 inside the larger\n * table. This reduces the problem back to having only one table, where\n * the larger one, if it exists, is just an expansion of the smaller one.\n *\n * LIMITATIONS\n *\n * This iterator is completely stateless, and this is a huge advantage,\n * including no additional memory used.\n *\n * The disadvantages resulting from this design are:\n *\n * 1) It is possible we return elements more than once. However this is usually\n *    easy to deal with in the application level.\n * 2) The iterator must return multiple elements per call, as it needs to always\n *    return all the keys chained in a given bucket, and all the expansions, so\n *    we are sure we don't miss keys moving during rehashing.\n * 3) The reverse cursor is somewhat hard to understand at first, but this\n *    comment is supposed to help.\n */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("dictScan")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                       "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" v"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                       dictScanFunction "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("fn"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                       dictScanBucketFunction"),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v(" bucketfn"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                       "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("privdata"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    dictht "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("t0"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("t1"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" dictEntry "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("de"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("next"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" m0"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" m1"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token function"}},[t._v("dictSize")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("!")]),a("span",{attrs:{class:"token function"}},[t._v("dictIsRehashing")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        t0 "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        m0 "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" t0"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("sizemask"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{attrs:{class:"token comment"}},[t._v("/* Emit entries at cursor */")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bucketfn"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("bucketfn")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("privdata"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("t0"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("v "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v(" m0"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        de "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" t0"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("v "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v(" m0"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("de"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            next "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" de"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("next"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token function"}},[t._v("fn")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("privdata"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" de"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            de "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" next"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n        "),a("span",{attrs:{class:"token comment"}},[t._v("/* Set unmasked bits so incrementing the reversed cursor\n         * operates on the masked bits */")]),t._v("\n        v "),a("span",{attrs:{class:"token operator"}},[t._v("|")]),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("~")]),t._v("m0"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{attrs:{class:"token comment"}},[t._v("/* Increment the reverse cursor */")]),t._v("\n        v "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("rev")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("v"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        v"),a("span",{attrs:{class:"token operator"}},[t._v("++")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        v "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("rev")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("v"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        t0 "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        t1 "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{attrs:{class:"token comment"}},[t._v("/* Make sure t0 is the smaller and t1 is the bigger table */")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t0"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("size "),a("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" t1"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("size"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            t0 "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            t1 "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("d"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ht"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n        m0 "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" t0"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("sizemask"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        m1 "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" t1"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("sizemask"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{attrs:{class:"token comment"}},[t._v("/* Emit entries at cursor */")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bucketfn"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("bucketfn")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("privdata"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("t0"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("v "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v(" m0"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        de "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" t0"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("v "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v(" m0"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("de"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            next "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" de"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("next"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token function"}},[t._v("fn")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("privdata"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" de"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            de "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" next"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n        "),a("span",{attrs:{class:"token comment"}},[t._v("/* Iterate over indices in larger table that are the expansion\n         * of the index pointed to by the cursor in the smaller table */")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("do")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token comment"}},[t._v("/* Emit entries at cursor */")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bucketfn"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("bucketfn")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("privdata"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("t1"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("v "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v(" m1"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            de "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" t1"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("table"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("v "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v(" m1"),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("de"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                next "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" de"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("next"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),a("span",{attrs:{class:"token function"}},[t._v("fn")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("privdata"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" de"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                de "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" next"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n            "),a("span",{attrs:{class:"token comment"}},[t._v("/* Increment the reverse cursor not covered by the smaller mask.*/")]),t._v("\n            v "),a("span",{attrs:{class:"token operator"}},[t._v("|")]),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("~")]),t._v("m1"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            v "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("rev")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("v"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            v"),a("span",{attrs:{class:"token operator"}},[t._v("++")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            v "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("rev")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("v"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n            "),a("span",{attrs:{class:"token comment"}},[t._v("/* Continue while bits covered by mask difference is non-zero */")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("v "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("m0 "),a("span",{attrs:{class:"token operator"}},[t._v("^")]),t._v(" m1"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" v"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br"),a("span",{staticClass:"line-number"},[t._v("46")]),a("br"),a("span",{staticClass:"line-number"},[t._v("47")]),a("br"),a("span",{staticClass:"line-number"},[t._v("48")]),a("br"),a("span",{staticClass:"line-number"},[t._v("49")]),a("br"),a("span",{staticClass:"line-number"},[t._v("50")]),a("br"),a("span",{staticClass:"line-number"},[t._v("51")]),a("br"),a("span",{staticClass:"line-number"},[t._v("52")]),a("br"),a("span",{staticClass:"line-number"},[t._v("53")]),a("br"),a("span",{staticClass:"line-number"},[t._v("54")]),a("br"),a("span",{staticClass:"line-number"},[t._v("55")]),a("br"),a("span",{staticClass:"line-number"},[t._v("56")]),a("br"),a("span",{staticClass:"line-number"},[t._v("57")]),a("br"),a("span",{staticClass:"line-number"},[t._v("58")]),a("br"),a("span",{staticClass:"line-number"},[t._v("59")]),a("br"),a("span",{staticClass:"line-number"},[t._v("60")]),a("br"),a("span",{staticClass:"line-number"},[t._v("61")]),a("br"),a("span",{staticClass:"line-number"},[t._v("62")]),a("br"),a("span",{staticClass:"line-number"},[t._v("63")]),a("br"),a("span",{staticClass:"line-number"},[t._v("64")]),a("br"),a("span",{staticClass:"line-number"},[t._v("65")]),a("br"),a("span",{staticClass:"line-number"},[t._v("66")]),a("br"),a("span",{staticClass:"line-number"},[t._v("67")]),a("br"),a("span",{staticClass:"line-number"},[t._v("68")]),a("br"),a("span",{staticClass:"line-number"},[t._v("69")]),a("br"),a("span",{staticClass:"line-number"},[t._v("70")]),a("br"),a("span",{staticClass:"line-number"},[t._v("71")]),a("br"),a("span",{staticClass:"line-number"},[t._v("72")]),a("br"),a("span",{staticClass:"line-number"},[t._v("73")]),a("br"),a("span",{staticClass:"line-number"},[t._v("74")]),a("br"),a("span",{staticClass:"line-number"},[t._v("75")]),a("br"),a("span",{staticClass:"line-number"},[t._v("76")]),a("br"),a("span",{staticClass:"line-number"},[t._v("77")]),a("br"),a("span",{staticClass:"line-number"},[t._v("78")]),a("br"),a("span",{staticClass:"line-number"},[t._v("79")]),a("br"),a("span",{staticClass:"line-number"},[t._v("80")]),a("br"),a("span",{staticClass:"line-number"},[t._v("81")]),a("br"),a("span",{staticClass:"line-number"},[t._v("82")]),a("br"),a("span",{staticClass:"line-number"},[t._v("83")]),a("br"),a("span",{staticClass:"line-number"},[t._v("84")]),a("br"),a("span",{staticClass:"line-number"},[t._v("85")]),a("br"),a("span",{staticClass:"line-number"},[t._v("86")]),a("br"),a("span",{staticClass:"line-number"},[t._v("87")]),a("br"),a("span",{staticClass:"line-number"},[t._v("88")]),a("br"),a("span",{staticClass:"line-number"},[t._v("89")]),a("br"),a("span",{staticClass:"line-number"},[t._v("90")]),a("br"),a("span",{staticClass:"line-number"},[t._v("91")]),a("br"),a("span",{staticClass:"line-number"},[t._v("92")]),a("br"),a("span",{staticClass:"line-number"},[t._v("93")]),a("br"),a("span",{staticClass:"line-number"},[t._v("94")]),a("br"),a("span",{staticClass:"line-number"},[t._v("95")]),a("br"),a("span",{staticClass:"line-number"},[t._v("96")]),a("br"),a("span",{staticClass:"line-number"},[t._v("97")]),a("br"),a("span",{staticClass:"line-number"},[t._v("98")]),a("br"),a("span",{staticClass:"line-number"},[t._v("99")]),a("br"),a("span",{staticClass:"line-number"},[t._v("100")]),a("br"),a("span",{staticClass:"line-number"},[t._v("101")]),a("br"),a("span",{staticClass:"line-number"},[t._v("102")]),a("br"),a("span",{staticClass:"line-number"},[t._v("103")]),a("br"),a("span",{staticClass:"line-number"},[t._v("104")]),a("br"),a("span",{staticClass:"line-number"},[t._v("105")]),a("br"),a("span",{staticClass:"line-number"},[t._v("106")]),a("br"),a("span",{staticClass:"line-number"},[t._v("107")]),a("br"),a("span",{staticClass:"line-number"},[t._v("108")]),a("br"),a("span",{staticClass:"line-number"},[t._v("109")]),a("br"),a("span",{staticClass:"line-number"},[t._v("110")]),a("br"),a("span",{staticClass:"line-number"},[t._v("111")]),a("br"),a("span",{staticClass:"line-number"},[t._v("112")]),a("br"),a("span",{staticClass:"line-number"},[t._v("113")]),a("br"),a("span",{staticClass:"line-number"},[t._v("114")]),a("br"),a("span",{staticClass:"line-number"},[t._v("115")]),a("br"),a("span",{staticClass:"line-number"},[t._v("116")]),a("br"),a("span",{staticClass:"line-number"},[t._v("117")]),a("br"),a("span",{staticClass:"line-number"},[t._v("118")]),a("br"),a("span",{staticClass:"line-number"},[t._v("119")]),a("br"),a("span",{staticClass:"line-number"},[t._v("120")]),a("br"),a("span",{staticClass:"line-number"},[t._v("121")]),a("br"),a("span",{staticClass:"line-number"},[t._v("122")]),a("br"),a("span",{staticClass:"line-number"},[t._v("123")]),a("br"),a("span",{staticClass:"line-number"},[t._v("124")]),a("br"),a("span",{staticClass:"line-number"},[t._v("125")]),a("br"),a("span",{staticClass:"line-number"},[t._v("126")]),a("br"),a("span",{staticClass:"line-number"},[t._v("127")]),a("br"),a("span",{staticClass:"line-number"},[t._v("128")]),a("br"),a("span",{staticClass:"line-number"},[t._v("129")]),a("br"),a("span",{staticClass:"line-number"},[t._v("130")]),a("br"),a("span",{staticClass:"line-number"},[t._v("131")]),a("br"),a("span",{staticClass:"line-number"},[t._v("132")]),a("br"),a("span",{staticClass:"line-number"},[t._v("133")]),a("br"),a("span",{staticClass:"line-number"},[t._v("134")]),a("br"),a("span",{staticClass:"line-number"},[t._v("135")]),a("br"),a("span",{staticClass:"line-number"},[t._v("136")]),a("br"),a("span",{staticClass:"line-number"},[t._v("137")]),a("br"),a("span",{staticClass:"line-number"},[t._v("138")]),a("br"),a("span",{staticClass:"line-number"},[t._v("139")]),a("br"),a("span",{staticClass:"line-number"},[t._v("140")]),a("br"),a("span",{staticClass:"line-number"},[t._v("141")]),a("br"),a("span",{staticClass:"line-number"},[t._v("142")]),a("br"),a("span",{staticClass:"line-number"},[t._v("143")]),a("br"),a("span",{staticClass:"line-number"},[t._v("144")]),a("br"),a("span",{staticClass:"line-number"},[t._v("145")]),a("br"),a("span",{staticClass:"line-number"},[t._v("146")]),a("br"),a("span",{staticClass:"line-number"},[t._v("147")]),a("br"),a("span",{staticClass:"line-number"},[t._v("148")]),a("br"),a("span",{staticClass:"line-number"},[t._v("149")]),a("br"),a("span",{staticClass:"line-number"},[t._v("150")]),a("br"),a("span",{staticClass:"line-number"},[t._v("151")]),a("br"),a("span",{staticClass:"line-number"},[t._v("152")]),a("br"),a("span",{staticClass:"line-number"},[t._v("153")]),a("br"),a("span",{staticClass:"line-number"},[t._v("154")]),a("br"),a("span",{staticClass:"line-number"},[t._v("155")]),a("br"),a("span",{staticClass:"line-number"},[t._v("156")]),a("br"),a("span",{staticClass:"line-number"},[t._v("157")]),a("br"),a("span",{staticClass:"line-number"},[t._v("158")]),a("br"),a("span",{staticClass:"line-number"},[t._v("159")]),a("br"),a("span",{staticClass:"line-number"},[t._v("160")]),a("br"),a("span",{staticClass:"line-number"},[t._v("161")]),a("br"),a("span",{staticClass:"line-number"},[t._v("162")]),a("br"),a("span",{staticClass:"line-number"},[t._v("163")]),a("br"),a("span",{staticClass:"line-number"},[t._v("164")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"编译测试-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编译测试-3","aria-hidden":"true"}},[this._v("#")]),this._v(" 编译测试")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("gcc -DDICT_BENCHMARK_MAIN -o dict dict.c sds.c zmalloc.c siphash.c \n")])]),this._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[this._v("1")]),s("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"跳跃表"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#跳跃表","aria-hidden":"true"}},[this._v("#")]),this._v(" 跳跃表")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* ZSETs use a specialized version of Skiplists */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" zskiplistNode "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    sds ele"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("double")]),t._v(" score"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("                           "),a("span",{attrs:{class:"token comment"}},[t._v("/* 分值，跳跃表中的节点按各自的分值从小到大排列 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" zskiplistNode "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("backward"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("         "),a("span",{attrs:{class:"token comment"}},[t._v("/* 后退指针 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" zskiplistLevel "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" zskiplistNode "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("forward"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("      "),a("span",{attrs:{class:"token comment"}},[t._v("/* 前进指针 */")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" span"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("                  "),a("span",{attrs:{class:"token comment"}},[t._v("/* 跨度，前进指针所指向节点和当前节点的距离 */")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" level"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("                              "),a("span",{attrs:{class:"token comment"}},[t._v("/* 层 */")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" zskiplistNode"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" zskiplist "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" zskiplistNode "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("header"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("tail"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 跳跃表的头尾指针 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" length"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("                "),a("span",{attrs:{class:"token comment"}},[t._v("/* 跳跃表的长度 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" level"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("                           "),a("span",{attrs:{class:"token comment"}},[t._v("/* 目前跳跃表内，层数最大的那个节点的层数（表头节点不计算在内）*/")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" zskiplist"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" zset "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("dict"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    zskiplist "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("zsl"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" zset"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("Redis的"),a("code",[t._v("zset")]),t._v("结构体中包含了"),a("code",[t._v("dict")]),t._v("和"),a("code",[t._v("zskiplist")]),t._v("两个成员，字典可以快速的定位一个member是否存在"),a("code",[t._v("zset")]),t._v("中，跳跃表可以快速查得member的排行和分数。结合两者的优势使得性能更优。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(237),alt:"跳跃表"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("最右边是"),s("code",[this._v("zskiplist")]),this._v("结构：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ul",[s("li",[this._v("header ：指向跳跃表的表头节点，表头节点比较特殊，它定义了跳跃表的最大层数，level和legnth的计算都不包含它")]),this._v(" "),s("li",[this._v("tail ：指向跳跃表的表尾节点")]),this._v(" "),s("li",[this._v("level ：记录目前跳跃表内，层数最大的那个节点的层数")]),this._v(" "),s("li",[this._v("length ：记录跳跃表的长度，也即是，跳跃表目前包含节点的数量")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("zskiplist")]),this._v("右边是4个"),s("code",[this._v("zskiplistNode")]),this._v("结构体，每个结构体都包含四个成员：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ul",[s("li",[this._v("层（level）：每个层都带有两个属性：前进指针和跨度。前进指针用于访问位于表尾方向的其他节点，而跨度则记录了前进指针所指向节点和当前节点的距离。")]),this._v(" "),s("li",[this._v("后退（backward）指针：后退指针在程序从表尾向表头遍历时使用。")]),this._v(" "),s("li",[this._v("分值（score）：在跳跃表中，节点按各自所保存的分值从小到大排列。")]),this._v(" "),s("li",[this._v("成员对象（obj）：各个节点中的 o1 、 o2 和 o3 是节点所保存的成员对象。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"整数集合"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#整数集合","aria-hidden":"true"}},[this._v("#")]),this._v(" 整数集合")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" intset "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    uint32_t encoding"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{attrs:{class:"token comment"}},[t._v("/* 编码方式 */")]),t._v("\n    uint32_t length"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),a("span",{attrs:{class:"token comment"}},[t._v("/* 集合包含的元素数目 */")]),t._v("\n    int8_t contents"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{attrs:{class:"token comment"}},[t._v("/* 保存元素的数组。虽然声明为int8_t类型的数组，但实际上并不保存该类型的值，数组类型取决于encoding属性的值 */")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" intset"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("和之前的"),a("code",[t._v("SDSHDR")]),t._v("结构体一样，最后的成员"),a("code",[t._v("contents")]),t._v("的元素个数没有定义。"),a("code",[t._v("encoding")]),t._v("表示编码方式，"),a("code",[t._v("length")]),t._v("表示集合包含的元素数目，"),a("code",[t._v("contents")]),t._v("指向真正的数据所在的地址。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(238),alt:"整数集合"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("上图展示的是一个包含4个整数的集合，集合元素类型是"),s("code",[this._v("int16_t")]),this._v("，"),s("code",[this._v("contents")]),this._v("数组的大小等于"),s("code",[this._v("sizeof(int16_t) * 5 = 16 * 5 = 80")]),this._v("位。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"整数集合的基本操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#整数集合的基本操作","aria-hidden":"true"}},[this._v("#")]),this._v(" 整数集合的基本操作")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("intsetResize()")]),this._v("函数用来对现有的整数集合升级。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* Resize the intset */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("static")]),t._v(" intset "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("intsetResize")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("intset "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("is"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" uint32_t len"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    uint32_t size "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" len"),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("intrev32ifbe")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("encoding"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    is "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("zrealloc")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("intset"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v("size"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/*  realloc函数用于修改一个原先已经分配的内存块的大小，可以使一块内存的扩大或缩小。 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" is"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("升级集合到新的大小时，先计算升级后的"),s("code",[this._v("content")]),this._v("后面的存储空间（编码*元素个数），加上"),s("code",[this._v("intset")]),this._v("结构体的大小作为升级后的整数集合大小。当插入一个大值时，需要将整数集合升级到更大的编码，"),s("code",[this._v("intsetUpgradeAndAdd()")]),this._v("实现了整数集合的插入升级。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* Upgrades the intset to a larger encoding and inserts the given integer. */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("static")]),t._v(" intset "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("intsetUpgradeAndAdd")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("intset "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("is"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" int64_t value"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    uint8_t curenc "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("intrev32ifbe")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("encoding"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    uint8_t newenc "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("_intsetValueEncoding")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" length "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("intrev32ifbe")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("length"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" prepend "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" value "),a("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* First set new encoding and resize */")]),t._v("\n    is"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("encoding "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("intrev32ifbe")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newenc"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    is "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("intsetResize")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{attrs:{class:"token function"}},[t._v("intrev32ifbe")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("length"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("+")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v('/* Upgrade back-to-front so we don\'t overwrite values.\n     * Note that the "prepend" variable is used to make sure we have an empty\n     * space at either the beginning or the end of the intset. */')]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("while")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("length"),a("span",{attrs:{class:"token operator"}},[t._v("--")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* 从后往前写，这样就不会覆盖数据 */")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("_intsetSet")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("length"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v("prepend"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{attrs:{class:"token function"}},[t._v("_intsetGetEncoded")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("length"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("curenc"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* Set the value at the beginning or the end. */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("prepend"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("_intsetSet")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("value"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("_intsetSet")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{attrs:{class:"token function"}},[t._v("intrev32ifbe")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("length"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("value"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    is"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("length "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("intrev32ifbe")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token function"}},[t._v("intrev32ifbe")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("length"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("+")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" is"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[a("code",[t._v("_intsetValueEncoding()")]),t._v("通过将"),a("code",[t._v("value")]),t._v("和"),a("code",[t._v("INT32_MIN")]),t._v(","),a("code",[t._v("INT32_MAX")]),t._v("等比较计算出升级后的编码类型，之后调整集合的大小。调整之后需要对当前存储的数值进行类型转换并重写到相应的内存中，"),a("code",[t._v("_intsetSet()")]),t._v("方法就是用来根据整数集合的编码类型来写值。redis在对整数集合升级时，采取的是从后往前写的策略，这样先重写的数据不会覆盖还未重写的数据。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("从整数集合中删除一个元素比较简单，先判断要删除的元素是不是小于集合类型的最大值，如果是则在整数集合中找到该元素的位置。假设找到要删除的元素的位置是"),a("code",[t._v("pos")]),t._v("，redis要做的是将"),a("code",[t._v("pos+1")]),t._v("及其后面的元素往前移，这样就是覆盖了"),a("code",[t._v("pos")]),t._v("的值，最后对整数集合的大小进行调整"),a("code",[t._v("intsetResize()")]),t._v("。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* Delete integer from intset */")]),t._v("\nintset "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("intsetRemove")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("intset "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("is"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" int64_t value"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("success"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    uint8_t valenc "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("_intsetValueEncoding")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    uint32_t pos"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("success"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("success "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("valenc "),a("span",{attrs:{class:"token operator"}},[t._v("<=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("intrev32ifbe")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("encoding"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("intsetSearch")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("value"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("pos"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        uint32_t len "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("intrev32ifbe")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("length"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{attrs:{class:"token comment"}},[t._v("/* We know we can delete */")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("success"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("success "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{attrs:{class:"token comment"}},[t._v("/* Overwrite value with tail and update length */")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pos "),a("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("len"),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("intsetMoveTail")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("pos"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("pos"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        is "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("intsetResize")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("len"),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        is"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("length "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("intrev32ifbe")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("len"),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" is"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("\n"),a("span",{attrs:{class:"token comment"}},[t._v('/* Search for the position of "value". Return 1 when the value was found and\n * sets "pos" to the position of the value within the intset. Return 0 when\n * the value is not present in the intset and sets "pos" to the position\n * where "value" can be inserted. */')]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("static")]),t._v(" uint8_t "),a("span",{attrs:{class:"token function"}},[t._v("intsetSearch")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("intset "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("is"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" int64_t value"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" uint32_t "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("pos"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" min "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" max "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("intrev32ifbe")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("length"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mid "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    int64_t cur "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* The value can never be found when the set is empty */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token function"}},[t._v("intrev32ifbe")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("length"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pos"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("pos "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token comment"}},[t._v("/* Check for the case where we know we cannot find the value,\n         * but do know the insert position. */")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value "),a("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("_intsetGet")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("max"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pos"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("pos "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("intrev32ifbe")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("length"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value "),a("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("_intsetGet")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pos"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("pos "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("while")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("max "),a("span",{attrs:{class:"token operator"}},[t._v(">=")]),t._v(" min"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        mid "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("min "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("max"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v(">>")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        cur "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("_intsetGet")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("is"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("mid"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value "),a("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" cur"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            min "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" mid"),a("span",{attrs:{class:"token operator"}},[t._v("+")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value "),a("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v(" cur"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            max "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" mid"),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" cur"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pos"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("pos "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" mid"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pos"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("pos "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" min"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"压缩列表"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#压缩列表","aria-hidden":"true"}},[this._v("#")]),this._v(" 压缩列表")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("压缩列表的结构如下：\n"),s("img",{attrs:{src:a(239),alt:"压缩列表的结构"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("节点结构如下：\n"),s("img",{attrs:{src:a(240),alt:"节点结构"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("每一个节点都记录了上一个节点的长度，因此可以通过节点的"),s("code",[this._v("previous_entry_length")]),this._v("属性计算上一个节点的位置。因为这种前后节点的相关性，删除节点和增加节点都会导致连锁更新。连锁更新在最坏情况下需要对压缩列表执行 N 次空间重分配操作， 而每次空间重分配的最坏复杂度为 O(N) ， 所以连锁更新的最坏复杂度为 O(N^2) 。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"对象"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#对象","aria-hidden":"true"}},[this._v("#")]),this._v(" 对象")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("Redis并没有直接使用上述的这几种数据结构来实现它的键值对数据库，而是基于这些数据结构创建了一个对象系统。这个系统包含"),a("code",[t._v("字符串对象")]),t._v("、"),a("code",[t._v("列表对象")]),t._v("、"),a("code",[t._v("哈希对象")]),t._v("、"),a("code",[t._v("集合对象")]),t._v("和"),a("code",[t._v("有序集合对象")]),t._v("这五种类型的对象，每种对象都用到了至少一种我们前面所介绍的数据结构。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("Redis对象的定义是在"),s("code",[this._v("server.h")]),this._v("中的，"),s("code",[this._v("type")]),this._v("为redis的外部数据结构，即我们常用的redis五种数据类型，"),s("code",[this._v("encoding")]),this._v("为redis的内部数据结构实现，包括我们前面讲的数据类型。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" redisObject "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" type"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token number"}},[t._v("4")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("        "),a("span",{attrs:{class:"token comment"}},[t._v("/* 对象的类型 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" encoding"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token number"}},[t._v("4")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),a("span",{attrs:{class:"token comment"}},[t._v("/* 对象的编码，ptr指向对象的底层实现结构，结构由这个属性决定。\n                            * 通过encoding属性来设定对象所使用的编码，而不是特定类型的对象关联一种固定的编码，\n                            * 可以极大的提升redis的灵活性和效率。\n                            * */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" lru"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("LRU_BITS"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("/* LRU time (relative to global lru_clock) or\n                            * LFU data (least significant 8 bits frequency\n                            * and most significant 16 bits access time). */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" refcount"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("          "),a("span",{attrs:{class:"token comment"}},[t._v("/* 引用计数 */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("ptr"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" robj"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("redis使用"),a("code",[t._v("refcount")]),t._v("来实现内存的回收机制。通过跟踪对象的引用计数信息， 在适当的时候自动释放对象并进行内存回收。"),a("code",[t._v("lru")]),t._v("属性记录了对象最后一次被命令程序访问的时间或者是8位的最近访问频率和16位的访问时间。如果服务器打开了 "),a("code",[t._v("maxmemory")]),t._v(" 选项， 并且服务器用于回收内存的算法为 "),a("code",[t._v("volatile-lru")]),t._v(" 或者 "),a("code",[t._v("allkeys-lru")]),t._v(" ， 那么当服务器占用的内存数超过了 "),a("code",[t._v("maxmemory")]),t._v(" 选项所设置的上限值时， 空转时长较高的那部分键会优先被服务器释放， 从而回收内存。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ul",[s("li",[this._v("LRU: least recently used,最近最少使用")]),this._v(" "),s("li",[this._v("LFU: Least Frequently Used,算法根据数据的历史访问频率来淘汰数据，其核心思想是“如果数据过去被访问多次，那么将来被访问的频率也更高”。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"对象的类型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#对象的类型","aria-hidden":"true"}},[this._v("#")]),this._v(" 对象的类型")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* The actual Redis Object */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_STRING 0    ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* String object. */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_LIST 1      ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* List object. */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_SET 2       ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Set object. */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_ZSET 3      ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Sorted set object. */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_HASH 4      ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Hash object. */")]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v('/* The "module" object type is a special one that signals that the object\n * is one directly managed by a Redis module. In this case the value points\n * to a moduleValue struct, which contains the object value (which is only\n * handled by the module itself) and the RedisModuleType struct which lists\n * function pointers in order to serialize, deserialize, AOF-rewrite and\n * free the object.\n *\n * Inside the RDB file, module types are encoded as OBJ_MODULE followed\n * by a 64 bit module type ID, which has a 54 bits module-specific signature\n * in order to dispatch the loading to the right module, plus a 10 bits\n * encoding version. */')]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_MODULE 5    ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Module object. */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_STREAM 6    ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Stream object. */")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"对象的编码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#对象的编码","aria-hidden":"true"}},[this._v("#")]),this._v(" 对象的编码")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* Objects encoding. Some kind of objects like Strings and Hashes can be\n * internally represented in multiple ways. The 'encoding' field of the object\n * is set to one of this fields for this object. */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_ENCODING_RAW 0     ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Raw representation */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_ENCODING_INT 1     ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Encoded as integer */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_ENCODING_HT 2      ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Encoded as hash table */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_ENCODING_ZIPMAP 3  ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Encoded as zipmap */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_ENCODING_LINKEDLIST 4 ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* No longer used: old list encoding. */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_ENCODING_ZIPLIST 5 ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Encoded as ziplist */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_ENCODING_INTSET 6  ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Encoded as intset */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_ENCODING_SKIPLIST 7  ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Encoded as skiplist */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_ENCODING_EMBSTR 8  ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Embedded sds string encoding */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_ENCODING_QUICKLIST 9 ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Encoded as linked list of ziplists */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_ENCODING_STREAM 10 ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Encoded as a radix tree of listpacks */")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("table",[a("thead",[a("tr",[a("th",[t._v("类型")]),t._v(" "),a("th",[t._v("编码")]),t._v(" "),a("th",[t._v("对象")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("REDIS_STRING")]),t._v(" "),a("td",[t._v("REDIS_ENCODING_INT")]),t._v(" "),a("td",[t._v("使用整数值实现的字符串对象")])]),t._v(" "),a("tr",[a("td",[t._v("REDIS_STRING")]),t._v(" "),a("td",[t._v("REDIS_ENCODING_EMBSTR")]),t._v(" "),a("td",[t._v("使用embstr编码的简单动态字符串实现的字符串对象")])]),t._v(" "),a("tr",[a("td",[t._v("REDIS_STRING")]),t._v(" "),a("td",[t._v("REDIS_ENCODING_RAW")]),t._v(" "),a("td",[t._v("使用简单动态字符串实现的字符串对象")])]),t._v(" "),a("tr",[a("td",[t._v("REDIS_LIST")]),t._v(" "),a("td",[t._v("REDIS_ENCODING_ZIPLIST")]),t._v(" "),a("td",[t._v("使用压缩列表实现的列表对象")])]),t._v(" "),a("tr",[a("td",[t._v("REDIS_LIST")]),t._v(" "),a("td",[t._v("REDIS_ENCODING_LINKEDLIST")]),t._v(" "),a("td",[t._v("使用双端链表实现的列表对象")])]),t._v(" "),a("tr",[a("td",[t._v("REDIS_HASH")]),t._v(" "),a("td",[t._v("REDIS_ENCODING_ZIPLIST")]),t._v(" "),a("td",[t._v("使用压缩列表实现的哈希对象")])]),t._v(" "),a("tr",[a("td",[t._v("REDIS_HASH")]),t._v(" "),a("td",[t._v("REDIS_ENCODING_HT")]),t._v(" "),a("td",[t._v("使用字典实现的哈希对象")])]),t._v(" "),a("tr",[a("td",[t._v("REDIS_SET")]),t._v(" "),a("td",[t._v("REDIS_ENCODING_INTSET")]),t._v(" "),a("td",[t._v("使用整数集合实现的集合对象")])]),t._v(" "),a("tr",[a("td",[t._v("REDIS_SET")]),t._v(" "),a("td",[t._v("REDIS_ENCODING_HT")]),t._v(" "),a("td",[t._v("使用字典实现的集合对象")])]),t._v(" "),a("tr",[a("td",[t._v("REDIS_ZSET")]),t._v(" "),a("td",[t._v("REDIS_ENCODING_ZIPLIST")]),t._v(" "),a("td",[t._v("使用压缩列表实现的有序集合对象")])]),t._v(" "),a("tr",[a("td",[t._v("REDIS_ZSET")]),t._v(" "),a("td",[t._v("REDIS_ENCODING_SKIPLIST")]),t._v(" "),a("td",[t._v("使用跳跃表和字典实现的有序集合对象")])])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"创建对象"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建对象","aria-hidden":"true"}},[this._v("#")]),this._v(" 创建对象")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("Redis封装了多种对象创建的方法，基本的创建方法如"),s("code",[this._v("createObject()")]),this._v("。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("robj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("createObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" type"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("ptr"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    robj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("o "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("zmalloc")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("o"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("type "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" type"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("encoding "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" OBJ_ENCODING_RAW"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ptr "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" ptr"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("refcount "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* Set the LRU to the current lruclock (minutes resolution), or\n     * alternatively the LFU counter. */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("server"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("maxmemory_policy "),a("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v(" MAXMEMORY_FLAG_LFU"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("lru "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token function"}},[t._v("LFUGetTimeInMinutes")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("<<")]),a("span",{attrs:{class:"token number"}},[t._v("8")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v(" LFU_INIT_VAL"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("lru "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("LRU_CLOCK")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" o"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("基于"),s("code",[this._v("robj *createObject(int type, void *ptr);")]),this._v("方法可以创建各种类型的redis对象。相关的对象创建接口有：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("robj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("createObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" type"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("ptr"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrobj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("createStringObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("ptr"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" size_t len"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrobj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("createRawStringObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("ptr"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" size_t len"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrobj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("createEmbeddedStringObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("ptr"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" size_t len"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrobj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("createStringObjectFromLongLong")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" value"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrobj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("createStringObjectFromLongLongForValue")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" value"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrobj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("createStringObjectFromLongDouble")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("double")]),t._v(" value"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" humanfriendly"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrobj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("createQuicklistObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrobj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("createZiplistObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrobj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("createSetObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrobj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("createIntsetObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrobj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("createHashObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrobj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("createZsetObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrobj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("createZsetZiplistObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrobj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("createStreamObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrobj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("createModuleObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("moduleType "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("mt"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("value"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* A redis object, that is a type able to hold a string / list / set */")]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v("/* The actual Redis Object */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_STRING 0    ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* String object. */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_LIST 1      ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* List object. */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_SET 2       ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Set object. */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_ZSET 3      ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Sorted set object. */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_HASH 4      ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Hash object. */")]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v('/* The "module" object type is a special one that signals that the object\n * is one directly managed by a Redis module. In this case the value points\n * to a moduleValue struct, which contains the object value (which is only\n * handled by the module itself) and the RedisModuleType struct which lists\n * function pointers in order to serialize, deserialize, AOF-rewrite and\n * free the object.\n *\n * Inside the RDB file, module types are encoded as OBJ_MODULE followed\n * by a 64 bit module type ID, which has a 54 bits module-specific signature\n * in order to dispatch the loading to the right module, plus a 10 bits\n * encoding version. */')]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_MODULE 5    ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Module object. */")]),t._v("\n"),a("span",{attrs:{class:"token macro property"}},[t._v("#"),a("span",{attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" OBJ_STREAM 6    ")]),a("span",{attrs:{class:"token comment"}},[t._v("/* Stream object. */")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ul",[a("li",[a("code",[t._v("noeviction")]),t._v(": 当内存使用超过配置的时候会返回错误，不会回收任何键。默认配置。")]),t._v(" "),a("li",[a("code",[t._v("volatile-lru")]),t._v(": 加入键的时候，如果过限，首先从设置了过期时间的键集合中回收最久没有使用的键")]),t._v(" "),a("li",[a("code",[t._v("allkeys-lru")]),t._v(": 新增键的时候，如果内存过限，首先通过LRU算法回收最久没有使用的键")]),t._v(" "),a("li",[a("code",[t._v("volatile-random")]),t._v(": 加入键的时候如果内存过限，从过期键的集合中随机回收键")]),t._v(" "),a("li",[a("code",[t._v("allkeys-random")]),t._v(": 加入键的时候如果内存过限，从所有键中随机删除")]),t._v(" "),a("li",[a("code",[t._v("volatile-ttl")]),t._v(": 从配置了过期时间的键中回收马上就要过期的键")]),t._v(" "),a("li",[a("code",[t._v("volatile-lfu")]),t._v(": 从所有配置了过期时间的键中回收使用频率最少的键")]),t._v(" "),a("li",[a("code",[t._v("allkeys-lfu")]),t._v(": 从所有键中回收使用频率最少的键")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"引用计数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#引用计数","aria-hidden":"true"}},[this._v("#")]),this._v(" 引用计数")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("当对象的"),a("code",[t._v("refcount")]),t._v("等于1时，如果再次减少其引用次数，redis会回收该对象占用的内存。"),a("code",[t._v("freeStringObject()")]),t._v("，"),a("code",[t._v("freeListObject()")]),t._v("函数都是用来回收对象"),a("code",[t._v("o->ptr")]),t._v("指向的内存，最后通过"),a("code",[t._v("zfree(o)")]),t._v("释放对象结构体自身占用的内存。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("decrRefCount")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("robj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("o"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("refcount "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("switch")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("type"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" OBJ_STRING"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("freeStringObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" OBJ_LIST"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("freeListObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" OBJ_SET"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("freeSetObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" OBJ_ZSET"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("freeZsetObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" OBJ_HASH"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("freeHashObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" OBJ_MODULE"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("freeModuleObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" OBJ_STREAM"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("freeStreamObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("default")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("serverPanic")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v('"Unknown object type"')]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("zfree")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("refcount "),a("span",{attrs:{class:"token operator"}},[t._v("<=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("serverPanic")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v('"decrRefCount against refcount <= 0"')]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("refcount "),a("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" OBJ_SHARED_REFCOUNT"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("refcount"),a("span",{attrs:{class:"token operator"}},[t._v("--")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("共享对象的引用计数次数为"),s("code",[this._v("OBJ_SHARED_REFCOUNT")]),this._v("，其"),s("code",[this._v("refcount")]),this._v("不会被减少，因此共享对象不会被回收。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("// 引用计数减 1")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("incrRefCount")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("robj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("o"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("refcount "),a("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" OBJ_SHARED_REFCOUNT"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("refcount"),a("span",{attrs:{class:"token operator"}},[t._v("++")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{attrs:{class:"token comment"}},[t._v("// 设置共享对象的引用计数")]),t._v("\nrobj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token function"}},[t._v("makeObjectShared")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("robj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("o"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token function"}},[t._v("serverAssert")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("refcount "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("refcount "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" OBJ_SHARED_REFCOUNT"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" o"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"内存回收"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#内存回收","aria-hidden":"true"}},[this._v("#")]),this._v(" 内存回收")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("上面提到了当对一个"),a("code",[t._v("refcount = 1")]),t._v("的对象进行"),a("code",[t._v("decrRefCount()")]),t._v("操作减少引用计数时，Redis会回收该对象占用的内存。根据对象的"),a("code",[t._v("type")]),t._v("属性，redis调用相应的内存回收函数("),a("code",[t._v("freeStringObject()")]),t._v("， "),a("code",[t._v("freeListObject()")]),t._v(", "),a("code",[t._v("freeSetObject()")]),t._v(", "),a("code",[t._v("freeZsetObject()")]),t._v(", "),a("code",[t._v("freeHashObject()")]),t._v(")来回收Redis提供的五种对象所占用的内存。内存回收函数又通过对象的编码属性"),a("code",[t._v("o->encoding")]),t._v("来执行相应的数据结构的内存回收方法。如字典，它的底层有可能时压缩列表编码的，也有可能是哈希表编码的，不同的编码方式，内存回收时的方法也不同。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("freeStringObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("robj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("o"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("encoding "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" OBJ_ENCODING_RAW"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("sdsfree")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ptr"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("freeListObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("robj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("o"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("encoding "),a("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" OBJ_ENCODING_QUICKLIST"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("quicklistRelease")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ptr"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("serverPanic")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v('"Unknown list encoding type"')]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("freeSetObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("robj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("o"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("encoding"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" OBJ_ENCODING_HT"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("dictRelease")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict"),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ptr"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" OBJ_ENCODING_INTSET"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("zfree")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ptr"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("default")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("serverPanic")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v('"Unknown set encoding type"')]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("freeZsetObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("robj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("o"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    zset "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("zs"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("encoding"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" OBJ_ENCODING_SKIPLIST"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        zs "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ptr"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("dictRelease")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("zs"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("dict"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("zslFree")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("zs"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("zsl"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("zfree")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("zs"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" OBJ_ENCODING_ZIPLIST"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("zfree")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ptr"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("default")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("serverPanic")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v('"Unknown sorted set encoding"')]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("freeHashObject")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("robj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("o"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("encoding"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" OBJ_ENCODING_HT"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("dictRelease")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dict"),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ptr"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("case")]),t._v(" OBJ_ENCODING_ZIPLIST"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("zfree")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("o"),a("span",{attrs:{class:"token operator"}},[t._v("->")]),t._v("ptr"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("default")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{attrs:{class:"token function"}},[t._v("serverPanic")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v('"Unknown hash encoding type"')]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br"),a("span",{staticClass:"line-number"},[t._v("46")]),a("br"),a("span",{staticClass:"line-number"},[t._v("47")]),a("br"),a("span",{staticClass:"line-number"},[t._v("48")]),a("br"),a("span",{staticClass:"line-number"},[t._v("49")]),a("br"),a("span",{staticClass:"line-number"},[t._v("50")]),a("br"),a("span",{staticClass:"line-number"},[t._v("51")]),a("br"),a("span",{staticClass:"line-number"},[t._v("52")]),a("br"),a("span",{staticClass:"line-number"},[t._v("53")]),a("br"),a("span",{staticClass:"line-number"},[t._v("54")]),a("br"),a("span",{staticClass:"line-number"},[t._v("55")]),a("br"),a("span",{staticClass:"line-number"},[t._v("56")]),a("br"),a("span",{staticClass:"line-number"},[t._v("57")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("最后通过"),s("code",[this._v("zfree()")]),this._v("回收对象结构体自身占用的内存。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"数据库"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据库","aria-hidden":"true"}},[this._v("#")]),this._v(" 数据库")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("Redis是一个键值对数据库，其中的每个数据库都由"),s("code",[this._v("redisDb")]),this._v("结构体表示。多个数据库通过整型"),s("code",[this._v("id")]),this._v("成员区分。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" redisDb "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("dict"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("                 "),a("span",{attrs:{class:"token comment"}},[t._v("/* 键空间 The keyspace for this DB */")]),t._v("\n    dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("expires"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("              "),a("span",{attrs:{class:"token comment"}},[t._v("/* Timeout of keys with a timeout set */")]),t._v("\n    dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("blocking_keys"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("        "),a("span",{attrs:{class:"token comment"}},[t._v("/* Keys with clients waiting for data (BLPOP)*/")]),t._v("\n    dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("ready_keys"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("           "),a("span",{attrs:{class:"token comment"}},[t._v("/* Blocked keys that received a PUSH */")]),t._v("\n    dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("watched_keys"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("         "),a("span",{attrs:{class:"token comment"}},[t._v("/* WATCHED keys for MULTI/EXEC CAS */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" id"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("                     "),a("span",{attrs:{class:"token comment"}},[t._v("/* Database ID */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" avg_ttl"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("          "),a("span",{attrs:{class:"token comment"}},[t._v("/* Average TTL, just for stats */")]),t._v("\n    list "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("defrag_later"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("         "),a("span",{attrs:{class:"token comment"}},[t._v("/* List of key names to attempt to defrag one by one, gradually. */")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" redisDb"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(241),alt:"redis数据库"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("ul",[s("li",[this._v("键空间就是数据库的键，每一个键都是一个字符串对象")]),this._v(" "),s("li",[this._v("键空间的值是数据库的值，每个值可以是字符串对象、列表对象、哈希表对象、集合对象和有序集合对象在内的任意一种 Redis 对象。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("与数据库操作相关的API大部分都在"),s("code",[this._v("db.c")]),this._v("中实现，主要也是对"),s("code",[this._v("dict")]),this._v("字典方法的封装。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("redis维护了数据库服务的全局状态结构体"),s("code",[this._v("redisServer")]),this._v("，其中的"),s("code",[this._v("db")]),this._v("成员指向的就是"),s("code",[this._v("redisDb")]),this._v("数组。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" redisServer "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("/* General */")]),t._v("\n    pid_t pid"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("                  "),a("span",{attrs:{class:"token comment"}},[t._v("/* Main process pid. */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("configfile"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("           "),a("span",{attrs:{class:"token comment"}},[t._v("/* Absolute config file path, or NULL */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("executable"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("           "),a("span",{attrs:{class:"token comment"}},[t._v("/* Absolute executable file path. */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("exec_argv"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("           "),a("span",{attrs:{class:"token comment"}},[t._v("/* Executable argv vector (copy). */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" dynamic_hz"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("             "),a("span",{attrs:{class:"token comment"}},[t._v("/* Change hz value depending on # of clients. */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" config_hz"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("              "),a("span",{attrs:{class:"token comment"}},[t._v("/* Configured HZ value. May be different than\n                                   the actual 'hz' field value if dynamic-hz\n                                   is enabled. */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" hz"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("                     "),a("span",{attrs:{class:"token comment"}},[t._v("/* serverCron() calls frequency in hertz */")]),t._v("\n    redisDb "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("db"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("                "),a("span",{attrs:{class:"token comment"}},[t._v("/* 数组，保存这服务器所有的数据库 */")]),t._v("\n    dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("commands"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("             "),a("span",{attrs:{class:"token comment"}},[t._v("/* Command table */")]),t._v("\n    dict "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("orig_commands"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("        "),a("span",{attrs:{class:"token comment"}},[t._v("/* Command table before command renaming. */")]),t._v("\n    aeEventLoop "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("el"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("基于多路复用，redis为每个连接上的客户端都维护了一个状态的结构体"),s("code",[this._v("client")]),this._v("。其中的"),s("code",[this._v("db")]),this._v("成员指向的是当前客户端选择了的数据库。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-c line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("br"),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("/* With multiplexing we need to take per-client state.\n * Clients are taken in a linked list. */")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" client "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    uint64_t id"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("            "),a("span",{attrs:{class:"token comment"}},[t._v("/* Client incremental unique ID. */")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("int")]),t._v(" fd"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("                 "),a("span",{attrs:{class:"token comment"}},[t._v("/* Client socket. */")]),t._v("\n    redisDb "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("db"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("            "),a("span",{attrs:{class:"token comment"}},[t._v("/* Pointer to currently SELECTed DB. */")]),t._v("\n    robj "),a("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("name"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("             "),a("span",{attrs:{class:"token comment"}},[t._v("/* As set by CLIENT SETNAME. */")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" client"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考","aria-hidden":"true"}},[this._v("#")]),this._v(" 参考")])}],e=a(0),r=Object(e.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),a("p",[t._v("Redis没有直接使用C里面的字符串，而是构建了一种名为简单动态字符串(Simple dynamic strings, SDS)的抽象类型，并且作为Redis的默认字符串表示。")]),t._v(" "),a("blockquote",[a("p",[t._v("相关源文件： "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/sds.c",target:"_blank",rel:"noopener noreferrer"}},[t._v("sds.c"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/sds.h",target:"_blank",rel:"noopener noreferrer"}},[t._v("sds.h"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/sdsalloc.h",target:"_blank",rel:"noopener noreferrer"}},[t._v("sdsalloc.h"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/zmalloc.c",target:"_blank",rel:"noopener noreferrer"}},[t._v("zmalloc.c"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/zmalloc.h",target:"_blank",rel:"noopener noreferrer"}},[t._v("zmalloc.h"),a("OutboundLink")],1)])]),t._v(" "),t._m(2),t._v(" "),a("p",[a("code",[t._v("sdsalloc.h")]),t._v("很简单，只是引入了SDS的内存管理模块而已（源码如下）。而真正的内存管理是在"),a("code",[t._v("zmalloc.h")]),t._v("和"),a("code",[t._v("zmalloc.c")]),t._v("中定义和实现的，具体实现请看"),a("router-link",{attrs:{to:"./zmalloc.html"}},[t._v("这里")]),t._v("。")],1),t._v(" "),t._m(3),t._m(4),t._v(" "),t._m(5),t._m(6),t._v(" "),t._m(7),t._v(" "),t._m(8),t._v(" "),t._m(9),t._v(" "),t._m(10),t._m(11),t._v(" "),t._m(12),t._m(13),t._v(" "),t._m(14),t._v(" "),a("p",[t._v("先计算C字符串的长度：")]),t._v(" "),t._m(15),a("p",[t._v("根据长度和字符串创建SDS：")]),t._v(" "),t._m(16),a("p",[t._v("就是如此高雅简洁！")]),t._v(" "),t._m(17),t._v(" "),t._m(18),t._v(" "),t._m(19),t._v(" "),t._m(20),t._m(21),t._v(" "),t._m(22),t._m(23),t._v(" "),t._m(24),t._m(25),t._v(" "),a("p",[t._v("关于扩容长度策略：")]),t._v(" "),t._m(26),t._v(" "),t._m(27),t._v(" "),t._m(28),t._v(" "),a("p",[t._v("SDS相对于C字符串有以下优势：")]),t._v(" "),t._m(29),t._v(" "),t._m(30),t._v(" "),a("p",[t._v("Redis SDS可以作为独立的模块使用。编译测试：")]),t._v(" "),t._m(31),t._m(32),t._v(" "),a("p",[t._v("作为一种常用数据结构，C 语言并没有内置这种数据结构，所以 Redis 构建了自己的链表实现。")]),t._v(" "),a("blockquote",[a("p",[t._v("相关源文件： "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/adlist.h",target:"_blank",rel:"noopener noreferrer"}},[t._v("adlist.h"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/adlist.c",target:"_blank",rel:"noopener noreferrer"}},[t._v("adlist.c"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/zmalloc.h",target:"_blank",rel:"noopener noreferrer"}},[t._v("zmalloc.h"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("Redis的链表是一个双向链表，使用list结构持有链表。")]),t._v(" "),t._m(33),t._m(34),t._v(" "),t._m(35),t._v(" "),t._m(36),t._v(" "),t._m(37),t._v(" "),a("p",[t._v("同样，Redis的链表作为Redis的基本数据结构也可以单独作为模块使用。")]),t._v(" "),t._m(38),t._v(" "),a("p",[t._v("Redis的字典使用的哈希表作为底层实现的，一个哈希表里面可以有多个哈希表节点，每个节点保存了字典中的一个键值对。")]),t._v(" "),a("blockquote",[a("p",[t._v("相关源文件： "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/dict.h",target:"_blank",rel:"noopener noreferrer"}},[t._v("dict.h"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/dict.c",target:"_blank",rel:"noopener noreferrer"}},[t._v("dict.c"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/zmalloc.h",target:"_blank",rel:"noopener noreferrer"}},[t._v("zmalloc.h"),a("OutboundLink")],1),t._v(" , "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/fmacros.h",target:"_blank",rel:"noopener noreferrer"}},[t._v("fmacros.h"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/sds.h",target:"_blank",rel:"noopener noreferrer"}},[t._v("sds.c"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/siphash.h",target:"_blank",rel:"noopener noreferrer"}},[t._v("siphash.c"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("如下图展示了一个普通状态下Redis的字典结构：")]),t._v(" "),t._m(39),t._v(" "),t._m(40),t._m(41),t._v(" "),t._m(42),t._m(43),t._v(" "),t._m(44),t._m(45),t._v(" "),t._m(46),a("p",[t._v("键值对结构体如下：")]),t._v(" "),t._m(47),t._m(48),t._v(" "),t._m(49),t._v(" "),t._m(50),t._v(" "),a("p",[t._v("Redis默认使用SipHash作为哈希方法，并封装了两个函数：")]),t._v(" "),t._m(51),t._m(52),t._v(" "),t._m(53),t._v(" "),t._m(54),t._v(" "),t._m(55),t._v(" "),t._m(56),t._m(57),t._v(" "),t._m(58),t._v(" "),t._m(59),t._m(60),t._v(" "),t._m(61),t._v(" "),a("p",[t._v("redis的rehash有两种策略：")]),t._v(" "),t._m(62),t._v(" "),t._m(63),t._m(64),t._v(" "),t._m(65),t._v(" "),t._m(66),t._m(67),t._v(" "),t._m(68),t._v(" "),t._m(69),t._v(" "),t._m(70),t._v(" "),t._m(71),t._m(72),t._v(" "),t._m(73),t._v(" "),t._m(74),t._v(" "),t._m(75),a("p",[t._v("插入一个新的键值对的过程如下：")]),t._v(" "),t._m(76),t._v(" "),t._m(77),t._v(" "),t._m(78),t._m(79),t._v(" "),t._m(80),t._v(" "),t._m(81),t._v(" "),t._m(82),t._m(83),t._v(" "),t._m(84),t._m(85),t._v(" "),t._m(86),t._v(" "),t._m(87),t._v(" "),t._m(88),t._m(89),t._v(" "),t._m(90),t._v(" "),t._m(91),t._m(92),t._v(" "),t._m(93),t._v(" "),a("p",[t._v("当对字典执行safe迭代时会停止rehash操作以免扰乱迭代器的迭代。")]),t._v(" "),t._m(94),a("p",[t._v("unsafe迭代器在执行迭代过程中不允许对字典进行其他操作，通过计算指纹来判断字典是否发生了变化，若不一致，则结束进程。")]),t._v(" "),t._m(95),t._m(96),t._v(" "),t._m(97),t._v(" "),t._m(98),t._m(99),t._v(" "),a("p",[t._v("Redis字典依赖于SDS，可以通过下面的方法编译测试。")]),t._v(" "),t._m(100),t._m(101),t._v(" "),a("p",[t._v("跳跃表（skiplist）是一种有序链表扩展， 通过在每个节点中维持多个指向其他节点的指针， 来达到快速访问节点的目的。跳跃表的原理可以看这篇"),a("a",{attrs:{href:"https://www.cnblogs.com/thrillerz/p/4505550.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("文章"),a("OutboundLink")],1),t._v("。跳跃表支持平均 O(log N) 最坏 O(N) 复杂度的节点查找， 还可以通过顺序性操作来批量处理节点。")]),t._v(" "),a("blockquote",[a("p",[t._v("相关源文件："),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/dict.h",target:"_blank",rel:"noopener noreferrer"}},[t._v("server.h"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/t_zset.c",target:"_blank",rel:"noopener noreferrer"}},[t._v("t_zset.c"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("Redis的跳跃表的结构定义如下：")]),t._v(" "),t._m(102),t._m(103),t._v(" "),a("p",[t._v("示意图如下：")]),t._v(" "),t._m(104),t._v(" "),t._m(105),t._v(" "),t._m(106),t._v(" "),t._m(107),t._v(" "),t._m(108),t._v(" "),t._m(109),t._v(" "),a("p",[t._v("整数集合是redis用来保存整数集合的结构体。")]),t._v(" "),t._m(110),t._m(111),t._v(" "),t._m(112),t._v(" "),t._m(113),t._v(" "),t._m(114),t._v(" "),t._m(115),t._v(" "),t._m(116),t._m(117),t._v(" "),t._m(118),t._m(119),t._v(" "),t._m(120),t._v(" "),t._m(121),a("p",[t._v("整数集合的值是按照从小到大的顺序排列的，因此可以通过二分法来快速查询值的位置。")]),t._v(" "),t._m(122),t._m(123),t._v(" "),a("blockquote",[a("p",[t._v("相关源文件："),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/ziplist.h",target:"_blank",rel:"noopener noreferrer"}},[t._v("ziplist.h"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/ziplist.c",target:"_blank",rel:"noopener noreferrer"}},[t._v("ziplist.c"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/zmalloc.c",target:"_blank",rel:"noopener noreferrer"}},[t._v("zmalloc.c"),a("OutboundLink")],1),t._v(","),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/zmalloc.h",target:"_blank",rel:"noopener noreferrer"}},[t._v("zmalloc.h"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("当一个列表键只包含少量列表项， 并且每个列表项小整数值，或者长度比较短的字符串时，redis会采用压缩列表来作为列表键的底层实现。当一个哈希键只包含少量键值对， 并且每个键值对的键和值是小整数值， 或者长度比较短的字符串时，redis会采用压缩列表来作为哈希键的底层实现。")]),t._v(" "),a("p",[t._v("压缩列表时redis为了节省内存开发的一种顺序编码的列表。它可以同时存储整数或者字符串，因为每次操作都需要对内存进行重新分配，因此实际的复杂度和内存的使用量相关。")]),t._v(" "),t._m(124),t._v(" "),t._m(125),t._v(" "),t._m(126),t._v(" "),t._m(127),t._v(" "),t._m(128),t._v(" "),a("blockquote",[a("p",[t._v("相关源文件: "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/server.h",target:"_blank",rel:"noopener noreferrer"}},[t._v("server.h"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/server.c",target:"_blank",rel:"noopener noreferrer"}},[t._v("server.c"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/object.c",target:"_blank",rel:"noopener noreferrer"}},[t._v("object.c"),a("OutboundLink")],1)])]),t._v(" "),t._m(129),t._v(" "),t._m(130),t._m(131),t._v(" "),t._m(132),t._v(" "),t._m(133),t._v(" "),t._m(134),t._m(135),t._v(" "),t._m(136),a("p",[t._v("每种类型的对象都至少使用了两种不同的编码，如下表所示：")]),t._v(" "),t._m(137),t._v(" "),t._m(138),t._v(" "),t._m(139),t._v(" "),t._m(140),t._m(141),t._v(" "),t._m(142),a("p",[t._v("在redis中，共定义了 5 + 2 种对象类型：")]),t._v(" "),t._m(143),a("p",[a("code",[t._v("OBJ_MODULE")]),t._v("是一种特殊的对象类型，由redis模块管理。"),a("code",[t._v("OBJ_STREAM")]),t._v("类型是redis 5.0的新特性Stream的数据实现，可以查看相关的文档介绍（"),a("a",{attrs:{href:"https://redis.io/topics/streams-intro",target:"_blank",rel:"noopener noreferrer"}},[t._v("Introduction to Redis Streams"),a("OutboundLink")],1),t._v("）。")]),t._v(" "),a("p",[t._v("根据配置，redis可以选择多种内存策略，用户可以选择以下几种策略：")]),t._v(" "),t._m(144),t._v(" "),t._m(145),t._v(" "),t._m(146),t._v(" "),t._m(147),t._m(148),t._v(" "),t._m(149),t._m(150),t._v(" "),t._m(151),t._v(" "),t._m(152),t._m(153),t._v(" "),t._m(154),t._v(" "),t._m(155),t._v(" "),a("blockquote",[a("p",[t._v("相关源文件: "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/server.h",target:"_blank",rel:"noopener noreferrer"}},[t._v("server.h"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/server.c",target:"_blank",rel:"noopener noreferrer"}},[t._v("server.c"),a("OutboundLink")],1),t._v(", "),a("a",{attrs:{href:"https://github.com/antirez/redis/blob/5.0/src/db.c",target:"_blank",rel:"noopener noreferrer"}},[t._v("db.c"),a("OutboundLink")],1)])]),t._v(" "),t._m(156),a("p",[t._v("数据库中的键空间示意图如下：")]),t._v(" "),t._m(157),t._v(" "),a("p",[t._v("键空间和用户用到的数据库是直接对应的：")]),t._v(" "),t._m(158),t._v(" "),t._m(159),t._v(" "),t._m(160),t._v(" "),t._m(161),t._m(162),t._v(" "),t._m(163),t._m(164),t._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"http://redisbook.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Redis 设计与实现"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/thrillerz/p/4505550.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("跳跃表原理"),a("OutboundLink")],1)])])])},n,!1,null,null,null);r.options.__file="structures.md";s.default=r.exports}}]);